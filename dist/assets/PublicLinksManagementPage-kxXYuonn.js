import{c as y,u as $,r,s as w,j as e}from"./index-HcuLVkXM.js";import{l as z,c as M,t as U}from"./archetypeService-ChV8hfRs.js";import{P as D}from"./plus-DDz1DOCh.js";const q=y("Copy",[["rect",{width:"14",height:"14",x:"8",y:"8",rx:"2",ry:"2",key:"17jyea"}],["path",{d:"M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2",key:"zix9uf"}]]),V=y("ToggleLeft",[["rect",{width:"20",height:"12",x:"2",y:"6",rx:"6",ry:"6",key:"f2vt7d"}],["circle",{cx:"8",cy:"12",r:"2",key:"1nvbw3"}]]),X=y("ToggleRight",[["rect",{width:"20",height:"12",x:"2",y:"6",rx:"6",ry:"6",key:"f2vt7d"}],["circle",{cx:"16",cy:"12",r:"2",key:"4ma0v8"}]]),L=()=>typeof crypto<"u"&&"randomUUID"in crypto?crypto.randomUUID().replace(/-/g,"").slice(0,12):Math.random().toString(36).slice(2,12),G=()=>{const{effectiveClinicId:s,user:T}=$(),[g,d]=r.useState([]),[c,_]=r.useState(new Set),[f,b]=r.useState(!0),[j,N]=r.useState(!1),[x,v]=r.useState(L()),[o,E]=r.useState("EXTERNAL"),[p,S]=r.useState([]),[u,m]=r.useState(""),[k,i]=r.useState(null),A=r.useMemo(()=>Object.fromEntries(p.map(t=>[t.id,t.name])),[p]),h=r.useMemo(()=>typeof window>"u"?"":window.location.origin.replace(/\/$/,""),[]),C=r.useCallback(async()=>{if(s){b(!0),i(null);try{const[t,a]=await Promise.all([z(s),w.from("archetype_respondents").select("public_token").eq("clinic_id",s)]);d(t);const l=new Set((a.data||[]).map(n=>n.public_token).filter(n=>!!n));_(l)}catch(t){console.error(t),i("Não foi possível carregar os links.")}finally{b(!1)}}},[s]);r.useEffect(()=>{C()},[C]),r.useEffect(()=>{if(!s)return;(async()=>{const{data:a}=await w.from("clinic_users").select("id, name, email").eq("clinic_id",s).order("name",{ascending:!0});S((a||[]).map(l=>({id:l.id,name:l.name||l.email||"Colaborador",email:l.email||""})))})()},[s]);const I=async()=>{if(s){if(!x.trim()){i("Informe um token válido.");return}if(o==="INTERNAL"&&!u){i("Selecione um colaborador para o link interno.");return}N(!0),i(null);try{const t=await M({clinic_id:s,token:x.trim(),audience_type:o,created_by_user_id:T?.id||null,collaborator_id:o==="INTERNAL"?u:null});d(a=>[t,...a]),v(L()),m("")}catch(t){console.error(t),i("Não foi possível criar o link. Verifique se o token já existe.")}finally{N(!1)}}},R=async t=>{const a=`${h}/public/perfil/${t}`;try{await navigator.clipboard.writeText(a)}catch{}},P=async t=>{try{const a=await U(t.id,!t.is_active);d(l=>l.map(n=>n.id===t.id?a:n))}catch(a){console.error(a),i("Não foi possível atualizar o link.")}};return s?e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-800",children:"Links de Perfil"}),e.jsx("p",{className:"text-gray-500",children:"Crie e gerencie links públicos do teste comportamental."})]}),k&&e.jsx("p",{className:"text-sm text-red-500",children:k}),e.jsxs("div",{className:"bg-white border border-gray-100 rounded-2xl p-4 grid grid-cols-1 md:grid-cols-4 gap-4",children:[e.jsxs("div",{className:"md:col-span-2",children:[e.jsx("label",{className:"text-xs text-gray-500",children:"Token público"}),e.jsx("input",{value:x,onChange:t=>v(t.target.value),className:"mt-1 w-full px-3 py-2 border border-gray-200 rounded-lg"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs text-gray-500",children:"Audiência"}),e.jsxs("select",{value:o,onChange:t=>{const a=t.target.value;E(a),a!=="INTERNAL"&&m("")},className:"mt-1 w-full px-3 py-2 border border-gray-200 rounded-lg bg-white",children:[e.jsx("option",{value:"INTERNAL",children:"Interna"}),e.jsx("option",{value:"EXTERNAL",children:"Externa"})]})]}),o==="INTERNAL"&&e.jsxs("div",{className:"md:col-span-2",children:[e.jsx("label",{className:"text-xs text-gray-500",children:"Colaborador"}),e.jsxs("select",{value:u,onChange:t=>m(t.target.value),className:"mt-1 w-full px-3 py-2 border border-gray-200 rounded-lg bg-white",children:[e.jsx("option",{value:"",children:"Selecione..."}),p.map(t=>e.jsxs("option",{value:t.id,children:[t.name,t.email?` • ${t.email}`:""]},t.id))]})]}),e.jsx("div",{className:"flex items-end",children:e.jsxs("button",{type:"button",onClick:I,disabled:j,className:"w-full inline-flex items-center justify-center gap-2 px-4 py-2 rounded-lg bg-brand-600 text-white font-medium disabled:opacity-50",children:[e.jsx(D,{size:16}),j?"Criando...":"Criar link"]})})]}),e.jsx("div",{className:"bg-white border border-gray-100 rounded-2xl overflow-hidden",children:e.jsx("div",{className:"overflow-auto",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{className:"bg-gray-50 text-gray-500",children:e.jsxs("tr",{children:[e.jsx("th",{className:"text-left px-4 py-3",children:"Token"}),e.jsx("th",{className:"text-left px-4 py-3",children:"Audiência"}),e.jsx("th",{className:"text-left px-4 py-3",children:"Colaborador"}),e.jsx("th",{className:"text-left px-4 py-3",children:"Status"}),e.jsx("th",{className:"text-left px-4 py-3",children:"Link"}),e.jsx("th",{className:"text-left px-4 py-3",children:"Ações"})]})}),e.jsxs("tbody",{className:"divide-y divide-gray-100",children:[g.map(t=>e.jsxs("tr",{children:[e.jsx("td",{className:"px-4 py-3 font-medium text-gray-800",children:t.token}),e.jsx("td",{className:"px-4 py-3",children:t.audience_type==="INTERNAL"?"Interna":"Externa"}),e.jsx("td",{className:"px-4 py-3 text-gray-600",children:t.audience_type==="INTERNAL"&&t.collaborator_id?A[t.collaborator_id]||"Colaborador":"—"}),e.jsx("td",{className:"px-4 py-3",children:e.jsx("span",{className:`px-2 py-1 rounded-full text-xs ${c.has(t.token)?"bg-amber-100 text-amber-700":t.is_active?"bg-emerald-100 text-emerald-700":"bg-gray-100 text-gray-500"}`,children:c.has(t.token)?"Respondido":t.is_active?"Ativo":"Inativo"})}),e.jsx("td",{className:`px-4 py-3 text-xs ${c.has(t.token)?"text-gray-300 line-through":"text-gray-500"}`,children:h?`${h}/public/perfil/${t.token}`:"Link indisponível"}),e.jsx("td",{className:"px-4 py-3 flex items-center gap-2",children:c.has(t.token)?e.jsx("span",{className:"px-2 py-1 rounded-full text-xs bg-gray-100 text-gray-500",children:"Respondido"}):e.jsxs(e.Fragment,{children:[e.jsx("button",{type:"button",onClick:()=>R(t.token),className:"w-9 h-9 rounded-full border border-gray-200 text-gray-500 hover:text-gray-700 hover:border-gray-300 inline-flex items-center justify-center","aria-label":"Copiar link",title:"Copiar link",children:e.jsx(q,{size:16})}),e.jsx("button",{type:"button",onClick:()=>P(t),className:"w-9 h-9 rounded-full border border-gray-200 text-gray-500 hover:text-gray-700 hover:border-gray-300 inline-flex items-center justify-center","aria-label":t.is_active?"Desativar link":"Ativar link",title:t.is_active?"Desativar link":"Ativar link",children:t.is_active?e.jsx(X,{size:16}):e.jsx(V,{size:16})})]})})]},t.id)),!f&&g.length===0&&e.jsx("tr",{children:e.jsx("td",{className:"px-4 py-6 text-center text-gray-400",colSpan:6,children:"Nenhum link criado."})}),f&&e.jsx("tr",{children:e.jsx("td",{className:"px-4 py-6 text-center text-gray-400",colSpan:6,children:"Carregando links..."})})]})]})})})]}):e.jsxs("div",{className:"space-y-2",children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-800",children:"Links de Perfil"}),e.jsx("p",{className:"text-sm text-gray-500",children:"Selecione uma clínica para gerenciar os links."})]})};export{G as default};
