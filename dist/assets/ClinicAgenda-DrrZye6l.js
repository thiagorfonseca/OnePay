import{j as e,u as q,r,C as F}from"./index-HcuLVkXM.js";import{u as V,T as z,F as L,i as W,a as B,b as P,E as H,g as J,h as K,r as Q}from"./service-DqpVUrBa.js";import{u as U}from"./useModalControls-BiWM_r1l.js";import{C as X}from"./clock-1DnlEicU.js";import"./map-pin-D37Fua2K.js";import"./link-DvuaMiAh.js";import"./x-Dm__mln4.js";const Y=({open:n,reason:h,suggestedStart:l,suggestedEnd:f,submitting:i,onChange:g,onSubmit:u,onClose:m})=>{const a=U({isOpen:n,onClose:m});return n?e.jsx("div",{className:"fixed inset-0 bg-black/40 z-50 flex items-start justify-center overflow-y-auto py-8",onClick:a.onBackdropClick,children:e.jsxs("div",{className:"bg-white w-full max-w-xl rounded-2xl p-6 shadow-xl space-y-4",onClick:d=>d.stopPropagation(),children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-800",children:"Solicitar reagendamento"}),e.jsx("button",{type:"button",onClick:m,className:"w-9 h-9 rounded-full bg-gray-100 text-gray-500 flex items-center justify-center",children:"✕"})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700",children:"Motivo *"}),e.jsx("textarea",{value:h,onChange:d=>g({reason:d.target.value}),className:"w-full px-3 py-2 border border-gray-200 rounded-lg min-h-[90px]",placeholder:"Explique o motivo do reagendamento"})]}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium text-gray-700",children:"Sugestão de início (opcional)"}),e.jsx("input",{type:"datetime-local",value:l,onChange:d=>g({suggestedStart:d.target.value}),className:"mt-1 w-full px-3 py-2 border border-gray-200 rounded-lg"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium text-gray-700",children:"Sugestão de fim (opcional)"}),e.jsx("input",{type:"datetime-local",value:f,onChange:d=>g({suggestedEnd:d.target.value}),className:"mt-1 w-full px-3 py-2 border border-gray-200 rounded-lg"})]})]}),e.jsxs("div",{className:"flex items-center justify-end gap-3",children:[e.jsx("button",{type:"button",onClick:m,className:"px-4 py-2 rounded-lg border border-gray-200 text-gray-600",children:"Cancelar"}),e.jsx("button",{type:"button",onClick:u,disabled:i,className:"px-4 py-2 rounded-lg bg-brand-600 text-white disabled:opacity-50",children:i?"Enviando...":"Enviar solicitação"})]})]})}):null},k=n=>new Date(n).toLocaleString("pt-BR",{dateStyle:"short",timeStyle:"short"}),ie=()=>{const{effectiveClinicId:n,clinic:h}=q(),l=r.useRef(null),{toasts:f,push:i,dismiss:g}=V(),[u,m]=r.useState("timeGridWeek"),[a,d]=r.useState(null),[D,w]=r.useState(!0),[x,R]=r.useState([]),[A,p]=r.useState(!1),[b,N]=r.useState(null),[_,y]=r.useState(!1),[o,S]=r.useState({reason:"",suggestedStart:"",suggestedEnd:""}),[I,C]=r.useState(!1),j=async(t,s)=>{if(n){w(!0);try{const c=await J({clinicId:n,rangeStart:t,rangeEnd:s});R(c)}catch(c){i({title:"Erro ao carregar agenda",description:c?.message,variant:"error"})}finally{w(!1)}}};r.useEffect(()=>{a&&j(a.start,a.end)},[a?.start?.toISOString(),a?.end?.toISOString()]);const M=r.useMemo(()=>x.map(t=>{const s=t.status==="cancelled"?"#e5e7eb":t.confirm_status==="confirmed"?"#d1fae5":t.status==="reschedule_requested"?"#fef3c7":"#dbeafe";return{id:t.id,title:t.title,start:t.start_at,end:t.end_at,backgroundColor:s,borderColor:s,textColor:"#111827"}}),[x]),E=r.useMemo(()=>{const t=new Date;return x.filter(s=>new Date(s.start_at)>=t&&s.status!=="cancelled").sort((s,c)=>new Date(s.start_at).getTime()-new Date(c.start_at).getTime()).slice(0,6)},[x]),O=t=>{const s=x.find(c=>c.id===t.event.id);s&&(N(s),p(!0))},G=async()=>{if(!(!b||!n))try{await K(b.id,n),i({title:"Agendamento confirmado.",variant:"success"}),p(!1),a&&await j(a.start,a.end)}catch(t){i({title:"Não foi possível confirmar.",description:t?.message,variant:"error"})}},T=async()=>{if(!(!b||!n)){if(!o.reason.trim()){i({title:"Informe o motivo do reagendamento.",variant:"info"});return}C(!0);try{await Q({eventId:b.id,clinicId:n,reason:o.reason.trim(),suggestedStartAt:o.suggestedStart?new Date(o.suggestedStart).toISOString():null,suggestedEndAt:o.suggestedEnd?new Date(o.suggestedEnd).toISOString():null}),i({title:"Solicitação enviada.",variant:"success"}),y(!1),p(!1),S({reason:"",suggestedStart:"",suggestedEnd:""}),a&&await j(a.start,a.end)}catch(t){i({title:"Não foi possível solicitar reagendamento.",description:t?.message,variant:"error"})}finally{C(!1)}}},$=t=>{d({start:t.start,end:t.end})},v=t=>{m(t),l.current?.getApi().changeView(t)};return n?e.jsxs("div",{className:"space-y-6",children:[e.jsx(z,{items:f,onDismiss:g}),e.jsxs("div",{className:"flex flex-wrap items-center justify-between gap-3",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-800",children:"Agendamento Inteligente"}),e.jsx("p",{className:"text-sm text-gray-500",children:h?.name?`Clínica ${h.name}`:"Agenda da clínica"})]}),e.jsxs("div",{className:"flex flex-wrap gap-2 items-center",children:[e.jsx("button",{type:"button",onClick:()=>l.current?.getApi().today(),className:"px-3 py-2 text-sm border border-gray-200 rounded-lg",children:"Hoje"}),e.jsx("button",{type:"button",onClick:()=>l.current?.getApi().prev(),className:"px-3 py-2 text-sm border border-gray-200 rounded-lg",children:"◀"}),e.jsx("button",{type:"button",onClick:()=>l.current?.getApi().next(),className:"px-3 py-2 text-sm border border-gray-200 rounded-lg",children:"▶"}),e.jsx("button",{type:"button",onClick:()=>v("timeGridDay"),className:`px-3 py-2 text-sm border rounded-lg ${u==="timeGridDay"?"bg-brand-600 text-white border-brand-600":"bg-white text-gray-700 border-gray-200"}`,children:"Dia"}),e.jsx("button",{type:"button",onClick:()=>v("timeGridWeek"),className:`px-3 py-2 text-sm border rounded-lg ${u==="timeGridWeek"?"bg-brand-600 text-white border-brand-600":"bg-white text-gray-700 border-gray-200"}`,children:"Semana"}),e.jsx("button",{type:"button",onClick:()=>v("dayGridMonth"),className:`px-3 py-2 text-sm border rounded-lg ${u==="dayGridMonth"?"bg-brand-600 text-white border-brand-600":"bg-white text-gray-700 border-gray-200"}`,children:"Mês"})]})]}),e.jsxs("div",{className:"grid grid-cols-1 xl:grid-cols-[minmax(0,1fr)_320px] gap-4",children:[e.jsxs("div",{className:"bg-white border border-gray-100 rounded-2xl p-4 shadow-sm",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm text-gray-500 mb-2",children:[e.jsx(F,{size:16})," ",D?"Carregando agenda...":"Agenda da clínica"]}),e.jsx(L,{ref:l,plugins:[W,B,P],initialView:u,height:"auto",selectable:!1,editable:!1,events:M,eventClick:O,datesSet:$,headerToolbar:!1,dayMaxEventRows:!0,nowIndicator:!0})]}),e.jsxs("div",{className:"bg-white border border-gray-100 rounded-2xl p-4 shadow-sm",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm font-semibold text-gray-700 mb-3",children:[e.jsx(X,{size:16})," Próximos agendamentos"]}),E.length===0&&e.jsx("p",{className:"text-sm text-gray-500",children:"Nenhum agendamento futuro encontrado."}),e.jsx("div",{className:"space-y-3",children:E.map(t=>e.jsxs("button",{type:"button",onClick:()=>{N(t),p(!0)},className:"w-full text-left border border-gray-100 rounded-xl px-3 py-3 hover:border-brand-200 hover:bg-brand-50 transition",children:[e.jsx("div",{className:"text-sm font-semibold text-gray-800",children:t.title}),e.jsxs("div",{className:"text-xs text-gray-500",children:[k(t.start_at)," • ",k(t.end_at)]}),e.jsxs("div",{className:"text-xs mt-1 text-gray-400",children:["Status: ",t.confirm_status]})]},t.id))})]})]}),e.jsx(H,{open:A,onClose:()=>p(!1),event:b,clinicView:!0,onConfirm:G,onRequestReschedule:()=>y(!0)}),e.jsx(Y,{open:_,reason:o.reason,suggestedStart:o.suggestedStart,suggestedEnd:o.suggestedEnd,submitting:I,onChange:t=>S(s=>({...s,...t})),onSubmit:T,onClose:()=>y(!1)})]}):e.jsx("div",{className:"text-sm text-gray-500",children:"Selecione uma clínica para visualizar a agenda."})};export{ie as default};
