import{c as te,u as ne,r as f,j as a,W as re,s as x}from"./index-HcuLVkXM.js";import{f as se}from"./utils-C6qNh0Lg.js";import{u as ie}from"./useModalControls-BiWM_r1l.js";import{P as le}from"./plus-DDz1DOCh.js";import{L as oe}from"./loader-2-CJ7EHZdi.js";import{T as ce}from"./trash-2-FGsD9cgR.js";const de=te("PenSquare",[["path",{d:"M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7",key:"1qinfi"}],["path",{d:"M18.5 2.5a2.12 2.12 0 0 1 3 3L12 15l-4 1 1-4Z",key:"w2jsv5"}]]),ge=()=>{const{effectiveClinicId:V}=ne(),u=V||null,[Q,E]=f.useState(!0),[D,M]=f.useState([]),[P,v]=f.useState(!1),[F,z]=f.useState(!1),[N,I]=f.useState(null),H=()=>{v(!1),I(null)},$=ie({isOpen:P,onClose:H}),[l,p]=f.useState({name:"",bank:"",initial_balance:"0,00",current_balance:"0,00"}),g=t=>{if(typeof t=="string"){const o=Number(t.replace(",","."));return isNaN(o)?0:o}const s=Number(t||0);return isNaN(s)?0:s},W=async t=>{if(!u||t.length===0)return t;const[s,o]=await Promise.all([x.from("revenues").select("bank_account_id, valor_liquido, valor_bruto, valor, status, data_competencia, data_recebimento, parcelas, forma_pagamento, recebimento_parcelas").eq("clinic_id",u),x.from("expenses").select("bank_account_id, valor, status").eq("clinic_id",u).eq("status","paid")]),j=s.data||[],_=o.data||[],h=e=>{if(!e)return null;const n=new Date(e);if(!Number.isNaN(n.getTime()))return n;const r=new Date(`${e}T00:00:00`);return Number.isNaN(r.getTime())?null:r},C=(e,n)=>{const r=new Date(e);return r.setDate(r.getDate()+n),r},S=(e,n)=>{const r=new Date(e);let c=0;for(;c<n;){r.setDate(r.getDate()+1);const i=r.getDay();i!==0&&i!==6&&(c+=1)}return r},k=(e,n)=>{const r=new Date(e);return r.setMonth(r.getMonth()+n),r},T=e=>{const n=(e||"").normalize("NFD").replace(/[\u0300-\u036f]/g,"").toUpperCase();return n.includes("CREDITO")?"CREDITO":n.includes("DEBITO")?"DEBITO":n.includes("PIX")?"PIX":n.includes("BOLETO")?"BOLETO":n.includes("CHEQUE")?"CHEQUE":n.includes("TRANSFER")||n.includes("TED")||n.includes("DOC")?"TRANSFERENCIA":n.includes("CONVENIO")?"CONVENIO":n.includes("DINHEIRO")||n.includes("CASH")?"DINHEIRO":"OUTRO"},Z=(e,n)=>{const r=Math.floor(e/n*100)/100,c=Array(n).fill(r),i=r*n,b=Math.round((e-i)*100)/100;return c[c.length-1]=Math.round((c[c.length-1]+b)*100)/100,c},K=e=>{if(!e)return[];try{const n=Array.isArray(e)?e:typeof e=="string"?JSON.parse(e):[];return Array.isArray(n)?n.map(r=>typeof r=="string"?{vencimento:r}:!r||typeof r!="object"?null:{vencimento:r.vencimento||r.due_date||r.data||r.date||""}).filter(Boolean):[]}catch{return[]}},L=new Date;L.setHours(0,0,0,0);const Y=e=>{const n=Number(e.valor_liquido??e.valor_bruto??e.valor??0);if(!Number.isFinite(n)||n===0)return 0;const r=K(e.recebimento_parcelas).map(d=>h(d.vencimento)).filter(Boolean),c=Math.max(1,r.length||parseInt(e.parcelas||"1",10)||1),i=T(e.forma_pagamento),b=h(e.data_recebimento),y=h(e.data_competencia);let m=null;if(i==="BOLETO"||i==="CHEQUE"?m=b||y:i==="CREDITO"||i==="CONVENIO"?m=b||(y?C(y,30):null):i==="DEBITO"?m=b||(y?S(y,1):null):m=b||y,!m&&r.length===0)return 0;const q=i==="CREDITO"||i==="CONVENIO"?30:0,ae=Z(n,c);let U=0;for(let d=0;d<c;d+=1){let w=r[d]||m;w&&(r[d]||(q&&d>0?w=C(m,q*d):!q&&c>1&&d>0&&(w=k(m,d))),w<=L&&(U+=ae[d]||0))}return U},B=new Map;j.forEach(e=>{if(!e.bank_account_id)return;const n=Y(e);!Number.isFinite(n)||n===0||B.set(e.bank_account_id,(B.get(e.bank_account_id)||0)+n)});const R=new Map;_.forEach(e=>{if(!e.bank_account_id)return;const n=Number(e.valor??0);Number.isFinite(n)&&R.set(e.bank_account_id,(R.get(e.bank_account_id)||0)+n)});const A=[],ee=t.map(e=>{const n=g(e.initial_balance??0),r=B.get(e.id)||0,c=R.get(e.id)||0,i=n+r-c,b=g(e.current_balance??e.initial_balance??0);return Math.abs(b-i)>.009&&A.push({id:e.id,current_balance:i}),{...e,current_balance:i}});return A.length&&await Promise.all(A.map(e=>x.from("bank_accounts").update({current_balance:e.current_balance}).eq("id",e.id))),ee},O=async()=>{try{if(E(!0),!u){M([]),E(!1);return}let t=x.from("bank_accounts").select("*");u&&(t=t.eq("clinic_id",u));const{data:s,error:o}=await t;if(o)throw o;const _=await W(s||[]);M(_||[])}catch(t){console.error("Erro ao buscar contas:",t)}finally{E(!1)}};f.useEffect(()=>{O()},[u]);const X=async t=>{t.preventDefault(),z(!0);try{if(!u){alert("Selecione uma clínica antes de salvar.");return}const s=g(l.initial_balance);if(N){const o=D.find(T=>T.id===N),j=g(o?.current_balance??o?.initial_balance??0),_=g(o?.initial_balance??0),h=g(l.current_balance),C=h-j,S=_+C,{error:k}=await x.from("bank_accounts").update({nome_conta:l.name,banco:l.bank,current_balance:h,initial_balance:S}).eq("id",N);if(k)throw k}else{const{error:o}=await x.from("bank_accounts").insert([{nome_conta:l.name,banco:l.bank,initial_balance:s,current_balance:s,ativo:!0,clinic_id:u}]);if(o)throw o}v(!1),I(null),p({name:"",bank:"",initial_balance:"0,00",current_balance:"0,00"}),O()}catch(s){alert("Erro ao salvar conta: "+s.message)}finally{z(!1)}},G=t=>{I(t.id),p({name:t.nome_conta||t.name||"",bank:t.banco||t.bank||"",initial_balance:String(t.initial_balance??t.current_balance??0).replace(".",","),current_balance:String(t.current_balance??t.initial_balance??0).replace(".",",")}),v(!0)},J=async t=>{if(confirm("Tem certeza? Isso pode afetar transações vinculadas."))try{const{error:s}=await x.from("bank_accounts").delete().eq("id",t);if(s)throw s;O()}catch(s){alert("Erro ao excluir: "+s.message)}};return a.jsxs("div",{className:"space-y-6",children:[a.jsxs("div",{className:"flex justify-between items-center",children:[a.jsxs("div",{children:[a.jsx("h1",{className:"text-2xl font-bold text-gray-800",children:"Contas Bancárias"}),a.jsx("p",{className:"text-gray-500",children:"Gerencie onde o dinheiro entra e sai"})]}),a.jsxs("button",{onClick:()=>v(!0),className:"flex items-center gap-2 px-4 py-2 bg-brand-600 text-white rounded-lg hover:bg-brand-700 transition-colors",children:[a.jsx(le,{size:20})," Nova Conta"]})]}),Q?a.jsx("div",{className:"flex justify-center p-12",children:a.jsx(oe,{className:"animate-spin text-brand-600"})}):a.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6",children:[D.map(t=>a.jsxs("div",{className:"bg-white p-6 rounded-xl shadow-sm border border-gray-100 flex flex-col justify-between h-48 relative overflow-hidden group",children:[a.jsx("div",{className:"absolute top-0 right-0 p-4 opacity-0 group-hover:opacity-100 transition-opacity",children:a.jsxs("div",{className:"flex gap-2",children:[a.jsx("button",{onClick:()=>G(t),className:"text-gray-400 hover:text-brand-600",children:a.jsx(de,{size:18})}),a.jsx("button",{onClick:()=>J(t.id),className:"text-gray-400 hover:text-red-600",children:a.jsx(ce,{size:18})})]})}),a.jsxs("div",{className:"flex items-center gap-3 mb-4",children:[a.jsx("div",{className:"w-10 h-10 bg-brand-50 rounded-full flex items-center justify-center text-brand-600",children:a.jsx(re,{size:20})}),a.jsxs("div",{children:[a.jsx("h3",{className:"font-bold text-gray-800",children:t.name||t.nome_conta}),a.jsx("p",{className:"text-sm text-gray-500",children:t.bank||t.banco})]})]}),a.jsxs("div",{children:[a.jsx("p",{className:"text-sm text-gray-500 mb-1",children:"Saldo Atual"}),a.jsx("p",{className:"text-2xl font-bold text-gray-800",children:se(t.current_balance||0)})]})]},t.id)),D.length===0&&a.jsx("div",{className:"col-span-full text-center py-12 bg-white rounded-xl border border-dashed border-gray-300",children:a.jsx("p",{className:"text-gray-500",children:"Nenhuma conta cadastrada."})})]}),P&&a.jsx("div",{className:"fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4",onClick:$.onBackdropClick,children:a.jsxs("div",{className:"bg-white rounded-xl shadow-xl max-w-md w-full p-6",onClick:t=>t.stopPropagation(),children:[a.jsx("h2",{className:"text-xl font-bold text-gray-800 mb-4",children:N?"Editar Conta Bancária":"Nova Conta Bancária"}),a.jsxs("form",{onSubmit:X,className:"space-y-4",children:[a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Nome da Conta (Apelido)"}),a.jsx("input",{required:!0,value:l.name,onChange:t=>p({...l,name:t.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg outline-none focus:ring-2 focus:ring-brand-500",placeholder:"Ex: Itaú Principal"})]}),a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Banco"}),a.jsx("input",{required:!0,value:l.bank,onChange:t=>p({...l,bank:t.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg outline-none focus:ring-2 focus:ring-brand-500",placeholder:"Ex: Itaú, Nubank, Caixa"})]}),a.jsx("div",{children:N?a.jsxs(a.Fragment,{children:[a.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Saldo Atual (R$)"}),a.jsx("input",{type:"number",step:"0.01",required:!0,value:l.current_balance,onChange:t=>p({...l,current_balance:t.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg outline-none focus:ring-2 focus:ring-brand-500"})]}):a.jsxs(a.Fragment,{children:[a.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Saldo Inicial (R$)"}),a.jsx("input",{type:"number",step:"0.01",required:!0,value:l.initial_balance,onChange:t=>p({...l,initial_balance:t.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg outline-none focus:ring-2 focus:ring-brand-500"})]})}),a.jsxs("div",{className:"flex justify-end gap-3 pt-4",children:[a.jsx("button",{type:"button",onClick:H,className:"px-4 py-2 border rounded-lg text-gray-600 hover:bg-gray-50",children:"Cancelar"}),a.jsx("button",{type:"submit",disabled:F,className:"px-4 py-2 bg-brand-600 text-white rounded-lg hover:bg-brand-700 disabled:opacity-50",children:F?"Salvando...":"Salvar"})]})]})]})})]})};export{ge as default};
