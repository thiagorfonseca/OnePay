import{u as Re,r,j as e,C as Le}from"./index-HcuLVkXM.js";import{u as de,c as ze}from"./commercial-BJ1Dvjq-.js";import{f as ue}from"./utils-C6qNh0Lg.js";import{u as Pe}from"./useModalControls-BiWM_r1l.js";import{L as Te}from"./loader-2-CJ7EHZdi.js";import{M as Fe}from"./map-pin-D37Fua2K.js";const he="onefincGeoCache",Ge=4500,me=25;let G=null;const fe=()=>typeof window>"u"?Promise.reject(new Error("window indisponivel")):window.L?Promise.resolve(window.L):G||(G=new Promise((s,o)=>{if(!document.querySelector("link[data-leaflet]")){const f=document.createElement("link");f.rel="stylesheet",f.href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css",f.setAttribute("data-leaflet","true"),document.head.appendChild(f)}const u=document.querySelector("script[data-leaflet]");if(u){u.addEventListener("load",()=>s(window.L)),u.addEventListener("error",()=>o(new Error("Falha ao carregar Leaflet.")));return}const g=document.createElement("script");g.src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js",g.async=!0,g.setAttribute("data-leaflet","true"),g.onload=()=>s(window.L),g.onerror=()=>o(new Error("Falha ao carregar Leaflet.")),document.body.appendChild(g)}),G),pe=s=>s.toISOString().slice(0,10),ge=s=>{const o=new Date,l=new Date;switch(s){case"quinzenal":l.setDate(l.getDate()-15);break;case"mensal":l.setMonth(l.getMonth()-1);break;case"trimestral":l.setMonth(l.getMonth()-3);break;case"semestral":l.setMonth(l.getMonth()-6);break;case"anual":l.setFullYear(l.getFullYear()-1);break}return{from:pe(l),to:pe(o)}},X=s=>s.replace(/\D/g,""),E=s=>{if(s==null)return null;const o=typeof s=="number"?s:Number(s);return Number.isFinite(o)?o:null},Ie=async(s,o,l=Ge)=>{const u=X(s);if(u.length<5)return null;if(o.current[u])return o.current[u];const g=`https://nominatim.openstreetmap.org/search?postalcode=${encodeURIComponent(u)}&country=Brazil&format=json&limit=1`;try{const f=new AbortController,k=setTimeout(()=>f.abort(),l),w=await fetch(g,{headers:{"Accept-Language":"pt-BR"},signal:f.signal});if(clearTimeout(k),!w.ok)return null;const v=await w.json();if(!v||!v[0])return null;const C={lat:parseFloat(v[0].lat),lng:parseFloat(v[0].lon)};return o.current[u]=C,typeof window<"u"&&window.localStorage.setItem(he,JSON.stringify(o.current)),C}catch{return null}},qe=()=>{const{effectiveClinicId:s}=Re(),[o,l]=r.useState(!0),[u,g]=r.useState([]),[f,k]=r.useState(null),[w,v]=r.useState(null),[C,xe]=r.useState("all"),[be,I]=r.useState("mensal"),A=ge("mensal"),[{from:D,to:B},ee]=r.useState(()=>A),[R,O]=r.useState(()=>A.from),[L,_]=r.useState(()=>A.to),[M,ye]=r.useState(10),[V,je]=r.useState(!0),[q,we]=r.useState(!0),[U,ve]=r.useState(!0),[$,Ce]=r.useState(!1),[te,Ne]=r.useState(!1),[Y,H]=r.useState([]),[J,ne]=r.useState(0),[Z,z]=r.useState(!1),[b,re]=r.useState(!1),x=r.useRef(null),P=r.useRef(null),K=r.useRef(null),N=r.useRef({}),Q=r.useRef([]),y=r.useRef({}),W=r.useRef(0),T=r.useRef(0);r.useEffect(()=>{if(!(typeof window>"u"))try{const n=window.localStorage.getItem(he);n&&(N.current=JSON.parse(n))}catch{N.current={}}},[]);const Se=n=>{if(I(n),n==="personalizado")return;const t=ge(n);O(t.from),_(t.to)},ae=(n,t)=>{I("personalizado"),O(n),_(t)},ke=()=>{ee({from:R,to:L})},Ee=()=>{I("personalizado"),O(""),_(""),ee({from:"",to:""})},se=()=>{const n=Q.current.map(t=>{const c=E(t.lat),m=E(t.lng);if(c!==null&&m!==null)return{name:t.name,cep:t.cep,lat:c,lng:m,total:t.total,atendimentos:t.atendimentos};const h=N.current[X(t.cep)];return h?{name:t.name,cep:t.cep,lat:h.lat,lng:h.lng,total:t.total,atendimentos:t.atendimentos}:null}).filter(Boolean);g(n)},oe=async(n=me,t=T.current,c)=>{if(Z)return;const h=(c??Y).slice(0,n);if(!h.length)return;if(z(!0),await Promise.all(h.map(async i=>{const a=await Ie(i,N);if(!a||T.current!==t)return;const d=y.current[i];d&&d.length&&(await de(d,a),delete y.current[i])})),T.current!==t){z(!1);return}const S=new Set(h);H(i=>i.filter(a=>!S.has(a))),se(),z(!1)};r.useEffect(()=>{(async()=>{const t=++W.current;if(!s){g([]),v(null),l(!1),k("Selecione uma clinica para visualizar o mapa.");return}l(!0),k(null);try{const c=await ze({clinicId:s,from:D||void 0,to:B||void 0});if(W.current!==t)return;v(c)}catch(c){k(c.message||"Erro ao carregar dados do mapa.")}finally{W.current===t&&l(!1)}})()},[s,D,B]),r.useEffect(()=>{if(!w)return;const n=++T.current;Q.current=[],y.current={},H([]),ne(0),z(!1);const t=a=>a.trim().toLowerCase(),c=new Map;w.revenues.forEach(a=>{const d=(a.paciente||"Sem nome").trim()||"Sem nome",p=t(d),j=c.get(p)||{total:0,atendimentos:0},F=Number(a.valor_liquido??a.valor??0);c.set(p,{total:j.total+(isFinite(F)?F:0),atendimentos:j.atendimentos+1})});const m=w.customers.filter(a=>a.name&&a.cep).map(a=>{const d=t(a.name||""),p=c.get(d)||{total:0,atendimentos:0},j=E(a.lat),F=E(a.lng),ie=p.atendimentos>0;return C==="attended"&&!ie||C==="not_attended"&&ie?null:{customerId:a.id,name:a.name||"Sem nome",cep:a.cep||"",total:p.total,atendimentos:p.atendimentos,lat:j,lng:F}}).filter(Boolean);if(!m.length){g([]);return}Q.current=m;const h=new Set;m.forEach(a=>{const d=X(a.cep);if(!d)return;h.add(d);const p=E(a.lat),j=E(a.lng);if(p!==null&&j!==null){N.current[d]={lat:p,lng:j};return}(p===null||j===null)&&(y.current[d]||(y.current[d]=[]),y.current[d].push(a.customerId))}),Object.entries(y.current).forEach(([a,d])=>{const p=N.current[a];!p||!d.length||(de(d,p),delete y.current[a])});const S=Array.from(h),i=S.filter(a=>!N.current[a]);H(i),ne(S.length),se(),i.length&&oe(me,n,i)},[w,C]),r.useEffect(()=>{if(o||f)return;let n=!0;return fe().then(t=>{!n||!K.current||(x.current||(x.current=t.map(K.current,{zoomControl:!0}),t.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:"&copy; OpenStreetMap contributors",maxZoom:18}).addTo(x.current),P.current=t.layerGroup().addTo(x.current)),x.current.invalidateSize(),Ne(!0))}).catch(()=>{k("Não foi possível carregar o mapa.")}),()=>{n=!1}},[o,f]),r.useEffect(()=>{if(!x.current)return;const n=setTimeout(()=>{x.current&&x.current.invalidateSize()},150);return()=>clearTimeout(n)},[b]);const Me=Pe({isOpen:b,onClose:()=>re(!1)}),le=r.useMemo(()=>{const n=u.reduce((t,c)=>Math.max(t,c.total),0);return n>0?n:1},[u]);r.useEffect(()=>{let n=!0;if(te)return fe().then(t=>{if(!n||!x.current||!P.current)return;P.current.clearLayers();const c=[];u.forEach(m=>{const h=V?M+m.total/le*M:M,S=t.circleMarker([m.lat,m.lng],{radius:h,color:"#0284c7",fillColor:"#38bdf8",fillOpacity:.75,weight:1});let i="";q&&(i+=`<strong>${m.name}</strong>`),U&&(i+=`${i?"<br/>":""}Consumo: ${ue(m.total)}`),$&&(i+=`${i?"<br/>":""}Atendimentos: ${m.atendimentos}`),i&&S.bindTooltip(i,{direction:"top",opacity:.9,sticky:!0}),S.addTo(P.current),c.push([m.lat,m.lng])}),c.length?x.current.fitBounds(c,{padding:[40,40]}):x.current.setView([-14.235,-51.925],4)}),()=>{n=!1}},[u,M,V,q,U,$,le,te]);const ce=n=>e.jsxs("div",{className:n==="modal"?"bg-white border border-gray-100 rounded-xl shadow-sm p-4 space-y-3":"space-y-3",children:[e.jsxs("div",{className:"flex flex-wrap items-center gap-3 text-sm",children:[e.jsxs("div",{className:"flex items-center gap-2 px-3 py-2 border border-gray-200 rounded-lg text-sm bg-white",children:[e.jsx(Le,{size:16})," Periodo:",e.jsxs("select",{value:be,onChange:t=>Se(t.target.value),className:"text-sm bg-transparent focus:outline-none",children:[e.jsx("option",{value:"quinzenal",children:"Ultimos 15 dias"}),e.jsx("option",{value:"mensal",children:"Ultimos 30 dias"}),e.jsx("option",{value:"trimestral",children:"Ultimos 3 meses"}),e.jsx("option",{value:"semestral",children:"Ultimos 6 meses"}),e.jsx("option",{value:"anual",children:"Ultimos 12 meses"}),e.jsx("option",{value:"personalizado",children:"Personalizado"})]})]}),e.jsxs("label",{className:"flex items-center gap-2 text-gray-600",children:[e.jsx("span",{children:"De"}),e.jsx("input",{type:"date",value:R,onChange:t=>ae(t.target.value,L),className:"px-3 py-2 border border-gray-200 rounded-lg bg-white text-gray-700"})]}),e.jsxs("label",{className:"flex items-center gap-2 text-gray-600",children:[e.jsx("span",{children:"Ate"}),e.jsx("input",{type:"date",value:L,onChange:t=>ae(R,t.target.value),className:"px-3 py-2 border border-gray-200 rounded-lg bg-white text-gray-700"})]}),e.jsxs("label",{className:"flex items-center gap-2 text-gray-600",children:[e.jsx("span",{children:"Atendimento"}),e.jsxs("select",{value:C,onChange:t=>xe(t.target.value),className:"px-3 py-2 border border-gray-200 rounded-lg bg-white text-gray-700",children:[e.jsx("option",{value:"all",children:"Todos"}),e.jsx("option",{value:"attended",children:"Com atendimento"}),e.jsx("option",{value:"not_attended",children:"Sem atendimento"})]})]}),e.jsx("button",{type:"button",onClick:ke,className:"px-3 py-2 text-sm border border-gray-200 rounded-lg text-gray-700 hover:bg-gray-50",children:"Aplicar"}),(D||B||R||L)&&e.jsx("button",{type:"button",onClick:Ee,className:"px-3 py-2 text-sm border border-gray-200 rounded-lg text-gray-700 hover:bg-gray-50",children:"Limpar"})]}),e.jsxs("div",{className:"flex flex-wrap items-center gap-4 text-sm text-gray-600",children:[e.jsxs("label",{className:"flex items-center gap-2",children:[e.jsx("span",{children:"Tamanho"}),e.jsx("input",{type:"range",min:6,max:20,value:M,onChange:t=>ye(Number(t.target.value))})]}),e.jsxs("label",{className:"inline-flex items-center gap-2",children:[e.jsx("input",{type:"checkbox",checked:V,onChange:t=>je(t.target.checked)}),"Tamanho por valor"]}),e.jsxs("label",{className:"inline-flex items-center gap-2",children:[e.jsx("input",{type:"checkbox",checked:q,onChange:t=>we(t.target.checked)}),"Mostrar nomes"]}),e.jsxs("label",{className:"inline-flex items-center gap-2",children:[e.jsx("input",{type:"checkbox",checked:U,onChange:t=>ve(t.target.checked)}),"Mostrar consumo"]}),e.jsxs("label",{className:"inline-flex items-center gap-2",children:[e.jsx("input",{type:"checkbox",checked:$,onChange:t=>Ce(t.target.checked)}),"Mostrar atendimentos"]})]})]});return e.jsxs("div",{className:"space-y-4",children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-800",children:"Comercial • Geolocalizacao"}),e.jsx("p",{className:"text-gray-500",children:"Clientes destacados por CEP, com consumo e recorrencia no periodo."}),!b&&e.jsx("div",{className:"bg-white border border-gray-100 rounded-xl shadow-sm p-4",children:ce("page")}),e.jsx("div",{className:b?"fixed inset-0 z-50 bg-black/40 p-4 sm:p-6":"",onClick:b?Me.onBackdropClick:void 0,children:e.jsxs("div",{className:b?"bg-white rounded-2xl shadow-xl p-4 sm:p-6 h-full flex flex-col":"bg-white border border-gray-100 rounded-xl p-4",onClick:n=>n.stopPropagation(),children:[e.jsxs("div",{className:"flex flex-wrap items-center justify-between gap-2 mb-2",children:[e.jsx("p",{className:"font-semibold text-gray-800",children:"Mapa"}),e.jsxs("div",{className:"flex items-center gap-2",children:[J>0&&e.jsxs("div",{className:"flex items-center gap-2 text-xs text-gray-500",children:[e.jsxs("span",{children:["Geocodificados ",J-Y.length," de ",J]}),Y.length>0&&!Z&&e.jsx("button",{type:"button",onClick:()=>oe(),className:"px-2 py-1 border border-gray-200 rounded-md text-gray-600 hover:bg-gray-50",children:"Continuar"}),Z&&e.jsx("span",{children:"Geocodificando..."})]}),e.jsx("button",{type:"button",onClick:()=>re(n=>!n),className:"px-3 py-2 text-sm border border-gray-200 rounded-lg text-gray-700 hover:bg-gray-50",children:b?"Fechar":"Abrir em tela cheia"})]})]}),b&&e.jsx("div",{className:"mb-3",children:ce("modal")}),e.jsxs("div",{className:b?"relative flex-1 min-h-[360px] rounded-lg overflow-hidden border":"relative h-96 rounded-lg overflow-hidden border",children:[e.jsx("div",{className:"h-full",ref:K}),o&&e.jsxs("div",{className:"absolute inset-0 bg-white/70 flex items-center justify-center text-gray-500",children:[e.jsx(Te,{className:"animate-spin mr-2",size:20})," Carregando..."]}),f&&!o&&e.jsx("div",{className:"absolute inset-0 bg-white/80 flex items-center justify-center text-sm text-red-600",children:f})]})]})}),e.jsxs("div",{className:"bg-white border border-gray-100 rounded-xl p-4",children:[e.jsx("p",{className:"font-semibold text-gray-800 mb-3",children:"Clientes georreferenciados"}),e.jsxs("div",{className:"space-y-2",children:[u.map((n,t)=>e.jsxs("div",{className:"flex items-center justify-between text-sm text-gray-700",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Fe,{size:16,className:"text-brand-600"}),e.jsxs("span",{children:[n.name," • CEP ",n.cep]})]}),e.jsxs("div",{className:"text-xs text-gray-500",children:[ue(n.total)," • ",n.atendimentos," atend."]})]},t)),u.length===0&&!o&&!f&&e.jsx("p",{className:"text-gray-400 text-sm",children:"Nenhum CEP valido encontrado no periodo."})]})]})]})};export{qe as default};
