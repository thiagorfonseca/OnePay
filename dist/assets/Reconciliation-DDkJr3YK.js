import{c as $,u as Ae,r as n,s as d,j as e}from"./index-HcuLVkXM.js";import{b as C,f as v,p as Le}from"./utils-C6qNh0Lg.js";import{u as P}from"./useModalControls-BiWM_r1l.js";import{L as V}from"./loader-2-CJ7EHZdi.js";import{U as ze}from"./upload-DlYh6qZH.js";import{E as xe}from"./eye-DWJKAkmY.js";import{A as Fe}from"./alert-circle-CadagfFR.js";import{L as Be}from"./link-DvuaMiAh.js";import{S as Pe}from"./search-C1xIXvIu.js";const Ve=$("CheckCircle",[["path",{d:"M22 11.08V12a10 10 0 1 1-5.93-9.14",key:"g774vq"}],["path",{d:"m9 11 3 3L22 4",key:"1pflzl"}]]),me=$("EyeOff",[["path",{d:"M9.88 9.88a3 3 0 1 0 4.24 4.24",key:"1jxqfv"}],["path",{d:"M10.73 5.08A10.43 10.43 0 0 1 12 5c7 0 10 7 10 7a13.16 13.16 0 0 1-1.67 2.68",key:"9wicm4"}],["path",{d:"M6.61 6.61A13.526 13.526 0 0 0 2 12s3 7 10 7a9.74 9.74 0 0 0 5.39-1.61",key:"1jreej"}],["line",{x1:"2",x2:"22",y1:"2",y2:"22",key:"a6p6uj"}]]),$e=$("PlusCircle",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M8 12h8",key:"1wcyev"}],["path",{d:"M12 8v8",key:"napkw2"}]]),Ze=()=>{const{effectiveClinicId:ue}=Ae(),w=ue||null,[y,x]=n.useState(!1),[k,U]=n.useState([]),[c,M]=n.useState(""),[X,pe]=n.useState([]),[Q,he]=n.useState(null),[H,S]=n.useState(!1),[W,q]=n.useState(!1),[s,T]=n.useState(null),[fe,G]=n.useState([]),[E,I]=n.useState([]),[be,J]=n.useState(!1),[_,K]=n.useState(""),[R,Y]=n.useState(!0),[O,Z]=n.useState(!1),[A,ye]=n.useState(!0),[g,L]=n.useState(null),ee=()=>{S(!1)},ae=()=>{q(!1)},te=()=>{L(null)},ge=P({isOpen:H,onClose:ee}),je=P({isOpen:W,onClose:ae}),ve=P({isOpen:!!g,onClose:te}),[z,se]=n.useState(!1),[u,D]=n.useState({category_id:"",description:"",entity_name:""}),re=n.useMemo(()=>{if(!s)return 0;const a=Math.abs(Number(s.valor||0));return Math.max(1,a*.01)},[s]),F=3;n.useEffect(()=>{(async()=>{if(!w){U([]),M(""),G([]);return}let t=d.from("bank_accounts").select("*");w&&(t=t.eq("clinic_id",w));const{data:r}=await t,{data:i}=await d.from("categories").select("*");r&&U(r),i&&G(i)})()},[w]),n.useEffect(()=>{c&&(k.some(a=>a.id===c)||M(""))},[k,c]),n.useEffect(()=>{c&&f()},[c]);const f=async()=>{x(!0);try{const{data:a,error:t}=await d.from("bank_transactions").select("*").eq("bank_account_id",c).order("data",{ascending:!1});if(t)throw t;pe(a||[])}catch(a){console.error(a)}finally{x(!1)}},Ne=async a=>{if(a?.id){x(!0);try{const{error:t}=await d.from("bank_transactions").update({arquivado:!0}).eq("id",a.id);if(t)throw t;f()}catch(t){alert("Erro ao arquivar: "+t.message)}finally{x(!1)}}},Ce=async a=>{if(a?.id){x(!0);try{const{error:t}=await d.from("bank_transactions").update({arquivado:!1}).eq("id",a.id);if(t)throw t;f()}catch(t){alert("Erro ao desarquivar: "+t.message)}finally{x(!1)}}},ne=n.useMemo(()=>{let a=X;return A&&(a=a.filter(t=>!t.arquivado)),R&&(a=a.filter(t=>!t.conciliado)),O&&(a=a.filter(t=>!!t.conciliado)),a},[X,A,R,O]),oe=a=>a?a.includes("T")?a.split("T")[0]:a:"",ie=(a,t)=>{if(!a)return"";const r=new Date(`${a}T00:00:00`);return Number.isNaN(r.getTime())?a:(r.setDate(r.getDate()+t),r.toISOString().split("T")[0])},we=(a,t)=>{if(!a||!t)return 9999;const r=new Date(`${a}T00:00:00`),i=new Date(`${t}T00:00:00`);if(Number.isNaN(r.getTime())||Number.isNaN(i.getTime()))return 9999;const l=Math.abs(r.getTime()-i.getTime());return Math.round(l/864e5)},le=a=>Math.round(Number(a||0)*100),ke=async a=>{if(!(!a||!c)){J(!0);try{const t=a.tipo==="CREDIT",r=Math.abs(Number(a.valor||0)),i=oe(a.data),l=ie(i,-F),j=ie(i,F);let b=d.from(t?"revenues":"expenses").select("*").eq("bank_account_id",c).gte("data_competencia",l).lte("data_competencia",j);const{data:h,error:m}=await b;if(m)throw m;const B=(h||[]).filter(o=>{const p=Number(t?o.valor_bruto??o.valor_liquido??o.valor??0:o.valor??0);return Math.abs(p-r)<=re}).map(o=>{const p=Number(t?o.valor_bruto??o.valor_liquido??o.valor??0:o.valor??0),de=oe(o.data_competencia||""),Ee=de===i,Ie=le(p)===le(r),Re=we(de,i),Oe=Math.abs(p-r);return{item:o,sameDay:Ee,exactAmount:Ie,dayDiff:Re,amountDiff:Oe}}).sort((o,p)=>o.sameDay!==p.sameDay?o.sameDay?-1:1:o.exactAmount!==p.exactAmount?o.exactAmount?-1:1:o.dayDiff!==p.dayDiff?o.dayDiff-p.dayDiff:o.amountDiff-p.amountDiff).map(o=>o.item);I(B)}catch(t){console.error(t),I([])}finally{J(!1)}}},_e=a=>{T(a),K(""),I([]),q(!0),ke(a)},De=async a=>{if(s){x(!0);try{const t=s.tipo==="CREDIT",r={conciliado:!0};t?r.revenue_id_opcional=a.id:r.expense_id_opcional=a.id;const{error:i}=await d.from("bank_transactions").update(r).eq("id",s.id);if(i)throw i;q(!1),T(null),f()}catch(t){alert("Erro ao vincular: "+t.message)}finally{x(!1)}}},Me=async a=>{if(a?.id){se(!0);try{const{error:t}=await d.from("bank_transactions").update({conciliado:!1,revenue_id_opcional:null,expense_id_opcional:null}).eq("id",a.id);if(t)throw t;L(null),f()}catch(t){alert("Erro ao reabrir conciliação: "+t.message)}finally{se(!1)}}},ce=n.useMemo(()=>{if(!_.trim())return E;const a=_.trim().toLowerCase();return E.filter(t=>(t.description||t.paciente||t.fornecedor||"").toLowerCase().includes(a))},[E,_]),Se=async a=>{if(!c){alert("Selecione uma conta bancária antes de importar o arquivo.");return}const t=a.target.files?.[0];if(t){x(!0),he(t.name);const r=new FileReader;r.onload=async i=>{const l=i.target?.result;if(typeof l=="string"){const j=Le(l);let b=0,h=0;for(const m of j){const{data:N}=await d.from("bank_transactions").select("id").eq("hash_transacao",m.hash).eq("bank_account_id",c).maybeSingle();N?h++:(await d.from("bank_transactions").insert([{bank_account_id:c,data:m.date,descricao:m.description,valor:m.amount,tipo:m.type,hash_transacao:m.hash,conciliado:!1}]),b++)}alert(`Processamento concluído: ${b} novos, ${h} duplicados ignorados.`),f()}x(!1)},r.readAsText(t)}},qe=a=>{T(a),D({category_id:"",description:a.descricao,entity_name:""}),S(!0)},Te=async a=>{if(a.preventDefault(),!(!s||!u.category_id)){x(!0);try{const t=s.tipo==="CREDIT",r=t?"revenues":"expenses",i=Math.abs(s.valor),l={description:u.description,data_competencia:s.data,category_id:u.category_id,bank_account_id:c,observacoes:"Conciliado via OFX"};t?(l.valor_bruto=i,l.valor_liquido=i,l.data_recebimento=s.data,l.forma_pagamento="Transferência",l.paciente=u.entity_name):(l.valor=i,l.data_pagamento=s.data,l.fornecedor=u.entity_name,l.tipo_despesa="Variavel");const{data:j,error:b}=await d.from(r).insert([l]).select().single();if(b)throw b;const h={conciliado:!0};t?h.revenue_id_opcional=j.id:h.expense_id_opcional=j.id,await d.from("bank_transactions").update(h).eq("id",s.id);const m=k.find(N=>N.id===c);if(m){const B=Number(m.current_balance||0)+s.valor;await d.from("bank_accounts").update({current_balance:B}).eq("id",c)}S(!1),f()}catch(t){alert("Erro: "+t.message)}finally{x(!1)}}};return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"mb-8",children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-800",children:"Conciliação Bancária"}),e.jsx("p",{className:"text-gray-500",children:"Importe extratos OFX e concilie lançamentos"})]}),e.jsxs("div",{className:"bg-white p-6 rounded-xl shadow-sm border border-gray-100 mb-6",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Selecione a Conta para Conciliar"}),e.jsxs("select",{className:"w-full md:w-1/3 px-3 py-2 border border-gray-300 rounded-lg focus:ring-brand-500 outline-none",value:c,onChange:a=>M(a.target.value),children:[e.jsx("option",{value:"",children:"Selecione..."}),k.map(a=>e.jsxs("option",{value:a.id,children:[a.nome_conta||a.name||"Conta"," (",a.banco||a.bank||"Banco",")"]},a.id))]})]}),c&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"bg-white p-8 rounded-xl shadow-sm border border-gray-100 text-center border-dashed border-2 border-brand-100",children:e.jsxs("div",{className:"flex flex-col items-center justify-center space-y-4",children:[e.jsx("div",{className:"w-16 h-16 bg-brand-50 rounded-full flex items-center justify-center text-brand-600",children:y?e.jsx(V,{className:"animate-spin",size:32}):e.jsx(ze,{size:32})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-medium text-gray-800",children:"Importar arquivo OFX"}),e.jsx("p",{className:"text-gray-500 text-sm mt-1",children:"Os lançamentos serão salvos e verificados contra duplicidade."})]}),e.jsx("input",{type:"file",accept:".ofx",id:"ofx-upload",className:"hidden",onChange:Se,disabled:y}),e.jsx("label",{htmlFor:"ofx-upload",className:`px-6 py-2 bg-brand-600 text-white rounded-lg hover:bg-brand-700 cursor-pointer transition-colors ${y?"opacity-50 pointer-events-none":""}`,children:"Selecionar Arquivo"}),Q&&e.jsxs("p",{className:"text-xs text-gray-500",children:["Selecionado: ",Q]})]})}),e.jsxs("div",{className:"bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden mt-6",children:[e.jsxs("div",{className:"p-4 border-b border-gray-100 bg-gray-50 flex flex-wrap justify-between items-center gap-3",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold text-gray-700",children:"Lançamentos Bancários"}),e.jsx("span",{className:"text-xs text-gray-400",children:"Ordenado por data (mais recente)"})]}),e.jsxs("div",{className:"flex flex-wrap items-center gap-2 text-xs",children:[e.jsxs("label",{className:"flex items-center gap-2 text-gray-600",children:[e.jsx("input",{type:"checkbox",checked:R,onChange:a=>{const t=a.target.checked;Y(t),t&&Z(!1)}}),"Mostrar apenas pendentes"]}),e.jsxs("label",{className:"flex items-center gap-2 text-gray-600",children:[e.jsx("input",{type:"checkbox",checked:O,onChange:a=>{const t=a.target.checked;Z(t),t&&Y(!1)}}),"Mostrar apenas conciliadas"]}),e.jsx("button",{type:"button",onClick:()=>ye(a=>!a),className:"px-2 py-1 border border-gray-200 rounded text-gray-600 hover:bg-gray-100",children:A?e.jsxs("span",{className:"inline-flex items-center gap-1",children:[e.jsx(xe,{size:12})," Mostrar arquivados"]}):e.jsxs("span",{className:"inline-flex items-center gap-1",children:[e.jsx(me,{size:12})," Ocultar arquivados"]})})]})]}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full text-left text-sm",children:[e.jsx("thead",{className:"bg-white text-gray-500 font-medium border-b border-gray-100",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-6 py-3",children:"Data"}),e.jsx("th",{className:"px-6 py-3",children:"Descrição Banco"}),e.jsx("th",{className:"px-6 py-3",children:"Valor"}),e.jsx("th",{className:"px-6 py-3",children:"Status"}),e.jsx("th",{className:"px-6 py-3 text-right",children:"Ação"})]})}),e.jsxs("tbody",{className:"divide-y divide-gray-100",children:[ne.map(a=>{const t=a.tipo==="CREDIT";return e.jsxs("tr",{className:"hover:bg-gray-50",children:[e.jsx("td",{className:"px-6 py-4 text-gray-600",children:C(a.data)}),e.jsx("td",{className:"px-6 py-4 font-medium text-gray-800",children:a.descricao}),e.jsx("td",{className:`px-6 py-4 font-bold ${t?"text-green-600":"text-red-600"}`,children:v(a.valor)}),e.jsx("td",{className:"px-6 py-4",children:a.conciliado?e.jsxs("span",{className:"inline-flex items-center gap-1 px-2 py-1 bg-green-100 text-green-700 rounded-full text-xs font-medium",children:[e.jsx(Ve,{size:12})," Conciliado"]}):e.jsxs("span",{className:"inline-flex items-center gap-1 px-2 py-1 bg-yellow-100 text-yellow-700 rounded-full text-xs font-medium",children:[e.jsx(Fe,{size:12})," Pendente"]})}),e.jsx("td",{className:"px-6 py-4 text-right",children:e.jsxs("div",{className:"flex items-center justify-end gap-2",children:[!a.conciliado&&e.jsxs(e.Fragment,{children:[e.jsxs("button",{className:"flex items-center gap-1 px-3 py-1 text-xs border border-brand-200 text-brand-700 bg-brand-50 rounded hover:bg-brand-100 transition-colors",title:"Vincular a lançamento já existente",onClick:()=>_e(a),children:[e.jsx(Be,{size:12})," Vincular"]}),e.jsxs("button",{onClick:()=>qe(a),className:"flex items-center gap-1 px-3 py-1 text-xs bg-brand-600 text-white rounded hover:bg-brand-700 transition-colors",title:"Criar receita/despesa a partir deste item",children:[e.jsx($e,{size:12})," Criar"]})]}),a.conciliado&&e.jsx("button",{onClick:()=>L(a),className:"flex items-center gap-1 px-3 py-1 text-xs border border-yellow-200 text-yellow-700 bg-yellow-50 rounded hover:bg-yellow-100 transition-colors",title:"Reabrir conciliação",children:"Reabrir"}),a.arquivado?e.jsxs("button",{onClick:()=>Ce(a),className:"flex items-center gap-1 px-2 py-1 text-xs border border-gray-200 text-gray-600 rounded hover:bg-gray-100 transition-colors",title:"Desarquivar",children:[e.jsx(xe,{size:12})," Desarquivar"]}):e.jsxs("button",{onClick:()=>Ne(a),className:"flex items-center gap-1 px-2 py-1 text-xs border border-gray-200 text-gray-600 rounded hover:bg-gray-100 transition-colors",title:"Arquivar",children:[e.jsx(me,{size:12})," Arquivar"]})]})})]},a.id)}),ne.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:5,className:"text-center py-8 text-gray-400",children:"Nenhum lançamento importado nesta conta."})})]})]})})]})]}),H&&s&&e.jsx("div",{className:"fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4",onClick:ge.onBackdropClick,children:e.jsxs("div",{className:"bg-white rounded-xl shadow-xl max-w-lg w-full p-6",onClick:a=>a.stopPropagation(),children:[e.jsxs("h2",{className:"text-xl font-bold text-gray-800 mb-1",children:["Nova ",s.tipo==="CREDIT"?"Receita":"Despesa"," (Conciliação)"]}),e.jsxs("div",{className:"mb-4 text-sm text-gray-500 flex gap-2",children:[e.jsx("span",{children:C(s.data)}),e.jsx("span",{children:"•"}),e.jsx("span",{className:s.tipo==="CREDIT"?"text-green-600 font-bold":"text-red-600 font-bold",children:v(s.valor)})]}),e.jsxs("form",{onSubmit:Te,className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Descrição"}),e.jsx("input",{required:!0,value:u.description,onChange:a=>D({...u,description:a.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg outline-none focus:ring-brand-500"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Categoria"}),e.jsxs("select",{required:!0,value:u.category_id,onChange:a=>D({...u,category_id:a.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg outline-none bg-white",children:[e.jsx("option",{value:"",children:"Selecione..."}),fe.filter(a=>a.tipo===(s.tipo==="CREDIT"?"receita":"despesa")).map(a=>e.jsx("option",{value:a.id,children:a.name},a.id))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:s.tipo==="CREDIT"?"Paciente / Pagador":"Fornecedor"}),e.jsx("input",{value:u.entity_name,onChange:a=>D({...u,entity_name:a.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg outline-none focus:ring-brand-500"})]}),e.jsxs("div",{className:"flex justify-end gap-3 pt-4 border-t border-gray-100 mt-2",children:[e.jsx("button",{type:"button",onClick:ee,className:"px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50",children:"Cancelar"}),e.jsxs("button",{type:"submit",disabled:y,className:"px-4 py-2 bg-brand-600 text-white rounded-lg hover:bg-brand-700 flex items-center gap-2",children:[y&&e.jsx(V,{size:16,className:"animate-spin"}),"Confirmar e Conciliar"]})]})]})]})}),W&&s&&e.jsx("div",{className:"fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4",onClick:je.onBackdropClick,children:e.jsxs("div",{className:"bg-white rounded-xl shadow-xl max-w-2xl w-full p-6",onClick:a=>a.stopPropagation(),children:[e.jsxs("div",{className:"flex items-start justify-between gap-4 mb-4",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-bold text-gray-800",children:"Vincular lançamento existente"}),e.jsxs("p",{className:"text-sm text-gray-500",children:["Procuramos lançamentos com data próxima (±",F," dias) e valor aproximado (±",v(re),")."]})]}),e.jsxs("div",{className:"text-right text-sm text-gray-500",children:[e.jsx("div",{children:C(s.data)}),e.jsx("div",{className:s.tipo==="CREDIT"?"text-green-600 font-semibold":"text-red-600 font-semibold",children:v(s.valor)})]})]}),e.jsxs("div",{className:"relative mb-3",children:[e.jsx(Pe,{size:16,className:"absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"}),e.jsx("input",{value:_,onChange:a=>K(a.target.value),placeholder:"Filtrar por descrição/paciente/fornecedor...",className:"w-full pl-9 pr-3 py-2 border border-gray-300 rounded-lg text-sm"})]}),e.jsx("div",{className:"max-h-80 overflow-auto border border-gray-100 rounded-lg",children:be?e.jsxs("div",{className:"p-6 text-center text-gray-400",children:[e.jsx(V,{size:20,className:"animate-spin inline-block mr-2"}),"Buscando lançamentos..."]}):ce.length===0?e.jsx("div",{className:"p-6 text-center text-gray-400",children:"Nenhum lançamento encontrado com esse critério."}):e.jsxs("table",{className:"w-full text-sm",children:[e.jsx("thead",{className:"bg-gray-50 text-gray-500",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-2 text-left",children:"Data"}),e.jsx("th",{className:"px-4 py-2 text-left",children:"Descrição"}),e.jsx("th",{className:"px-4 py-2 text-left",children:"Valor"}),e.jsx("th",{className:"px-4 py-2 text-right",children:"Ação"})]})}),e.jsx("tbody",{className:"divide-y divide-gray-100",children:ce.map(a=>{const t=s.tipo==="CREDIT",r=Number(t?a.valor_bruto??a.valor_liquido??a.valor??0:a.valor??0);return e.jsxs("tr",{children:[e.jsx("td",{className:"px-4 py-2 text-gray-600",children:C(a.data_competencia)}),e.jsx("td",{className:"px-4 py-2 text-gray-800",children:a.description||a.paciente||a.fornecedor||"-"}),e.jsx("td",{className:`px-4 py-2 ${s.tipo==="CREDIT"?"text-green-600":"text-red-600"}`,children:v(r)}),e.jsx("td",{className:"px-4 py-2 text-right",children:e.jsx("button",{type:"button",onClick:()=>De(a),className:"px-3 py-1 text-xs bg-brand-600 text-white rounded hover:bg-brand-700",disabled:y,children:"Vincular"})})]},a.id)})})]})}),e.jsx("div",{className:"flex justify-end gap-3 pt-4 border-t border-gray-100 mt-4",children:e.jsx("button",{type:"button",onClick:ae,className:"px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50",children:"Fechar"})})]})}),g&&e.jsx("div",{className:"fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4",onClick:ve.onBackdropClick,children:e.jsxs("div",{className:"bg-white rounded-xl shadow-xl max-w-md w-full p-6",onClick:a=>a.stopPropagation(),children:[e.jsx("h2",{className:"text-lg font-bold text-gray-800 mb-2",children:"Reabrir conciliação?"}),e.jsx("p",{className:"text-sm text-gray-600",children:"Isso remove o vínculo com o lançamento e marca o item como pendente."}),e.jsxs("div",{className:"mt-4 text-sm text-gray-700 space-y-1",children:[e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Data:"})," ",C(g.data)]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Valor:"})," ",v(g.valor)]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Descrição:"})," ",g.descricao]})]}),e.jsxs("div",{className:"flex justify-end gap-2 pt-4 mt-4 border-t border-gray-100",children:[e.jsx("button",{type:"button",onClick:te,className:"px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50",disabled:z,children:"Cancelar"}),e.jsx("button",{type:"button",onClick:()=>Me(g),className:"px-4 py-2 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600",disabled:z,children:z?"Reabrindo...":"Reabrir"})]})]})})]})};export{Ze as default};
