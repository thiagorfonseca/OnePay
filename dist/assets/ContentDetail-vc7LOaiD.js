import{h as Ge,a as Je,u as He,r,j as e,L as U,s as h}from"./index-V1BrPv90.js";const Qe=a=>a?/\.(mp4|m3u8|webm|ogg)(\?|#|$)/i.test(a):!1,Xe=(a,l)=>{if(!a)return null;if(!l||l<=0)return a;const y=Math.max(0,Math.floor(l));try{const v=new URL(a);return v.searchParams.set("t",String(y)),v.toString()}catch{const v=a.includes("?")?"&":"?";return`${a}${v}t=${y}`}},he=a=>{if(!a)return null;if(typeof a=="string")try{const y=JSON.parse(a);return he(y)}catch{return null}if(typeof a!="object")return null;const l=a;return typeof l.currentTime=="number"?l.currentTime:typeof l.seconds=="number"?l.seconds:typeof l.time=="number"?l.time:l.data?he(l.data):null},tt=()=>{const{type:a,contentId:l}=Ge(),[y,v]=Je(),{clinicId:z,clinicPackageIds:L}=He(),W=r.useMemo(()=>y.get("lesson"),[y]),[ke,j]=r.useState(!0),[pe,T]=r.useState(null),[k,be]=r.useState(null),[c,X]=r.useState([]),[d,ye]=r.useState(null),[Y,Z]=r.useState([]),[$,Me]=r.useState("description"),[ee,M]=r.useState(""),[Ae,w]=r.useState(""),[te,N]=r.useState(!1),[q,se]=r.useState([]),[B,ve]=r.useState(!1),[re,ne]=r.useState(null),[P,ae]=r.useState([]),[Te,oe]=r.useState({}),[K,je]=r.useState(!1),[le,de]=r.useState(null),[ie,we]=r.useState(!1),[G,$e]=r.useState(!0),[I,qe]=r.useState(!1),[ce,Pe]=r.useState(""),[ue,J]=r.useState({}),[p,me]=r.useState(0),R=r.useRef(0),_=r.useRef(null),H=a==="courses"?"Cursos":"Treinamentos",O=a==="courses"?"/contents/courses":"/contents/trainings";r.useEffect(()=>{(async()=>{if(!l||!a){T("Conteúdo inválido."),j(!1);return}if(a!=="courses"&&a!=="trainings"){T("Tipo de conteúdo inválido."),j(!1);return}j(!0),T(null);try{if(z&&L.length){const{data:u,error:Le}=await h.from("content_package_items").select("id").in("package_id",L).eq("content_id",l).maybeSingle();if(Le)throw Le;if(!u){T("Conteúdo não liberado para sua clínica."),j(!1);return}}const t=a==="courses"?"course":"training",{data:n,error:o}=await h.from("content_items").select("id, title, description, thumbnail_url").eq("id",l).eq("type",t).maybeSingle();if(o)throw o;be(n||null);const{data:x,error:g}=await h.from("content_modules").select("id, title, order_index").eq("content_id",l).order("order_index",{ascending:!0});if(g)throw g;const b=x||[];if(!b.length){X([]),j(!1);return}const i=b.map(u=>u.id),{data:We,error:Ee}=await h.from("content_lessons").select("id, module_id, title, description, panda_video_id, panda_video_url, order_index").in("module_id",i).order("order_index",{ascending:!0});if(Ee)throw Ee;const Be=We||[],Q={};Be.forEach(u=>{u.module_id&&(Q[u.module_id]||(Q[u.module_id]=[]),Q[u.module_id].push(u))});const Ke=b.map(u=>({...u,lessons:Q[u.id]||[]}));X(Ke),j(!1)}catch(t){const n=t.message||"Erro inesperado ao carregar conteúdo.";T(n),be(null),X([]),j(!1)}})()},[l,a,z,L]),r.useEffect(()=>{(async()=>{if(!a||a!=="courses"&&a!=="trainings")return;const t=a==="courses"?"course":"training";try{if(z&&L.length){const{data:n,error:o}=await h.from("content_package_items").select("content_items (id, title, thumbnail_url, created_at, type, published)").in("package_id",L);if(o)throw o;const x=new Map;(n||[]).forEach(b=>{const i=b.content_items;!i||i.published!==!0||i.type!==t||x.has(i.id)||x.set(i.id,{id:i.id,title:i.title,thumbnail_url:i.thumbnail_url,created_at:i.created_at})});const g=Array.from(x.values()).sort((b,i)=>(i.created_at||"").localeCompare(b.created_at||""));Z(g)}else{const{data:n,error:o}=await h.from("content_items").select("id, title, thumbnail_url, created_at").eq("type",t).eq("published",!0).order("created_at",{ascending:!1});if(o)throw o;Z(n||[])}}catch{Z([])}})()},[a,z,L]);const S=r.useMemo(()=>d?`lesson-notes:${d}`:null,[d]),A=r.useMemo(()=>d?`lesson-video-progress:${d}`:null,[d]),C=r.useCallback(s=>{if(!A||typeof window>"u")return;const t=Math.max(0,Math.floor(s));if(t!==R.current){R.current=t;try{window.localStorage.setItem(A,String(t))}catch{}}},[A]),f=r.useCallback(()=>{_.current&&C(_.current.currentTime||0)},[C]);r.useEffect(()=>{if(!S){M(""),w(""),N(!1);return}if(!(typeof window>"u"))try{const t=window.localStorage.getItem(S)||"";M(t),w(t),N(t.length===0)}catch{M(""),w(""),N(!0)}},[S]),r.useEffect(()=>{if(!A){me(0),R.current=0;return}if(!(typeof window>"u"))try{const s=window.localStorage.getItem(A),t=s?Number(s):0,n=Number.isFinite(t)?t:0;me(n),R.current=0}catch{me(0),R.current=0}},[A]),r.useEffect(()=>{if(typeof window>"u")return;const s=t=>{if(!t.origin.includes("pandavideo.com.br"))return;const n=he(t.data);typeof n=="number"&&Number.isFinite(n)&&C(n)};return window.addEventListener("message",s),()=>window.removeEventListener("message",s)},[C]),r.useEffect(()=>{if(_.current&&!(p<=0))try{_.current.currentTime=p}catch{}},[p]),r.useEffect(()=>{if(typeof window>"u")return;const s=()=>{document.hidden&&f()};return window.addEventListener("beforeunload",f),document.addEventListener("visibilitychange",s),()=>{window.removeEventListener("beforeunload",f),document.removeEventListener("visibilitychange",s)}},[f]),r.useEffect(()=>{(async()=>{if(!d){se([]),ne(null);return}ve(!0),ne(null);try{const{data:t,error:n}=await h.from("content_lesson_files").select("id, file_name, file_url, created_at").eq("lesson_id",d).order("created_at",{ascending:!1});if(n)throw n;se(t||[])}catch(t){ne(t.message),se([])}ve(!1)})()},[d]),r.useEffect(()=>{(async()=>{if(!l){ae([]),de(null);return}je(!0),de(null);try{let t=h.from("content_comments").select("id, content, status, created_at, student_user_id").eq("content_id",l).order("created_at",{ascending:!1});d&&(t=t.eq("lesson_id",d));const{data:n,error:o}=await t;if(o)throw o;ae(n||[])}catch(t){de(t.message),ae([])}je(!1)})()},[l,d]),r.useEffect(()=>{if(!c.length){J({});return}J(s=>{const t={};return c.forEach(n=>{t[n.id]=s[n.id]??!0}),t})},[c]),r.useEffect(()=>{(async()=>{const t=Array.from(new Set(P.map(n=>n.student_user_id).filter(n=>!!n)));if(!t.length){oe({});return}try{const{data:n,error:o}=await h.from("profiles").select("id, full_name").in("id",t);if(o)throw o;const x={};(n||[]).forEach(g=>{x[g.id]=g.full_name||"Usuário"}),oe(x)}catch{oe({})}})()},[P]);const m=r.useMemo(()=>{if(!d)return null;for(const s of c){const t=s.lessons.find(n=>n.id===d);if(t)return t}return null},[c,d]),F=r.useMemo(()=>[...c].sort((t,n)=>(t.order_index??0)-(n.order_index??0)).flatMap(t=>[...t.lessons].sort((n,o)=>(n.order_index??0)-(o.order_index??0))),[c]),V=r.useMemo(()=>d?F.findIndex(s=>s.id===d):-1,[F,d]),xe=V>0?F[V-1]:null,fe=V>=0&&V<F.length-1?F[V+1]:null,Ne=r.useMemo(()=>{const s=ce.trim().toLowerCase();if(!s)return c;const t=[];return c.forEach(n=>{const o=n.title?.toLowerCase()||"",x=n.lessons.filter(g=>(g.title?.toLowerCase()||"").includes(s));if(o.includes(s)){t.push(n);return}x.length&&t.push({...n,lessons:x})}),t},[c,ce]),_e=r.useMemo(()=>{const s=Object.values(ue);return s.length?s.every(Boolean):!1},[ue]),Ie=()=>{J(s=>{const t=!_e,n={};return Object.keys(s).forEach(o=>{n[o]=t}),n})},D=r.useCallback((s,t=!1)=>{f(),ye(s),v({lesson:s},{replace:t})},[f,v]),Re=r.useCallback(()=>{f(),we(s=>!s)},[f]),Se=r.useCallback(()=>{f(),we(!1)},[f]);r.useEffect(()=>{const s=c.flatMap(n=>n.lessons);if(W&&s.some(o=>o.id===W)){ye(W);return}const t=s[0];t&&D(t.id,!0)},[c,W,D]);const Oe=s=>{M(s)},Fe=()=>{if(!(!S||typeof window>"u"))try{window.localStorage.setItem(S,ee),w(ee),N(!1)}catch{w("")}},Ve=()=>{if(!(!S||typeof window>"u"))try{window.localStorage.removeItem(S),M(""),w(""),N(!1)}catch{M(""),w(""),N(!0)}},De=q.length===1?"1 arquivo":`${q.length} arquivos`,E=r.useMemo(()=>m?m.panda_video_url||(m.panda_video_id?`https://player.pandavideo.com.br/embed/?v=${m.panda_video_id}`:null):null,[m]),ge=r.useMemo(()=>Qe(E),[E]),Ue=r.useMemo(()=>ge?null:Xe(E,p),[E,ge,p]),ze=`${G?"56px":"240px"} ${I?"56px":"300px"} minmax(0,1fr)`,Ce=s=>e.jsx("section",{className:s==="grid"?"order-1 lg:order-3 bg-white border border-gray-100 rounded-xl p-4 space-y-4":"bg-white border border-gray-100 rounded-xl p-4 space-y-4 shadow-xl",children:m?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex flex-wrap items-center justify-between gap-3",children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-800",children:m.title||"Aula"}),e.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[e.jsx("button",{type:"button",onClick:()=>xe&&D(xe.id),disabled:!xe,className:"px-3 py-2 text-xs rounded-lg border border-gray-200 text-gray-600 hover:bg-gray-50 disabled:opacity-50",children:"Aula anterior"}),e.jsx("button",{type:"button",onClick:()=>fe&&D(fe.id),disabled:!fe,className:"px-3 py-2 text-xs rounded-lg border border-gray-200 text-gray-600 hover:bg-gray-50 disabled:opacity-50",children:"Próxima aula"})]})]}),E?e.jsx("div",{className:"w-full aspect-video rounded-lg overflow-hidden border border-gray-100 bg-black",children:ge?e.jsx("video",{ref:_,src:E,controls:!0,playsInline:!0,className:"w-full h-full",onLoadedMetadata:()=>{p>0&&_.current&&(_.current.currentTime=p)},onTimeUpdate:t=>C(t.currentTarget.currentTime),onPause:t=>C(t.currentTarget.currentTime),onEnded:()=>C(0)}):e.jsx("iframe",{src:Ue||E,title:m.title||"Aula",className:"w-full h-full",allow:"autoplay; fullscreen; picture-in-picture",allowFullScreen:!0},`${m.id}-${Math.floor(p)}`)}):e.jsx("div",{className:"text-sm text-gray-500",children:"Link do vídeo não informado."}),e.jsx("div",{className:"flex flex-wrap gap-2 border-b border-gray-100 pb-2",children:[{key:"description",label:"Descrição"},{key:"notes",label:"Anotações"},{key:"comments",label:"Comentários"},{key:"files",label:`Arquivos • ${De}`}].map(t=>e.jsx("button",{type:"button",onClick:()=>Me(t.key),className:`px-3 py-2 text-sm rounded-lg border ${$===t.key?"bg-brand-600 text-white border-brand-600":"bg-white text-gray-700 border-gray-200"}`,children:t.label},t.key))}),e.jsxs("div",{className:"pt-2",children:[$==="description"&&e.jsx("div",{className:"space-y-2 text-sm text-gray-600",children:m.description?e.jsx("p",{children:m.description}):k?.description?e.jsx("p",{children:k?.description}):e.jsx("p",{children:"Sem descrição disponível."})}),$==="notes"&&e.jsxs("div",{className:"space-y-2",children:[e.jsx("textarea",{value:ee,onChange:t=>Oe(t.target.value),placeholder:"Escreva suas anotações aqui...",rows:5,readOnly:!te,className:`w-full px-3 py-2 border rounded-lg text-sm ${te?"border-gray-300":"border-gray-200 bg-gray-50"}`}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsx("button",{type:"button",onClick:Fe,disabled:!te,className:"px-3 py-2 text-xs rounded-lg bg-brand-600 text-white disabled:opacity-50",children:"Gravar"}),e.jsx("button",{type:"button",onClick:()=>N(!0),className:"px-3 py-2 text-xs rounded-lg border border-gray-200 text-gray-600 hover:bg-gray-50",children:"Editar"}),e.jsx("button",{type:"button",onClick:Ve,className:"px-3 py-2 text-xs rounded-lg border border-red-200 text-red-600 hover:bg-red-50",children:"Apagar"})]}),e.jsx("p",{className:"text-xs text-gray-400",children:Ae?"Anotação salva neste navegador.":"Nenhuma anotação salva."})]}),$==="comments"&&e.jsxs("div",{className:"space-y-3 text-sm text-gray-600",children:[K&&e.jsx("p",{children:"Carregando comentários..."}),!K&&le&&e.jsx("p",{children:"Comentários indisponíveis no momento."}),!K&&!le&&P.length===0&&e.jsx("p",{children:"Nenhum comentário."}),!K&&!le&&P.length>0&&e.jsx("div",{className:"space-y-3",children:P.map(t=>e.jsxs("div",{className:"border border-gray-100 rounded-lg p-3",children:[e.jsxs("p",{className:"text-xs text-gray-400",children:[Te[t.student_user_id||""]||"Usuário"," •"," ",t.created_at?.slice(0,10)||"Sem data"]}),e.jsx("p",{className:"text-sm text-gray-700 mt-1",children:t.content||"Sem conteúdo."})]},t.id))})]}),$==="files"&&e.jsxs("div",{className:"space-y-2 text-sm text-gray-600",children:[B&&e.jsx("p",{children:"Carregando arquivos..."}),!B&&re&&e.jsx("p",{children:"Arquivos indisponíveis no momento."}),!B&&!re&&q.length===0&&e.jsx("p",{children:"Nenhum arquivo disponível."}),!B&&!re&&q.length>0&&e.jsx("div",{className:"space-y-2",children:q.map(t=>e.jsxs("a",{href:t.file_url||"#",target:"_blank",rel:"noreferrer",className:"flex items-center justify-between border border-gray-100 rounded-lg p-3 hover:bg-gray-50",children:[e.jsx("span",{children:t.file_name||"Arquivo"}),e.jsx("span",{className:"text-xs text-gray-400",children:"Abrir"})]},t.id))})]})]})]}):e.jsx("div",{className:"text-sm text-gray-500",children:"Selecione uma aula para começar."})});return ke?e.jsx("div",{className:"h-48 flex items-center justify-center text-gray-500",children:"Carregando conteúdo..."}):pe?e.jsxs("div",{className:"space-y-3",children:[e.jsx("h1",{className:"text-xl font-semibold text-gray-800",children:"Erro ao carregar conteúdo"}),e.jsx("p",{className:"text-sm text-gray-500",children:pe}),e.jsxs(U,{className:"text-brand-600 hover:underline",to:O,children:["Voltar para ",H]})]}):k?e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex flex-wrap items-start justify-between gap-3",children:[e.jsxs("div",{children:[e.jsxs(U,{className:"text-sm text-brand-600 hover:underline",to:O,children:["← Voltar para ",H]}),e.jsx("h1",{className:"text-2xl font-bold text-gray-800 mt-2",children:k.title||"Sem título"}),k.description&&e.jsx("p",{className:"text-gray-500",children:k.description})]}),e.jsx("button",{type:"button",onClick:Re,className:"px-3 py-2 text-sm rounded-lg border border-gray-200 bg-white text-gray-700 hover:bg-gray-50",children:ie?"Acender as luzes":"Apagar as luzes"})]}),ie&&e.jsx("div",{className:"fixed inset-0 bg-black/70 z-50 overflow-y-auto",onClick:Se,children:e.jsx("div",{className:"min-h-full flex items-center justify-center p-4",children:e.jsxs("div",{className:"w-full max-w-5xl",onClick:s=>s.stopPropagation(),children:[e.jsx("div",{className:"flex justify-end pb-2",children:e.jsx("button",{type:"button",onClick:Se,className:"px-3 py-2 text-sm rounded-lg border border-gray-200 bg-white text-gray-700 hover:bg-gray-50",children:"Acender as luzes"})}),Ce("modal")]})})}),e.jsxs("div",{className:"grid grid-cols-1 gap-4 lg:[grid-template-columns:var(--content-grid)]",style:{"--content-grid":ze},children:[e.jsxs("aside",{className:"order-2 lg:order-1 bg-white border border-gray-100 rounded-xl p-3 space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[!G&&e.jsxs("p",{className:"text-sm font-semibold text-gray-700",children:["Outros ",H]}),e.jsx("button",{type:"button",onClick:()=>$e(s=>!s),className:"ml-auto text-xs px-2 py-1 border border-gray-200 rounded-lg text-gray-600 hover:bg-gray-50",children:G?"Abrir":"Recolher"})]}),G?e.jsxs("div",{className:"flex flex-col items-center gap-2 py-2",children:[e.jsx("div",{className:"text-xs text-gray-400",children:"Cursos"}),Y.slice(0,3).map(s=>e.jsx(U,{to:`${O}/${s.id}`,className:"w-10 h-10 rounded-md border border-gray-100 overflow-hidden",children:s.thumbnail_url?e.jsx("img",{src:s.thumbnail_url,alt:s.title||"Conteúdo",className:"w-full h-full object-cover"}):e.jsx("div",{className:"w-full h-full bg-gray-100"})},s.id))]}):Y.length===0?e.jsx("p",{className:"text-sm text-gray-500",children:"Nenhum conteúdo publicado."}):e.jsx("div",{className:"space-y-2",children:Y.map(s=>{const t=s.id===l;return e.jsxs(U,{to:`${O}/${s.id}`,className:`flex gap-3 items-center border rounded-lg p-2 transition ${t?"border-brand-200 bg-brand-50 text-brand-700":"border-gray-100 hover:bg-gray-50 text-gray-700"}`,children:[s.thumbnail_url?e.jsx("img",{src:s.thumbnail_url,alt:s.title||"Conteúdo",className:"w-12 h-12 rounded-md object-cover"}):e.jsx("div",{className:"w-12 h-12 rounded-md bg-gray-100"}),e.jsx("div",{className:"text-sm font-medium line-clamp-2",children:s.title||"Sem título"})]},s.id)})})]}),e.jsxs("aside",{className:"order-3 lg:order-2 bg-white border border-gray-100 rounded-xl p-3 space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[!I&&e.jsx("p",{className:"text-sm font-semibold text-gray-700",children:"Módulos"}),e.jsxs("div",{className:"flex items-center gap-2 ml-auto",children:[!I&&e.jsx("button",{type:"button",onClick:Ie,className:"text-xs px-2 py-1 border border-gray-200 rounded-lg text-gray-600 hover:bg-gray-50",children:_e?"Recolher tudo":"Abrir tudo"}),e.jsx("button",{type:"button",onClick:()=>qe(s=>!s),className:"text-xs px-2 py-1 border border-gray-200 rounded-lg text-gray-600 hover:bg-gray-50",children:I?"Abrir":"Recolher"})]})]}),I?e.jsx("div",{className:"flex flex-col items-center gap-2 py-2 text-xs text-gray-400",children:"Módulos"}):e.jsxs(e.Fragment,{children:[e.jsx("input",{value:ce,onChange:s=>Pe(s.target.value),placeholder:"Buscar tema...",className:"w-full px-2 py-2 text-sm border border-gray-300 rounded-lg"}),Ne.length===0?e.jsx("p",{className:"text-sm text-gray-500",children:"Nenhuma aula publicada."}):e.jsx("div",{className:"space-y-2",children:Ne.map(s=>e.jsxs("details",{open:ue[s.id],onToggle:t=>{const n=t.currentTarget?.open??!1;J(o=>({...o,[s.id]:n}))},className:"border border-gray-100 rounded-lg p-3",children:[e.jsx("summary",{className:"text-sm font-medium text-gray-700 cursor-pointer",children:s.title||"Sem módulo"}),e.jsxs("div",{className:"mt-2 space-y-1",children:[s.lessons.length===0&&e.jsx("p",{className:"text-xs text-gray-500",children:"Sem aulas neste módulo."}),s.lessons.map(t=>e.jsx("button",{type:"button",onClick:()=>{D(t.id)},className:`w-full text-left text-sm px-2 py-1 rounded-md ${d===t.id?"bg-brand-50 text-brand-700":"text-gray-600 hover:bg-gray-50"}`,children:t.title||"Aula sem título"},t.id))]})]},s.id))})]})]}),!ie&&Ce("grid")]})]}):e.jsxs("div",{className:"space-y-3",children:[e.jsx("h1",{className:"text-xl font-semibold text-gray-800",children:"Conteúdo não encontrado"}),e.jsxs(U,{className:"text-brand-600 hover:underline",to:O,children:["Voltar para ",H]})]})};export{tt as default};
