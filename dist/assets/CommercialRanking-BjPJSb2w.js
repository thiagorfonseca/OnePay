import{u as K,r as n,j as e}from"./index-Bi_Yktdj.js";import{f as Y,b as B}from"./commercial-DwIyj_SI.js";import{f}from"./utils-Bgz2xRk4.js";import{C as V}from"./calendar-9FKwlTHs.js";import{D as R}from"./download-GFpxFQdG.js";import{L as _}from"./loader-2-wegoqaf-.js";import{A as G}from"./arrow-up-down-CjckQ9lV.js";const D=o=>o.toISOString().slice(0,10),z=o=>{const p=new Date,r=new Date;switch(o){case"quinzenal":r.setDate(r.getDate()-15);break;case"mensal":r.setMonth(r.getMonth()-1);break;case"trimestral":r.setMonth(r.getMonth()-3);break;case"semestral":r.setMonth(r.getMonth()-6);break;case"anual":r.setFullYear(r.getFullYear()-1);break}return{from:D(r),to:D(p)}},x=o=>`"${String(o).replace(/"/g,'""')}"`,se=()=>{const{clinicId:o,isAdmin:p,selectedClinicId:r}=K(),[$,b]=n.useState(!0),[i,A]=n.useState("faturamento"),[j,v]=n.useState("desc"),[l,M]=n.useState([]),[h,P]=n.useState(""),[g,F]=n.useState(""),[E,C]=n.useState("mensal"),[{from:c,to:d},N]=n.useState(()=>z("mensal"));n.useEffect(()=>{(async()=>{if(!o&&!p)return;b(!0);const s=await Y({clinicId:p?r||void 0:o,from:c||void 0,to:d||void 0});M(B(s)),b(!1)})()},[o,p,r,c,d]);const L=n.useMemo(()=>{const t=new Set;return l.forEach(s=>{(s.categorias||[]).forEach(a=>{a&&t.add(a)})}),Array.from(t).sort((s,a)=>s.localeCompare(a))},[l]),O=n.useMemo(()=>{const t=new Set;return l.forEach(s=>{(s.procedimentos||[]).forEach(a=>{a&&t.add(a)})}),Array.from(t).sort((s,a)=>s.localeCompare(a))},[l]),k=n.useMemo(()=>l.filter(t=>!(h&&!(t.categorias||[]).includes(h)||g&&!(t.procedimentos||[]).includes(g))),[l,h,g]),u=n.useMemo(()=>{const t=j==="asc"?1:-1;return[...k].sort((s,a)=>s[i]<a[i]?-1*t:s[i]>a[i]?1*t:0)},[k,i,j]),T=t=>{i===t?v(s=>s==="asc"?"desc":"asc"):(A(t),v("desc"))},U=t=>{C(t),t!=="personalizado"&&N(z(t))},S=(t,s)=>{C("personalizado"),N({from:t,to:s})},I=()=>{const t=["Cliente","Faturamento","Atendimentos","Ticket médio","Recorrência","Qtd procedimentos"],s=u.map(m=>[x(m.name),x((m.faturamento||0).toFixed(2)),x(m.atendimentos||0),x((m.ticket||0).toFixed(2)),x(m.recorrencia||0),x(m.procedimentosCount||0)].join(",")),a=[t.join(","),...s].join(`
`),q=new Blob([a],{type:"text/csv;charset=utf-8;"}),w=URL.createObjectURL(q),y=document.createElement("a");y.href=w,y.download=`ranking-clientes-${c||"inicio"}-${d||"fim"}.csv`,y.click(),URL.revokeObjectURL(w)},Q=()=>{const t=u.map(a=>`<tr>
      <td>${a.name}</td>
      <td>${f(a.faturamento||0)}</td>
      <td>${a.atendimentos}</td>
      <td>${f(a.ticket||0)}</td>
      <td>${a.recorrencia}</td>
      <td>${a.procedimentosCount}</td>
    </tr>`).join(""),s=window.open("","_blank");s&&(s.document.write(`
      <html><head><title>Ranking de Clientes</title>
      <style>table{border-collapse:collapse;width:100%;font-family:Arial;}th,td{border:1px solid #ddd;padding:6px;font-size:12px;}th{background:#f3f4f6;text-align:left;}</style>
      </head><body>
      <h3>Ranking de Clientes (${c||"início"} a ${d||"fim"})</h3>
      <table><thead><tr><th>Cliente</th><th>Faturamento</th><th>Atendimentos</th><th>Ticket médio</th><th>Recorrência</th><th>Qtd procedimentos</th></tr></thead>
      <tbody>${t}</tbody>
      </table>
      </body></html>
    `),s.document.close(),s.print())};return e.jsxs("div",{className:"space-y-4",children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-800",children:"Comercial • Ranking dos Clientes"}),e.jsx("p",{className:"text-gray-500",children:"Ranking analítico por faturamento, ticket e recorrência."}),e.jsxs("div",{className:"bg-white border border-gray-100 rounded-xl shadow-sm overflow-hidden",children:[e.jsxs("div",{className:"px-4 py-3 border-b border-gray-100 flex items-center gap-2 text-sm text-gray-600",children:["Clinic: ",o||"—"]}),e.jsxs("div",{className:"px-4 py-3 border-b border-gray-100 flex flex-wrap items-center gap-3 text-sm",children:[e.jsxs("div",{className:"flex items-center gap-2 px-3 py-2 border border-gray-200 rounded-lg text-sm bg-white",children:[e.jsx(V,{size:16})," Período:",e.jsxs("select",{value:E,onChange:t=>U(t.target.value),className:"text-sm bg-transparent focus:outline-none",children:[e.jsx("option",{value:"quinzenal",children:"Últimos 15 dias"}),e.jsx("option",{value:"mensal",children:"Últimos 30 dias"}),e.jsx("option",{value:"trimestral",children:"Últimos 3 meses"}),e.jsx("option",{value:"semestral",children:"Últimos 6 meses"}),e.jsx("option",{value:"anual",children:"Últimos 12 meses"}),e.jsx("option",{value:"personalizado",children:"Personalizado"})]})]}),e.jsxs("label",{className:"flex items-center gap-2 text-gray-600",children:[e.jsx("span",{children:"De"}),e.jsx("input",{type:"date",value:c,onChange:t=>S(t.target.value,d),className:"px-3 py-2 border border-gray-200 rounded-lg bg-white text-gray-700"})]}),e.jsxs("label",{className:"flex items-center gap-2 text-gray-600",children:[e.jsx("span",{children:"Até"}),e.jsx("input",{type:"date",value:d,onChange:t=>S(c,t.target.value),className:"px-3 py-2 border border-gray-200 rounded-lg bg-white text-gray-700"})]}),e.jsxs("label",{className:"flex items-center gap-2 text-gray-600",children:[e.jsx("span",{children:"Categorias:"}),e.jsxs("select",{value:h,onChange:t=>P(t.target.value),className:"px-3 py-2 border border-gray-200 rounded-lg bg-white text-gray-700",children:[e.jsx("option",{value:"",children:"Todas"}),L.map(t=>e.jsx("option",{value:t,children:t},t))]})]}),e.jsxs("label",{className:"flex items-center gap-2 text-gray-600",children:[e.jsx("span",{children:"Procedimentos:"}),e.jsxs("select",{value:g,onChange:t=>F(t.target.value),className:"px-3 py-2 border border-gray-200 rounded-lg bg-white text-gray-700",children:[e.jsx("option",{value:"",children:"Todos"}),O.map(t=>e.jsx("option",{value:t,children:t},t))]})]}),e.jsxs("button",{onClick:Q,className:"flex items-center gap-2 px-3 py-2 text-sm border rounded-lg text-gray-700 hover:bg-gray-50",children:[e.jsx(R,{size:14})," PDF"]}),e.jsxs("button",{onClick:I,className:"flex items-center gap-2 px-3 py-2 text-sm border rounded-lg text-gray-700 hover:bg-gray-50",children:[e.jsx(R,{size:14})," CSV"]})]}),$?e.jsxs("div",{className:"h-64 flex items-center justify-center text-gray-500",children:[e.jsx(_,{className:"animate-spin mr-2",size:20})," Carregando..."]}):e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full text-sm",children:[e.jsx("thead",{className:"bg-gray-50 border-b border-gray-100 text-gray-600",children:e.jsx("tr",{children:[["name","Cliente"],["faturamento","Faturamento"],["atendimentos","Atendimentos"],["ticket","Ticket médio"],["recorrencia","Recorrência (datas)"],["procedimentosCount","Qtd. procedimentos"]].map(([t,s])=>e.jsx("th",{className:"px-4 py-3 text-left",children:e.jsxs("button",{onClick:()=>T(t),className:"inline-flex items-center gap-1 text-gray-700 hover:text-brand-600",children:[s," ",e.jsx(G,{size:14})]})},t))})}),e.jsxs("tbody",{className:"divide-y divide-gray-100",children:[u.map((t,s)=>e.jsxs("tr",{className:"hover:bg-gray-50",children:[e.jsx("td",{className:"px-4 py-2 font-semibold text-gray-800",children:t.name}),e.jsx("td",{className:"px-4 py-2 text-gray-800",children:f(t.faturamento||0)}),e.jsx("td",{className:"px-4 py-2 text-gray-700",children:t.atendimentos}),e.jsx("td",{className:"px-4 py-2 text-gray-700",children:f(t.ticket||0)}),e.jsx("td",{className:"px-4 py-2 text-gray-700",children:t.recorrencia}),e.jsx("td",{className:"px-4 py-2 text-gray-700",children:t.procedimentosCount})]},s)),u.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:6,className:"px-4 py-6 text-center text-gray-400",children:"Sem dados para a clínica."})})]})]})})]})]})};export{se as default};
