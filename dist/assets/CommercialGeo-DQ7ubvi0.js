import{c as te,u as ae,r as s,j as e}from"./index-Bi_Yktdj.js";import{f as ne}from"./commercial-DwIyj_SI.js";import{f as T}from"./utils-Bgz2xRk4.js";import{C as se}from"./calendar-9FKwlTHs.js";import{L as re}from"./loader-2-wegoqaf-.js";const oe=te("MapPin",[["path",{d:"M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z",key:"2oe9fu"}],["circle",{cx:"12",cy:"10",r:"3",key:"ilqhr7"}]]),Y="onefincGeoCache";let k=null;const U=()=>typeof window>"u"?Promise.reject(new Error("window indisponivel")):window.L?Promise.resolve(window.L):k||(k=new Promise((l,i)=>{if(!document.querySelector("link[data-leaflet]")){const r=document.createElement("link");r.rel="stylesheet",r.href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css",r.setAttribute("data-leaflet","true"),document.head.appendChild(r)}const m=document.querySelector("script[data-leaflet]");if(m){m.addEventListener("load",()=>l(window.L)),m.addEventListener("error",()=>i(new Error("Falha ao carregar Leaflet.")));return}const c=document.createElement("script");c.src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js",c.async=!0,c.setAttribute("data-leaflet","true"),c.onload=()=>l(window.L),c.onerror=()=>i(new Error("Falha ao carregar Leaflet.")),document.body.appendChild(c)}),k),V=l=>l.toISOString().slice(0,10),$=l=>{const i=new Date,n=new Date;switch(l){case"quinzenal":n.setDate(n.getDate()-15);break;case"mensal":n.setMonth(n.getMonth()-1);break;case"trimestral":n.setMonth(n.getMonth()-3);break;case"semestral":n.setMonth(n.getMonth()-6);break;case"anual":n.setFullYear(n.getFullYear()-1);break}return{from:V(n),to:V(i)}},A=l=>l.replace(/\D/g,""),le=async(l,i)=>{const n=A(l);if(n.length<5)return null;if(i.current[n])return i.current[n];const m=`https://nominatim.openstreetmap.org/search?postalcode=${encodeURIComponent(n)}&country=Brazil&format=json&limit=1`;try{const c=await fetch(m,{headers:{"Accept-Language":"pt-BR"}});if(!c.ok)return null;const r=await c.json();if(!r||!r[0])return null;const b={lat:parseFloat(r[0].lat),lng:parseFloat(r[0].lon)};return i.current[n]=b,typeof window<"u"&&window.localStorage.setItem(Y,JSON.stringify(i.current)),b}catch{return null}},pe=()=>{const{effectiveClinicId:l,isAdmin:i,selectedClinicId:n}=ae(),[m,c]=s.useState(!0),[r,b]=s.useState([]),[g,S]=s.useState(null),[_,B]=s.useState("mensal"),[{from:j,to:w},D]=s.useState(()=>$("mensal")),[x,J]=s.useState(10),[E,Z]=s.useState(!0),[M,H]=s.useState(!0),[z,K]=s.useState(!0),[L,Q]=s.useState(!1),[F,W]=s.useState(!1),f=s.useRef(null),v=s.useRef(null),P=s.useRef(null),R=s.useRef({});s.useEffect(()=>{if(!(typeof window>"u"))try{const t=window.localStorage.getItem(Y);t&&(R.current=JSON.parse(t))}catch{R.current={}}},[]);const X=t=>{B(t),t!=="personalizado"&&D($(t))},I=(t,o)=>{B("personalizado"),D({from:t,to:o})};s.useEffect(()=>{(async()=>{if(!(!l&&!i)){c(!0),S(null);try{const o=await ne({clinicId:i?n||void 0:l||void 0,from:j||void 0,to:w||void 0}),h=a=>a.trim().toLowerCase(),d=new Map;o.revenues.forEach(a=>{const p=(a.paciente||"Sem nome").trim()||"Sem nome",y=h(p),G=d.get(y)||{total:0,atendimentos:0},O=Number(a.valor_liquido??a.valor??0);d.set(y,{total:G.total+(isFinite(O)?O:0),atendimentos:G.atendimentos+1})});const N=o.customers.filter(a=>a.name&&a.cep).map(a=>{const p=h(a.name||""),y=d.get(p)||{total:0,atendimentos:0};return{name:a.name||"Sem nome",cep:a.cep||"",total:y.total,atendimentos:y.atendimentos}}).filter(a=>a.cep),C=Array.from(new Set(N.map(a=>A(a.cep)).filter(Boolean))),u=new Map;for(const a of C){const p=await le(a,R);p&&u.set(a,p)}const ee=N.map(a=>{const p=u.get(A(a.cep));return p?{name:a.name,cep:a.cep,lat:p.lat,lng:p.lng,total:a.total,atendimentos:a.atendimentos}:null}).filter(Boolean);b(ee)}catch(o){S(o.message||"Erro ao carregar dados do mapa.")}finally{c(!1)}}})()},[l,i,n,j,w]),s.useEffect(()=>{if(m||g)return;let t=!0;return U().then(o=>{!t||!P.current||(f.current||(f.current=o.map(P.current,{zoomControl:!0}),o.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:"&copy; OpenStreetMap contributors",maxZoom:18}).addTo(f.current),v.current=o.layerGroup().addTo(f.current)),f.current.invalidateSize(),W(!0))}).catch(()=>{S("Não foi possível carregar o mapa.")}),()=>{t=!1}},[m,g]);const q=s.useMemo(()=>{const t=r.reduce((o,h)=>Math.max(o,h.total),0);return t>0?t:1},[r]);return s.useEffect(()=>{let t=!0;if(F)return U().then(o=>{if(!t||!f.current||!v.current)return;v.current.clearLayers();const h=[];r.forEach(d=>{const N=E?x+d.total/q*x:x,C=o.circleMarker([d.lat,d.lng],{radius:N,color:"#0284c7",fillColor:"#38bdf8",fillOpacity:.75,weight:1});let u="";M&&(u+=`<strong>${d.name}</strong>`),z&&(u+=`${u?"<br/>":""}Consumo: ${T(d.total)}`),L&&(u+=`${u?"<br/>":""}Atendimentos: ${d.atendimentos}`),u&&C.bindTooltip(u,{direction:"top",opacity:.9,sticky:!0}),C.addTo(v.current),h.push([d.lat,d.lng])}),h.length?f.current.fitBounds(h,{padding:[40,40]}):f.current.setView([-14.235,-51.925],4)}),()=>{t=!1}},[r,x,E,M,z,L,q,F]),e.jsxs("div",{className:"space-y-4",children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-800",children:"Comercial • Geolocalizacao"}),e.jsx("p",{className:"text-gray-500",children:"Clientes destacados por CEP, com consumo e recorrencia no periodo."}),e.jsxs("div",{className:"bg-white border border-gray-100 rounded-xl shadow-sm p-4 space-y-3",children:[e.jsxs("div",{className:"flex flex-wrap items-center gap-3 text-sm",children:[e.jsxs("div",{className:"flex items-center gap-2 px-3 py-2 border border-gray-200 rounded-lg text-sm bg-white",children:[e.jsx(se,{size:16})," Periodo:",e.jsxs("select",{value:_,onChange:t=>X(t.target.value),className:"text-sm bg-transparent focus:outline-none",children:[e.jsx("option",{value:"quinzenal",children:"Ultimos 15 dias"}),e.jsx("option",{value:"mensal",children:"Ultimos 30 dias"}),e.jsx("option",{value:"trimestral",children:"Ultimos 3 meses"}),e.jsx("option",{value:"semestral",children:"Ultimos 6 meses"}),e.jsx("option",{value:"anual",children:"Ultimos 12 meses"}),e.jsx("option",{value:"personalizado",children:"Personalizado"})]})]}),e.jsxs("label",{className:"flex items-center gap-2 text-gray-600",children:[e.jsx("span",{children:"De"}),e.jsx("input",{type:"date",value:j,onChange:t=>I(t.target.value,w),className:"px-3 py-2 border border-gray-200 rounded-lg bg-white text-gray-700"})]}),e.jsxs("label",{className:"flex items-center gap-2 text-gray-600",children:[e.jsx("span",{children:"Ate"}),e.jsx("input",{type:"date",value:w,onChange:t=>I(j,t.target.value),className:"px-3 py-2 border border-gray-200 rounded-lg bg-white text-gray-700"})]})]}),e.jsxs("div",{className:"flex flex-wrap items-center gap-4 text-sm text-gray-600",children:[e.jsxs("label",{className:"flex items-center gap-2",children:[e.jsx("span",{children:"Tamanho"}),e.jsx("input",{type:"range",min:6,max:20,value:x,onChange:t=>J(Number(t.target.value))})]}),e.jsxs("label",{className:"inline-flex items-center gap-2",children:[e.jsx("input",{type:"checkbox",checked:E,onChange:t=>Z(t.target.checked)}),"Tamanho por valor"]}),e.jsxs("label",{className:"inline-flex items-center gap-2",children:[e.jsx("input",{type:"checkbox",checked:M,onChange:t=>H(t.target.checked)}),"Mostrar nomes"]}),e.jsxs("label",{className:"inline-flex items-center gap-2",children:[e.jsx("input",{type:"checkbox",checked:z,onChange:t=>K(t.target.checked)}),"Mostrar consumo"]}),e.jsxs("label",{className:"inline-flex items-center gap-2",children:[e.jsx("input",{type:"checkbox",checked:L,onChange:t=>Q(t.target.checked)}),"Mostrar atendimentos"]})]})]}),e.jsxs("div",{className:"bg-white border border-gray-100 rounded-xl p-4",children:[e.jsx("p",{className:"font-semibold text-gray-800 mb-2",children:"Mapa"}),e.jsxs("div",{className:"relative h-96 rounded-lg overflow-hidden border",children:[e.jsx("div",{className:"h-full",ref:P}),m&&e.jsxs("div",{className:"absolute inset-0 bg-white/70 flex items-center justify-center text-gray-500",children:[e.jsx(re,{className:"animate-spin mr-2",size:20})," Geocodificando..."]}),g&&!m&&e.jsx("div",{className:"absolute inset-0 bg-white/80 flex items-center justify-center text-sm text-red-600",children:g})]})]}),e.jsxs("div",{className:"bg-white border border-gray-100 rounded-xl p-4",children:[e.jsx("p",{className:"font-semibold text-gray-800 mb-3",children:"Clientes georreferenciados"}),e.jsxs("div",{className:"space-y-2",children:[r.map((t,o)=>e.jsxs("div",{className:"flex items-center justify-between text-sm text-gray-700",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(oe,{size:16,className:"text-brand-600"}),e.jsxs("span",{children:[t.name," • CEP ",t.cep]})]}),e.jsxs("div",{className:"text-xs text-gray-500",children:[T(t.total)," • ",t.atendimentos," atend."]})]},o)),r.length===0&&!m&&!g&&e.jsx("p",{className:"text-gray-400 text-sm",children:"Nenhum CEP valido encontrado no periodo."})]})]})]})};export{pe as default};
