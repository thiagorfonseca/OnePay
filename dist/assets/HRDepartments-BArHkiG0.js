import{u as O,r,j as e,f as F,s as h}from"./index-HcuLVkXM.js";import{b as P}from"./utils-C6qNh0Lg.js";import{u as B}from"./useModalControls-BiWM_r1l.js";import{P as H}from"./plus-DDz1DOCh.js";import{S as J}from"./search-C1xIXvIu.js";const K=({options:d,value:n,onChange:g,placeholder:w="Selecione"})=>{const[b,x]=r.useState(!1),y=r.useRef(null),m=d.filter(a=>n.includes(a.value));return r.useEffect(()=>{const a=l=>{y.current&&(y.current.contains(l.target)||x(!1))};return document.addEventListener("mousedown",a),()=>document.removeEventListener("mousedown",a)},[]),e.jsxs("div",{className:"relative",ref:y,children:[e.jsxs("button",{type:"button",onClick:()=>x(a=>!a),className:"w-full px-3 py-2 border border-gray-300 rounded-lg text-left bg-white focus:ring-brand-500 outline-none",children:[m.length===0&&e.jsx("span",{className:"text-gray-400",children:w}),m.length>0&&e.jsxs("span",{className:"text-gray-700",children:[m.slice(0,2).map(a=>a.label).join(", "),m.length>2?` +${m.length-2}`:""]})]}),b&&e.jsxs("div",{className:"absolute z-20 mt-2 w-full max-h-64 overflow-auto rounded-xl border border-gray-200 bg-white shadow-lg",children:[d.map(a=>{const l=n.includes(a.value);return e.jsxs("label",{className:"flex items-center gap-2 px-3 py-2 text-sm hover:bg-gray-50 cursor-pointer",children:[e.jsx("input",{type:"checkbox",checked:l,onChange:f=>{f.target.checked?g([...n,a.value]):g(n.filter(N=>N!==a.value))}}),e.jsx("span",{className:"text-gray-700",children:a.label})]},a.value)}),d.length===0&&e.jsx("p",{className:"px-3 py-3 text-sm text-gray-400",children:"Nenhum departamento disponível."})]})]})},W=()=>{const{effectiveClinicId:d}=O(),[n,g]=r.useState([]),[w,b]=r.useState(!0),[x,y]=r.useState(""),[m,a]=r.useState(!1),[l,f]=r.useState(null),[N,S]=r.useState(!1),[k,c]=r.useState(null),[v,j]=r.useState({name:"",affiliates:[]}),E=()=>{a(!1),f(null),c(null)},M=B({isOpen:m,onClose:E}),z=t=>t.normalize("NFKD").replace(/[\u0300-\u036f]/g,"").replace(/\s+/g," ").trim().toLowerCase(),_=async()=>{if(!d){g([]),b(!1);return}b(!0);const{data:t,error:s}=await h.from("hr_departments").select(`
        id,
        name,
        created_at,
        affiliates:hr_department_affiliations!hr_department_affiliations_department_id_fkey (
          affiliated_department_id,
          affiliated:hr_departments!hr_department_affiliations_affiliated_department_id_fkey (id, name)
        )
      `).eq("clinic_id",d).order("created_at",{ascending:!1});!s&&t&&g(t),b(!1)};r.useEffect(()=>{_()},[d]);const I=r.useMemo(()=>n.map(t=>({value:t.id,label:t.name})),[n]),C=r.useMemo(()=>{if(!x.trim())return n;const t=x.toLowerCase();return n.filter(s=>s.name.toLowerCase().includes(t))},[n,x]),L=()=>{f(null),c(null),j({name:"",affiliates:[]}),a(!0)},q=t=>{f(t.id),c(null);const s=(t.affiliates||[]).map(o=>o.affiliated_department_id);j({name:t.name||"",affiliates:s}),a(!0)},R=async t=>{if(t.preventDefault(),!d){c("Nenhuma clínica ativa para salvar o departamento.");return}const s=v.name.trim(),o=z(s);if(!s){c("Informe o nome do departamento.");return}if(n.find(i=>i.id!==l&&z(i.name||"")===o)){c("Já existe um departamento com esse nome.");return}S(!0),c(null);try{let i=l;if(l){const{error:p}=await h.from("hr_departments").update({name:s,name_normalized:o}).eq("id",l);if(p)throw p}else{const{data:p,error:u}=await h.from("hr_departments").insert({clinic_id:d,name:s,name_normalized:o}).select("id").maybeSingle();if(u)throw u;i=p?.id||null}if(i){await h.from("hr_department_affiliations").delete().eq("department_id",i);const p=Array.from(new Set(v.affiliates.filter(u=>u!==i)));if(p.length){const u=p.map(A=>({department_id:i,affiliated_department_id:A})),{error:D}=await h.from("hr_department_affiliations").insert(u);if(D)throw D}}a(!1),f(null),j({name:"",affiliates:[]}),_()}catch(i){i?.code==="23505"?c("Já existe um departamento com esse nome."):c(i?.message||"Erro ao salvar departamento.")}finally{S(!1)}};return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex flex-wrap items-start justify-between gap-4",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-xs uppercase tracking-[0.2em] text-brand-600 font-semibold",children:"Recursos Humanos"}),e.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:"Departamentos"}),e.jsx("p",{className:"text-sm text-gray-500",children:"Cadastre e organize os departamentos da clínica."})]}),e.jsxs("button",{type:"button",onClick:L,className:"px-4 py-2 rounded-lg bg-brand-600 text-white text-sm hover:bg-brand-700 flex items-center gap-2",children:[e.jsx(H,{size:16})," Novo departamento"]})]}),e.jsxs("div",{className:"bg-white border border-gray-100 rounded-2xl p-5 flex flex-wrap gap-3 items-center justify-between",children:[e.jsxs("div",{className:"relative flex-1 min-w-[240px]",children:[e.jsx(J,{size:16,className:"absolute left-3 top-3 text-gray-400"}),e.jsx("input",{value:x,onChange:t=>y(t.target.value),placeholder:"Buscar por departamento",className:"w-full pl-9 pr-3 py-2 border border-gray-200 rounded-lg text-sm focus:ring-brand-500 outline-none"})]}),e.jsxs("div",{className:"flex items-center gap-2 text-sm text-gray-500",children:[e.jsx(F,{size:16}),C.length," registros"]})]}),e.jsxs("div",{className:"bg-white border border-gray-100 rounded-2xl overflow-hidden",children:[e.jsxs("div",{className:"px-6 py-4 border-b border-gray-100 flex items-center justify-between",children:[e.jsx("p",{className:"text-sm font-semibold text-gray-800",children:"Lista de departamentos"}),e.jsx("span",{className:"text-xs text-gray-400",children:"Organize por equipe e área"})]}),w?e.jsx("div",{className:"px-6 py-12 text-center text-sm text-gray-500",children:"Carregando departamentos..."}):e.jsxs("div",{className:"divide-y divide-gray-100",children:[C.map((t,s)=>e.jsxs("div",{className:"px-6 py-4 flex flex-wrap items-center gap-4 hover:bg-gray-50",children:[e.jsxs("div",{className:"w-10 text-sm text-gray-400",children:["#",String(s+1).padStart(2,"0")]}),e.jsxs("div",{className:"flex-1 min-w-[200px]",children:[e.jsx("p",{className:"text-sm font-semibold text-gray-900",children:t.name}),e.jsxs("p",{className:"text-xs text-gray-500",children:["Criado em ",P(t.created_at||"")]})]}),e.jsxs("div",{className:"min-w-[240px]",children:[e.jsx("p",{className:"text-xs text-gray-400 mb-1",children:"Departamentos afiliados"}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[(t.affiliates||[]).map(o=>e.jsx("span",{className:"px-3 py-1 text-xs rounded-full bg-gray-100 text-gray-600",children:o.affiliated?.name||"Departamento"},o.affiliated_department_id)),(t.affiliates||[]).length===0&&e.jsx("span",{className:"text-xs text-gray-400",children:"Sem afiliados."})]})]}),e.jsxs("div",{className:"ml-auto flex items-center gap-2",children:[e.jsx("button",{type:"button",onClick:()=>q(t),className:"px-3 py-1 text-xs rounded-full border border-brand-100 text-brand-600",children:"Editar"}),e.jsx("button",{type:"button",onClick:async()=>{if(!confirm("Excluir departamento?"))return;const{error:o}=await h.from("hr_departments").delete().eq("id",t.id);o||_()},className:"px-3 py-1 text-xs rounded-full border border-rose-100 text-rose-600",children:"Apagar"})]})]},t.id)),C.length===0&&e.jsx("div",{className:"px-6 py-12 text-center text-sm text-gray-400",children:"Nenhum departamento cadastrado."})]})]}),m&&e.jsx("div",{className:"fixed inset-0 bg-black/40 flex items-center justify-center z-50",onClick:M.onBackdropClick,children:e.jsxs("div",{className:"bg-white rounded-2xl shadow-xl w-full max-w-lg p-6 space-y-4",onClick:t=>t.stopPropagation(),children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-800",children:l?"Editar departamento":"Novo departamento"}),e.jsx("button",{type:"button",onClick:E,className:"w-9 h-9 rounded-full bg-gray-100 flex items-center justify-center text-gray-500",children:"✕"})]}),e.jsxs("form",{onSubmit:R,className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Nome"}),e.jsx("input",{value:v.name,onChange:t=>j(s=>({...s,name:t.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-brand-500 outline-none",placeholder:"Nome do departamento"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Departamentos afiliados"}),e.jsx(K,{options:I.filter(t=>t.value!==l),value:v.affiliates,onChange:t=>j(s=>({...s,affiliates:t})),placeholder:"Selecione"})]}),k&&e.jsx("div",{className:"p-3 bg-rose-50 text-rose-600 text-sm rounded-lg",children:k}),e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx("button",{type:"button",onClick:()=>{a(!1),f(null)},className:"px-4 py-2 bg-gray-100 text-gray-700 rounded-lg",children:"Cancelar"}),e.jsx("button",{type:"submit",disabled:N,className:"px-4 py-2 bg-brand-600 text-white rounded-lg hover:bg-brand-700 disabled:opacity-50",children:N?"Salvando...":l?"Salvar":"Criar"})]})]})]})})]})};export{W as default};
