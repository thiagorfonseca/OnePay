import{c as k,u as M,r as a,j as e,s as N,l as A}from"./index-V1BrPv90.js";const C=k("Send",[["path",{d:"m22 2-7 20-4-9-9-4Z",key:"1q3vgg"}],["path",{d:"M22 2 11 13",key:"nzbqef"}]]),I=k("Sparkles",[["path",{d:"m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z",key:"17u4zn"}],["path",{d:"M5 3v4",key:"bklmnn"}],["path",{d:"M19 17v4",key:"iiml17"}],["path",{d:"M3 5h4",key:"nem4j1"}],["path",{d:"M17 19h4",key:"lbex7p"}]]),L=()=>{const{user:n,effectiveClinicId:r}=M(),[x,p]=a.useState([]),[g,f]=a.useState(""),[y,m]=a.useState(!1),[l,b]=a.useState(!1),[v,o]=a.useState(null),d=a.useRef(null),u=a.useMemo(()=>!!n?.id&&!!r,[n?.id,r]),j=async()=>{if(!n?.id||!r)return;m(!0);const{data:s,error:t}=await N.from("ai_chat_messages").select("id, role, content, created_at").eq("clinic_id",r).eq("user_id",n.id).order("created_at",{ascending:!0}).limit(200);if(t){o(t.message),m(!1);return}p(s||[]),m(!1)};a.useEffect(()=>{j()},[n?.id,r]),a.useEffect(()=>{d.current&&(d.current.scrollTop=d.current.scrollHeight)},[x,l]);const E=async s=>{const t=s.trim();if(t){if(!u){o("Selecione uma clínica válida para usar o assistente.");return}o(null),f(""),p(i=>[...i,{role:"user",content:t,created_at:new Date().toISOString()}]),b(!0);try{const{data:i}=await N.auth.getSession(),S=i.session?.access_token;if(!S)throw new Error("Sessão expirada. Faça login novamente.");const w=await fetch("/api/ai/clinic-assistant",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${S}`,apikey:A},body:JSON.stringify({message:t,clinic_id:r})}),h=await w.text();let c=null;if(h)try{c=JSON.parse(h)}catch{c=null}if(!w.ok)throw new Error(c?.error||c?.message||h||"Erro ao consultar assistente.");p(_=>[..._,{role:"assistant",content:c.answer,created_at:new Date().toISOString()}]),await j()}catch(i){o(i.message||"Erro ao enviar mensagem.")}finally{b(!1)}}};return e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-800",children:"Assistente IA da Clínica"}),e.jsx("p",{className:"text-gray-500",children:"Pergunte sobre recebíveis, despesas e projeções financeiras."})]}),e.jsxs("div",{className:"bg-white border border-gray-100 rounded-xl shadow-sm p-4 space-y-3",children:[!u&&e.jsx("div",{className:"text-sm text-gray-500",children:"Selecione uma clínica ativa para usar o assistente."}),v&&e.jsx("div",{className:"text-sm text-red-600",children:v})]}),e.jsxs("div",{className:"bg-white border border-gray-100 rounded-xl shadow-sm p-4 flex flex-col h-[520px]",children:[e.jsxs("div",{ref:d,className:"flex-1 overflow-y-auto space-y-3 pr-2",children:[y&&e.jsx("div",{className:"text-sm text-gray-400",children:"Carregando histórico..."}),!y&&x.length===0&&e.jsx("div",{className:"text-sm text-gray-400",children:"Comece uma conversa para ver respostas financeiras."}),x.map((s,t)=>e.jsx("div",{className:`flex ${s.role==="user"?"justify-end":"justify-start"}`,children:e.jsx("div",{className:`max-w-[75%] whitespace-pre-line rounded-2xl px-4 py-3 text-sm ${s.role==="user"?"bg-brand-600 text-white":"bg-gray-100 text-gray-700"}`,children:s.content})},s.id||t)),l&&e.jsx("div",{className:"flex justify-start",children:e.jsxs("div",{className:"flex items-center gap-2 bg-gray-100 text-gray-600 rounded-2xl px-4 py-3 text-sm",children:[e.jsx(I,{size:16,className:"animate-pulse"})," Digitando..."]})})]}),e.jsxs("form",{onSubmit:s=>{s.preventDefault(),E(g)},className:"mt-4 flex items-center gap-2",children:[e.jsx("input",{value:g,onChange:s=>f(s.target.value),placeholder:"Digite sua pergunta financeira...",className:"flex-1 px-4 py-3 border border-gray-200 rounded-lg text-sm focus:ring-brand-500 focus:border-brand-500",disabled:!u||l}),e.jsxs("button",{type:"submit",disabled:!u||l,className:"px-4 py-3 bg-brand-600 text-white rounded-lg hover:bg-brand-700 disabled:opacity-50 flex items-center gap-2",children:[e.jsx(C,{size:16})," Enviar"]})]})]})]})};export{L as default};
