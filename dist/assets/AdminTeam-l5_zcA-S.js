import{c as ie,u as ne,r,j as e,S as de,e as oe,s as c}from"./index-Bi_Yktdj.js";import{c as ce}from"./utils-Bgz2xRk4.js";import{L as G}from"./loader-2-wegoqaf-.js";import{P as W}from"./plus-CW1JmJBD.js";const K=ie("Mail",[["rect",{width:"20",height:"16",x:"2",y:"4",rx:"2",key:"18n3k1"}],["path",{d:"m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7",key:"1ocrg3"}]]),J="user-avatars",A=350,S=[{value:"/admin/dashboard",label:"Dashboard"},{value:"/admin/clinics",label:"Clínicas"},{value:"/admin/users",label:"Usuários"},{value:"/admin/team",label:"Equipe"},{value:"/admin/packages",label:"Pacotes"},{value:"/admin/content",label:"Conteúdos"},{value:"/admin/profile",label:"Perfil"}],Q=S.reduce((s,l)=>(s[l.value]=l.label,s),{}),me=new Set(S.map(s=>s.value)),ue=s=>s.normalize("NFKD").replace(/[\u0300-\u036f]/g,"").replace(/[^a-zA-Z0-9._-]+/g,"-").replace(/-+/g,"-").replace(/^-+|-+$/g,"")||`file-${crypto.randomUUID()}`,xe=s=>new Promise((l,o)=>{const i=new Image,n=URL.createObjectURL(s);i.onload=()=>{URL.revokeObjectURL(n),l({width:i.width,height:i.height})},i.onerror=()=>{URL.revokeObjectURL(n),o(new Error("Imagem inválida."))},i.src=n}),ge=async s=>{if(!s.type.startsWith("image/"))return"Envie um arquivo de imagem.";try{const{width:l,height:o}=await xe(s);return l!==o?"A imagem precisa ser quadrada.":l>A||o>A?`A imagem deve ter no máximo ${A} x ${A}px.`:null}catch{return"Não foi possível ler a imagem."}},pe=async(s,l)=>{const o=ue(l.name),i=`users/${s}/${crypto.randomUUID()}-${o}`,{error:n}=await c.storage.from(J).upload(i,l,{upsert:!0});if(n)throw n;const{data:C}=c.storage.from(J).getPublicUrl(i);return C.publicUrl},X=(s,l)=>{const o=s.trim();if(o){const n=o.split(/\s+/).filter(Boolean);return n.length===1?n[0].slice(0,2).toUpperCase():`${n[0][0]||""}${n[n.length-1][0]||""}`.toUpperCase()}const i=l.trim();return i?i.slice(0,2).toUpperCase():"AD"},ye=()=>{const{user:s}=ne(),[l,o]=r.useState([]),[i,n]=r.useState([]),[C,z]=r.useState(!0),[U,Z]=r.useState(!0),[h,k]=r.useState({full_name:"",email:""}),[H,b]=r.useState(!1),[I,O]=r.useState(null),[d,u]=r.useState({full_name:"",role:"super_admin",email:"",avatar_url:null,admin_pages:[]}),[R,v]=r.useState(null),[p,y]=r.useState(null),[j,N]=r.useState(null),[q,$]=r.useState(!1),[F,f]=r.useState(!1),[_,m]=r.useState(null),T=ce("/auth/callback"),M=r.useRef(null),L=async()=>{const{data:a,error:t}=await c.rpc("list_system_admins");if(!t&&a){o(a);return}const{data:x,error:g}=await c.from("profiles").select("id, full_name, role, created_at, avatar_url, admin_pages").in("role",["system_owner","super_admin"]).order("created_at",{ascending:!1});!g&&x&&o(x)},P=async()=>{const{data:a,error:t}=await c.from("system_admin_invites").select("*").order("created_at",{ascending:!1});if(t){t.message?.includes("does not exist")&&Z(!1);return}n(a)},Y=async()=>{z(!0),await L(),await P(),z(!1)};r.useEffect(()=>{Y()},[]),r.useEffect(()=>()=>{p?.startsWith("blob:")&&URL.revokeObjectURL(p)},[p]);const ee=async a=>{if(a.preventDefault(),!U)return;const t=h.email.trim().toLowerCase(),x=h.full_name.trim();if(!t){m("Informe um e-mail válido.");return}f(!0),m(null);try{const{data:g}=await c.from("clinic_users").select("id").eq("email",t).maybeSingle();if(g){m("Este e-mail já está vinculado a uma clínica."),f(!1);return}const{data:w}=await c.from("system_admin_invites").select("id").eq("email",t).maybeSingle();if(w){m("Já existe um convite pendente para este e-mail."),f(!1);return}try{const{data:le}=await c.from("clinic_invites").select("id").eq("email",t).maybeSingle();if(le){m("Este e-mail já está em um convite de clínica."),f(!1);return}}catch{}const{error:E}=await c.from("system_admin_invites").insert([{email:t,full_name:x||null,role:"super_admin",invited_by:s?.id||null}]);if(E)throw E;const V={shouldCreateUser:!0};T&&(V.emailRedirectTo=T);const{error:B}=await c.auth.signInWithOtp({email:t,options:V});B&&m(`Convite criado, mas não foi possível enviar o e-mail: ${B.message}`),k({full_name:"",email:""}),await P()}catch(g){m(g.message||"Erro ao criar convite.")}finally{f(!1)}},D=()=>{O(null),u({full_name:"",role:"super_admin",email:"",avatar_url:null,admin_pages:[]}),v(null),y(null),N(null)},ae=a=>{O(a.id),u({full_name:a.full_name||"",role:a.role||"super_admin",email:a.email||"",avatar_url:a.avatar_url||null,admin_pages:a.admin_pages||[]}),m(null),v(null),y(null),N(null),b(!0)},te=async a=>{const t=await ge(a);if(t){N(t),v(null),y(null);return}N(null),v(a),y(URL.createObjectURL(a))},se=async a=>{if(a.preventDefault(),!!I){if(j&&R){m(j);return}$(!0),m(null);try{let t=d.avatar_url||null;R&&(t=await pe(I,R));const x=d.admin_pages.filter(E=>me.has(E)),g={full_name:d.full_name.trim()||null,role:d.role,avatar_url:t,admin_pages:x},{error:w}=await c.from("profiles").update(g).eq("id",I);if(w)throw w;await L(),b(!1),D()}catch(t){m(t.message||"Erro ao atualizar administrador.")}finally{$(!1)}}},re=async a=>{if(a.id===s?.id){alert("Você não pode remover o seu próprio usuário.");return}if(!confirm("Excluir este administrador?"))return;const{error:t}=await c.from("profiles").delete().eq("id",a.id);if(t){alert("Erro ao excluir administrador: "+t.message);return}await L()};return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-800",children:"Equipe"}),e.jsx("p",{className:"text-gray-500",children:"Cadastre administradores da plataforma (super admin)."})]}),e.jsxs("div",{className:"bg-white border border-gray-100 rounded-xl shadow-sm p-6 space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-2 text-gray-800 font-semibold",children:[e.jsx(de,{size:16}),"Novo administrador"]}),U?e.jsxs("form",{onSubmit:ee,className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{className:"md:col-span-1",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Nome"}),e.jsx("input",{value:h.full_name,onChange:a=>k(t=>({...t,full_name:a.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-brand-500 outline-none",placeholder:"Nome completo"})]}),e.jsxs("div",{className:"md:col-span-1",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"E-mail"}),e.jsxs("div",{className:"relative",children:[e.jsx(K,{size:16,className:"absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"}),e.jsx("input",{type:"email",value:h.email,onChange:a=>k(t=>({...t,email:a.target.value})),className:"w-full pl-9 pr-3 py-2 border border-gray-300 rounded-lg focus:ring-brand-500 outline-none",placeholder:"email@dominio.com"})]})]}),e.jsx("div",{className:"md:col-span-1 flex items-end",children:e.jsxs("button",{type:"submit",disabled:F,className:"w-full px-4 py-2 bg-brand-600 text-white rounded-lg hover:bg-brand-700 disabled:opacity-50 flex items-center gap-2 justify-center",children:[F?e.jsx(G,{size:16,className:"animate-spin"}):e.jsx(W,{size:16}),"Criar convite"]})})]}):e.jsx("div",{className:"text-sm text-gray-500",children:"Tabela de convites indisponível. Rode as migrations do Supabase."}),_&&e.jsx("p",{className:"text-sm text-red-600",children:_})]}),e.jsxs("div",{className:"bg-white border border-gray-100 rounded-xl shadow-sm p-6 space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-2 text-gray-800 font-semibold",children:[e.jsx(oe,{size:16}),"Administradores atuais"]}),C?e.jsx("div",{className:"text-sm text-gray-400",children:"Carregando equipe..."}):e.jsxs("div",{className:"border border-gray-100 rounded-lg divide-y",children:[l.map(a=>e.jsxs("div",{className:"p-3 flex items-center justify-between gap-3",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"h-12 w-12 rounded-full border border-gray-200 bg-gray-50 flex items-center justify-center overflow-hidden text-xs font-semibold text-gray-500",children:a.avatar_url?e.jsx("img",{src:a.avatar_url,alt:`Foto de ${a.full_name||"admin"}`,className:"h-full w-full object-cover object-center"}):e.jsx("span",{children:X(a.full_name||"",a.email||"")})}),e.jsxs("div",{children:[e.jsx("p",{className:"font-semibold text-gray-800",children:a.full_name||"Sem nome"}),e.jsx("p",{className:"text-xs text-gray-500",children:a.email||"E-mail não disponível"}),e.jsxs("p",{className:"text-xs text-gray-500",children:["Role: ",a.role]}),a.admin_pages&&a.admin_pages.length>0?e.jsxs("p",{className:"text-xs text-gray-500",children:["Admin: ",a.admin_pages.map(t=>Q[t]||t).join(", ")]}):e.jsx("p",{className:"text-xs text-gray-400",children:"Admin: acesso completo"}),e.jsxs("p",{className:"text-xs text-gray-400",children:["ID: ",a.id]})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{type:"button",onClick:()=>ae(a),className:"text-sm text-brand-600",children:"Editar"}),e.jsx("button",{type:"button",onClick:()=>re(a),className:"text-sm text-red-600",children:"Excluir"})]})]},a.id)),l.length===0&&e.jsx("div",{className:"p-4 text-sm text-gray-400 text-center",children:"Nenhum administrador cadastrado."})]})]}),H&&e.jsx("div",{className:"fixed inset-0 bg-black/40 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-xl shadow-xl p-6 w-full max-w-xl space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h4",{className:"text-lg font-semibold text-gray-800",children:"Editar administrador"}),e.jsx("button",{type:"button",onClick:()=>{b(!1),D()},className:"text-gray-500 hover:text-gray-700",children:"✕"})]}),e.jsxs("form",{onSubmit:se,className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Imagem"}),e.jsxs("div",{className:"flex flex-wrap items-center gap-3",children:[e.jsx("div",{className:"h-16 w-16 rounded-full border border-gray-200 bg-gray-50 flex items-center justify-center overflow-hidden text-xs font-semibold text-gray-500",children:p||d.avatar_url?e.jsx("img",{src:p||d.avatar_url||"",alt:"Avatar do administrador",className:"h-full w-full object-cover object-center"}):e.jsx("span",{children:X(d.full_name||"",d.email||"")})}),e.jsxs("label",{className:"px-3 py-2 text-sm bg-white border border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50",children:[p||d.avatar_url?"Trocar imagem":"Adicionar imagem",e.jsx("input",{type:"file",accept:"image/*",className:"hidden",onChange:async a=>{const t=a.target.files?.[0];t&&await te(t),a.currentTarget.value=""}})]}),e.jsx("span",{className:"text-xs text-gray-500",children:"Quadrada até 350 x 350."})]}),j&&e.jsx("p",{className:"text-xs text-red-600 mt-1",children:j})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Nome"}),e.jsx("input",{value:d.full_name,onChange:a=>u(t=>({...t,full_name:a.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-brand-500 outline-none"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"E-mail"}),e.jsx("input",{value:d.email||"",readOnly:!0,className:"w-full px-3 py-2 border border-gray-200 rounded-lg bg-gray-50 text-gray-500"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Nível de acesso"}),e.jsxs("select",{value:d.role,onChange:a=>u(t=>({...t,role:a.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-brand-500 outline-none bg-white",children:[e.jsx("option",{value:"system_owner",children:"System Owner"}),e.jsx("option",{value:"super_admin",children:"Super Admin"})]})]}),e.jsxs("div",{className:"md:col-span-2",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Páginas de admin"}),e.jsxs("div",{className:"flex gap-2 mb-2",children:[e.jsx("button",{type:"button",onClick:()=>u(a=>({...a,admin_pages:S.map(t=>t.value)})),className:"px-2 py-1 text-xs bg-emerald-50 text-emerald-700 rounded border border-emerald-100",children:"Selecionar tudo"}),e.jsx("button",{type:"button",onClick:()=>u(a=>({...a,admin_pages:[]})),className:"px-2 py-1 text-xs bg-red-50 text-red-700 rounded border border-red-100",children:"Limpar"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("details",{ref:M,className:"relative",children:[e.jsx("summary",{className:"list-none cursor-pointer w-full px-3 py-2 border border-gray-300 rounded-lg bg-white text-sm text-gray-700",children:"Selecionar página..."}),e.jsx("div",{className:"absolute z-20 mt-2 w-full max-h-56 overflow-auto border border-gray-200 rounded-lg bg-white shadow-lg",children:S.map(a=>e.jsx("button",{type:"button",onClick:()=>{d.admin_pages.includes(a.value)||(u(t=>({...t,admin_pages:[...t.admin_pages,a.value]})),M.current&&M.current.removeAttribute("open"))},className:"w-full text-left px-3 py-2 text-sm text-gray-700 hover:bg-gray-50",children:a.label},a.value))})]}),e.jsx("div",{className:"flex flex-wrap gap-2",children:d.admin_pages.map(a=>e.jsxs("button",{type:"button",onClick:()=>u(t=>({...t,admin_pages:t.admin_pages.filter(x=>x!==a)})),className:"px-3 py-1 rounded-full border border-gray-200 text-xs text-gray-600 hover:border-gray-300",children:[Q[a]||a," ✕"]},a))})]})]})]}),_&&e.jsx("p",{className:"text-sm text-red-600",children:_}),e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx("button",{type:"button",onClick:()=>{b(!1),D()},className:"px-4 py-2 bg-gray-100 text-gray-700 rounded-lg",children:"Cancelar"}),e.jsxs("button",{type:"submit",disabled:q,className:"px-4 py-2 bg-brand-600 text-white rounded-lg hover:bg-brand-700 disabled:opacity-50 flex items-center gap-2",children:[q?e.jsx(G,{size:16,className:"animate-spin"}):e.jsx(W,{size:16}),"Salvar alterações"]})]})]})]})}),U&&e.jsxs("div",{className:"bg-white border border-gray-100 rounded-xl shadow-sm p-6 space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-2 text-gray-800 font-semibold",children:[e.jsx(K,{size:16}),"Convites pendentes"]}),e.jsxs("div",{className:"border border-gray-100 rounded-lg divide-y",children:[i.map(a=>e.jsxs("div",{className:"p-3 flex items-center justify-between gap-3",children:[e.jsxs("div",{children:[e.jsx("p",{className:"font-semibold text-gray-800",children:a.full_name||"Sem nome"}),e.jsx("p",{className:"text-xs text-gray-500",children:a.email}),e.jsxs("p",{className:"text-xs text-gray-400",children:["Role: ",a.role]})]}),e.jsx("button",{type:"button",onClick:async()=>{confirm("Revogar convite?")&&(await c.from("system_admin_invites").delete().eq("id",a.id),P())},className:"text-sm text-red-600 hover:underline",children:"Revogar"})]},a.id)),i.length===0&&e.jsx("div",{className:"p-4 text-sm text-gray-400 text-center",children:"Nenhum convite pendente."})]})]})]})};export{ye as default};
