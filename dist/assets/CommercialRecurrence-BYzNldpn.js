import{u as k,r as d,j as e}from"./index-Bi_Yktdj.js";import{f as L,a as P}from"./commercial-DwIyj_SI.js";import{C as M}from"./calendar-9FKwlTHs.js";import{D as b}from"./download-GFpxFQdG.js";import{L as A}from"./loader-2-wegoqaf-.js";const f=n=>n.toISOString().slice(0,10);function N(n){const c=new Date,s=new Date;return n==="quinzenal"?s.setDate(s.getDate()-15):n==="mensal"?s.setMonth(s.getMonth()-1):n==="trimestral"?s.setMonth(s.getMonth()-3):n==="semestral"?s.setMonth(s.getMonth()-6):s.setFullYear(s.getFullYear()-1),{from:f(s),to:f(c)}}const Q=()=>{const{clinicId:n,isAdmin:c,selectedClinicId:s}=k(),[v,p]=d.useState("semestral"),[w,g]=d.useState(!0),[i,R]=d.useState([]),[x,C]=d.useState({total:0,recorrentes:0,naoRecorrentes:0,percentual:0}),[{from:l,to:o},u]=d.useState(()=>N("semestral")),S=t=>{p(t),t!=="personalizado"&&u(N(t))},j=(t,a)=>{p("personalizado"),u({from:t,to:a})};d.useEffect(()=>{(async()=>{if(!n&&!c)return;g(!0);const a=await L({clinicId:c?s||void 0:n,from:l,to:o}),r=P(a,l,o);R(r.rows),C({total:r.total,recorrentes:r.recorrentes,naoRecorrentes:r.naoRecorrentes,percentual:r.percentual}),g(!1)})()},[n,c,s,l,o]);const D=()=>{const t=i.map(r=>`<tr>
      <td>${r.name}</td>
      <td>${r.atendimentos}</td>
      <td>${r.dates.join(", ")}</td>
      <td>${r.status}</td>
    </tr>`).join(""),a=window.open("","_blank");a&&(a.document.write(`
      <html><head><title>Recorrência</title>
      <style>table{border-collapse:collapse;width:100%;font-family:Arial;}th,td{border:1px solid #ddd;padding:6px;font-size:12px;}th{background:#f3f4f6;text-align:left;}</style>
      </head><body>
      <h3>Recorrência (${l} a ${o})</h3>
      <table><thead><tr><th>Cliente</th><th>Qtd atendimentos</th><th>Datas</th><th>Status</th></tr></thead>
      <tbody>${t}</tbody>
      </table>
      </body></html>
    `),a.document.close(),a.print())},$=()=>{const t=["Cliente","Qtd atendimentos","Datas","Status"],a=i.map(m=>[`"${String(m.name).replace(/"/g,'""')}"`,m.atendimentos,`"${m.dates.join(", ").replace(/"/g,'""')}"`,`"${String(m.status).replace(/"/g,'""')}"`].join(",")),r=[t.join(","),...a].join(`
`),z=new Blob([r],{type:"text/csv;charset=utf-8;"}),y=URL.createObjectURL(z),h=document.createElement("a");h.href=y,h.download=`recorrencia-${l||"inicio"}-${o||"fim"}.csv`,h.click(),URL.revokeObjectURL(y)};return e.jsxs("div",{className:"space-y-4",children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-800",children:"Comercial • Recorrência"}),e.jsx("p",{className:"text-gray-500",children:"Análise de recorrência por período."}),e.jsxs("div",{className:"flex flex-wrap gap-2 items-center",children:[e.jsxs("div",{className:"flex items-center gap-2 px-3 py-2 border border-gray-200 rounded-lg text-sm bg-white",children:[e.jsx(M,{size:16})," Período:",e.jsxs("select",{value:v,onChange:t=>S(t.target.value),className:"text-sm bg-transparent focus:outline-none",children:[e.jsx("option",{value:"quinzenal",children:"Últimos 15 dias"}),e.jsx("option",{value:"mensal",children:"Últimos 30 dias"}),e.jsx("option",{value:"trimestral",children:"Últimos 3 meses"}),e.jsx("option",{value:"semestral",children:"Últimos 6 meses"}),e.jsx("option",{value:"anual",children:"Últimos 12 meses"}),e.jsx("option",{value:"personalizado",children:"Personalizado"})]})]}),e.jsxs("label",{className:"flex items-center gap-2 text-gray-600 text-sm",children:[e.jsx("span",{children:"De"}),e.jsx("input",{type:"date",value:l,onChange:t=>j(t.target.value,o),className:"px-3 py-2 border border-gray-200 rounded-lg bg-white text-gray-700"})]}),e.jsxs("label",{className:"flex items-center gap-2 text-gray-600 text-sm",children:[e.jsx("span",{children:"Até"}),e.jsx("input",{type:"date",value:o,onChange:t=>j(l,t.target.value),className:"px-3 py-2 border border-gray-200 rounded-lg bg-white text-gray-700"})]}),e.jsxs("button",{onClick:D,className:"flex items-center gap-2 px-3 py-2 text-sm border rounded-lg text-gray-700 hover:bg-gray-50",children:[e.jsx(b,{size:14})," PDF"]}),e.jsxs("button",{onClick:$,className:"flex items-center gap-2 px-3 py-2 text-sm border rounded-lg text-gray-700 hover:bg-gray-50",children:[e.jsx(b,{size:14})," CSV"]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-3",children:[e.jsxs("div",{className:"bg-white border border-gray-100 p-4 rounded-lg",children:[e.jsx("p",{className:"text-xs uppercase text-gray-500",children:"Total"}),e.jsx("p",{className:"text-xl font-bold text-gray-800",children:x.total})]}),e.jsxs("div",{className:"bg-white border border-gray-100 p-4 rounded-lg",children:[e.jsx("p",{className:"text-xs uppercase text-gray-500",children:"Recorrentes"}),e.jsx("p",{className:"text-xl font-bold text-gray-800",children:x.recorrentes})]}),e.jsxs("div",{className:"bg-white border border-gray-100 p-4 rounded-lg",children:[e.jsx("p",{className:"text-xs uppercase text-gray-500",children:"Não recorrentes"}),e.jsx("p",{className:"text-xl font-bold text-gray-800",children:x.naoRecorrentes})]}),e.jsxs("div",{className:"bg-white border border-gray-100 p-4 rounded-lg",children:[e.jsx("p",{className:"text-xs uppercase text-gray-500",children:"% Recorrência"}),e.jsxs("p",{className:"text-xl font-bold text-gray-800",children:[x.percentual.toFixed(1),"%"]})]})]}),e.jsx("div",{className:"bg-white border border-gray-100 rounded-xl shadow-sm overflow-hidden",children:w?e.jsxs("div",{className:"h-48 flex items-center justify-center text-gray-500",children:[e.jsx(A,{className:"animate-spin mr-2",size:20})," Carregando..."]}):e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full text-sm",children:[e.jsx("thead",{className:"bg-gray-50 text-gray-600 border-b border-gray-100",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-3 text-left",children:"Cliente"}),e.jsx("th",{className:"px-4 py-3 text-left",children:"Qtd atendimentos"}),e.jsx("th",{className:"px-4 py-3 text-left",children:"Datas"}),e.jsx("th",{className:"px-4 py-3 text-left",children:"Status"})]})}),e.jsxs("tbody",{className:"divide-y divide-gray-100",children:[i.map((t,a)=>e.jsxs("tr",{className:"hover:bg-gray-50",children:[e.jsx("td",{className:"px-4 py-2 font-semibold text-gray-800",children:t.name}),e.jsx("td",{className:"px-4 py-2 text-gray-700",children:t.atendimentos}),e.jsx("td",{className:"px-4 py-2 text-gray-600",children:t.dates.join(", ")}),e.jsx("td",{className:`px-4 py-2 text-xs font-semibold ${t.status==="Recorrente"?"text-emerald-700":"text-gray-600"}`,children:t.status})]},a)),i.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:4,className:"px-4 py-6 text-center text-gray-400",children:"Sem dados no período."})})]})]})})})]})};export{Q as default};
