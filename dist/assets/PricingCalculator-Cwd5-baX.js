import{c as fe,u as ve,r,j as t,W as je,f as Ne,m as Ce,s as M}from"./index-HcuLVkXM.js";import{f as i}from"./utils-C6qNh0Lg.js";import{u as we}from"./useModalControls-BiWM_r1l.js";import{C as ke}from"./clock-1DnlEicU.js";import{C as Se}from"./credit-card-Cayxm7x4.js";import{P as _e}from"./pencil-MoagDD9-.js";const $=fe("Percent",[["line",{x1:"19",x2:"5",y1:"5",y2:"19",key:"1x9vlm"}],["circle",{cx:"6.5",cy:"6.5",r:"2.5",key:"4mh3h7"}],["circle",{cx:"17.5",cy:"17.5",r:"2.5",key:"1mdrzq"}]]),Me=()=>{const{effectiveClinicId:x}=ve(),v=r.useMemo(()=>`pricing-calculator-settings:${x||"default"}`,[x]),[E,ie]=r.useState([]),[j,V]=r.useState([]),[A,D]=r.useState(!0),[g,N]=r.useState(""),[C,O]=r.useState("120"),[w,T]=r.useState("50"),[k,L]=r.useState("15"),[S,q]=r.useState("20"),[_,B]=r.useState("2,5"),[I,K]=r.useState("20"),[b,z]=r.useState(!1),[P,le]=r.useState(""),[d,ce]=r.useState("name"),[u,J]=r.useState("asc"),[n,c]=r.useState(null),[Q,U]=r.useState(!1),[W,G]=r.useState(!1),m=e=>{const s=e.trim().replace(/[^0-9,.-]/g,"");if(!s)return 0;const a=s.includes(",")?s.replace(/\./g,"").replace(",","."):s,l=Number(a);return Number.isFinite(l)?l:0},h=e=>m(e)/100,p=e=>{d===e?J(s=>s==="asc"?"desc":"asc"):(ce(e),J("asc"))},de=we({isOpen:!!n,onClose:()=>c(null)});r.useEffect(()=>{(async()=>{D(!0);try{let s=M.from("pricing_expenses").select("*").order("created_at",{ascending:!1}),o=M.from("procedures").select("*").order("created_at",{ascending:!1});x&&(s=s.eq("clinic_id",x),o=o.eq("clinic_id",x));const[{data:a},{data:l}]=await Promise.all([s,o]);ie(a||[]),V(l||[])}finally{D(!1)}})()},[x]);const y=r.useMemo(()=>E.reduce((e,s)=>{const o=Number(s.valor_calculado??s.valor_base??0);return e+(Number.isFinite(o)?o:0)},0),[E]);r.useEffect(()=>{b||N(y?i(y):i(0))},[y,b]),r.useEffect(()=>{if(!(typeof window>"u"))try{const e=window.localStorage.getItem(v);if(!e){G(!0);return}const s=JSON.parse(e);s.hoursAvailableInput&&O(String(s.hoursAvailableInput)),s.occupancyInput&&T(String(s.occupancyInput)),s.taxInput&&L(String(s.taxInput)),s.marginInput&&q(String(s.marginInput)),s.cardFeeInput&&B(String(s.cardFeeInput)),s.commissionInput&&K(String(s.commissionInput)),s.totalCostsInput&&N(String(s.totalCostsInput)),typeof s.manualCosts=="boolean"&&z(s.manualCosts)}catch(e){console.warn("Falha ao carregar configura√ß√µes de precifica√ß√£o.",e)}finally{G(!0)}},[v]),r.useEffect(()=>{if(typeof window>"u"||!W)return;const e={hoursAvailableInput:C,occupancyInput:w,taxInput:k,marginInput:S,cardFeeInput:_,commissionInput:I,totalCostsInput:g,manualCosts:b};window.localStorage.setItem(v,JSON.stringify(e))},[W,v,C,w,k,S,_,I,g,b]);const X=b?m(g):y,Y=m(C),Z=h(w),ue=h(k),me=h(S),xe=h(_),F=h(I),f=r.useMemo(()=>{const e=Y*(Z||0);return e?X/e:0},[X,Y,Z]),ee=ue+me+F+xe,pe=r.useMemo(()=>j.map(e=>({id:e.id,label:e.procedimento||"Procedimento"})),[j]),te=r.useMemo(()=>j.filter(e=>!P||e.id===P).map(e=>{const s=Number(e.tempo_minutos??0),o=s?s/60:0,a=Number(e.custo_insumo??0),l=f*o+a,R=1-ee,re=R>0?l/R:0,oe=Number(e.valor_cobrado??0),ne=oe||re,he=ne-l,ye=ne*F;return{id:e.id,name:e.procedimento||"Procedimento",categoria:e.categoria||"",tempo_minutos:e.tempo_minutos??null,custo_insumo:e.custo_insumo??null,valor_cobrado:e.valor_cobrado??null,recommended:re,worked:oe,durationHours:o,rentability:he,commissionValue:ye}}),[j,P,f,ee,F]),se=(e,s)=>{if(!f||!s)return{type:"vaca",percent:0};const a=e/s/f*100;return a<0?{type:"abacaxi",percent:a}:a<=50?{type:"vaca",percent:a}:{type:"estrela",percent:a}},ae=e=>e==="estrela"?"‚≠ê":e==="abacaxi"?"üçç":"üêÑ",H=r.useMemo(()=>{const e=u==="asc"?1:-1;return[...te].sort((s,o)=>{const a=l=>l.toLowerCase();switch(d){case"name":return a(s.name).localeCompare(a(o.name))*e;case"recommended":return((s.recommended||0)-(o.recommended||0))*e;case"worked":return((s.worked||0)-(o.worked||0))*e;case"hours":return((s.durationHours||0)-(o.durationHours||0))*e;case"rentability":return((s.rentability||0)-(o.rentability||0))*e;case"commission":return((s.commissionValue||0)-(o.commissionValue||0))*e;default:return 0}})},[te,d,u]),ge=()=>{const e=["Servi√ßo","Valor recomendado","Valor trabalhado","Horas gastas","Rentabilidade","Comiss√£o/Parceiro"],s=H.map(a=>{const l=se(a.rentability,a.durationHours);return`
        <tr>
          <td>${ae(l.type)} ${a.name}</td>
          <td>${i(a.recommended||0)}</td>
          <td>${a.worked?i(a.worked):"-"}</td>
          <td>${a.durationHours.toFixed(2)}</td>
          <td>${i(a.rentability||0)}</td>
          <td>${i(a.commissionValue||0)}</td>
        </tr>
      `}).join(""),o=window.open("","_blank");o&&(o.document.write(`
      <html>
      <head>
        <title>OneFinc ‚Ä¢ Calculadora de Precifica√ß√£o</title>
        <style>
          body { font-family: Arial, sans-serif; color: #111827; padding: 24px; }
          .brand { display: flex; align-items: center; gap: 12px; margin-bottom: 12px; }
          .brand h1 { font-size: 20px; margin: 0; }
          .brand p { margin: 0; font-size: 12px; color: #6b7280; }
          table { border-collapse: collapse; width: 100%; margin-top: 16px; }
          th, td { border: 1px solid #e5e7eb; padding: 8px; font-size: 12px; text-align: left; }
          th { background: #f3f4f6; }
          .meta { font-size: 12px; color: #6b7280; }
        </style>
      </head>
      <body>
        <div class="brand">
          <div>
            <h1>OneFinc</h1>
            <p>Precifica√ß√£o ‚Ä¢ Calculadora</p>
          </div>
        </div>
        <div class="meta">Relat√≥rio gerado em ${new Date().toLocaleDateString("pt-BR")}</div>
        <table>
          <thead>
            <tr>${e.map(a=>`<th>${a}</th>`).join("")}</tr>
          </thead>
          <tbody>${s||'<tr><td colspan="6">Nenhum procedimento encontrado.</td></tr>'}</tbody>
        </table>
      </body>
      </html>
    `),o.document.close(),o.print())},be=async()=>{if(n){U(!0);try{const e={procedimento:n.procedimento,categoria:n.categoria||null,tempo_minutos:n.tempo_minutos?m(String(n.tempo_minutos)):null,custo_insumo:n.custo_insumo?m(String(n.custo_insumo)):null,valor_cobrado:n.valor_cobrado?m(String(n.valor_cobrado)):null},{error:s}=await M.from("procedures").update(e).eq("id",n.id);if(s)throw s;V(o=>o.map(a=>a.id===n.id?{...a,...e}:a)),c(null)}catch(e){alert("Erro ao salvar procedimento: "+(e?.message||"Tente novamente."))}finally{U(!1)}}};return t.jsxs("div",{className:"space-y-6",children:[t.jsxs("div",{children:[t.jsx("h1",{className:"text-2xl font-bold text-gray-800",children:"Calculadora"}),t.jsx("p",{className:"text-gray-500",children:"Precifica√ß√£o ‚Ä¢ Calculadora"})]}),A&&t.jsx("div",{className:"bg-white border border-gray-100 rounded-xl p-6 text-sm text-gray-500",children:"Carregando dados de custos e procedimentos..."}),!A&&t.jsxs(t.Fragment,{children:[t.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-x-3 gap-y-3",children:[t.jsxs("div",{className:"bg-white rounded-xl border border-gray-100 p-3",children:[t.jsxs("div",{className:"flex items-center gap-2 text-gray-500 text-xs",children:[t.jsx(je,{size:16})," Custos"]}),t.jsx("input",{value:g,onChange:e=>{N(e.target.value),z(!0)},onBlur:()=>{const e=m(g);N(i(e))},className:"mt-1 w-full text-lg font-semibold text-gray-800 bg-transparent outline-none"}),t.jsxs("button",{type:"button",onClick:()=>z(!1),className:"mt-1 text-[11px] text-brand-600",children:["Usar custos calculados (",i(y),")"]})]}),t.jsxs("div",{className:"bg-white rounded-xl border border-gray-100 p-3",children:[t.jsxs("div",{className:"flex items-center gap-2 text-gray-500 text-xs",children:[t.jsx(ke,{size:16})," Horas dispon√≠veis"]}),t.jsx("input",{value:C,onChange:e=>O(e.target.value),className:"mt-1 w-full text-lg font-semibold text-gray-800 bg-transparent outline-none"})]}),t.jsxs("div",{className:"bg-white rounded-xl border border-gray-100 p-3",children:[t.jsxs("div",{className:"flex items-center gap-2 text-gray-500 text-xs",children:[t.jsx($,{size:16})," Taxa de ocupa√ß√£o"]}),t.jsx("input",{value:w,onChange:e=>T(e.target.value),className:"mt-1 w-full text-lg font-semibold text-gray-800 bg-transparent outline-none"})]}),t.jsxs("div",{className:"bg-white rounded-xl border border-gray-100 p-3",children:[t.jsxs("div",{className:"flex items-center gap-2 text-gray-500 text-xs",children:[t.jsx($,{size:16})," Impostos"]}),t.jsx("input",{value:k,onChange:e=>L(e.target.value),className:"mt-1 w-full text-lg font-semibold text-gray-800 bg-transparent outline-none"})]}),t.jsxs("div",{className:"bg-white rounded-xl border border-gray-100 p-3",children:[t.jsxs("div",{className:"flex items-center gap-2 text-gray-500 text-xs",children:[t.jsx($,{size:16})," Margem desejada"]}),t.jsx("input",{value:S,onChange:e=>q(e.target.value),className:"mt-1 w-full text-lg font-semibold text-gray-800 bg-transparent outline-none"})]}),t.jsxs("div",{className:"bg-white rounded-xl border border-gray-100 p-3",children:[t.jsxs("div",{className:"flex items-center gap-2 text-gray-500 text-xs",children:[t.jsx(Se,{size:16})," Taxa de cart√£o"]}),t.jsx("input",{value:_,onChange:e=>B(e.target.value),className:"mt-1 w-full text-lg font-semibold text-gray-800 bg-transparent outline-none"})]}),t.jsxs("div",{className:"bg-white rounded-xl border border-gray-100 p-3",children:[t.jsxs("div",{className:"flex items-center gap-2 text-gray-500 text-xs",children:[t.jsx(Ne,{size:16})," Comiss√£o/Parceiros"]}),t.jsx("input",{value:I,onChange:e=>K(e.target.value),className:"mt-1 w-full text-lg font-semibold text-gray-800 bg-transparent outline-none"})]}),t.jsxs("div",{className:"bg-blue-50 rounded-xl border border-blue-100 p-3",children:[t.jsxs("div",{className:"flex items-center gap-2 text-blue-700 text-xs",children:[t.jsx(Ce,{size:16})," custo hora clinica"]}),t.jsx("p",{className:"mt-1 text-lg font-semibold text-blue-700",children:i(f||0)})]})]}),t.jsxs("div",{className:"bg-white rounded-xl border border-gray-100 p-4 space-y-4",children:[t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsx("h2",{className:"text-lg font-semibold text-gray-800",children:"Lista de procedimentos"}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("button",{type:"button",onClick:ge,className:"px-3 py-2 text-sm border border-gray-200 rounded-lg text-gray-700 hover:bg-gray-50",children:"Baixar PDF"}),t.jsxs("select",{value:P,onChange:e=>le(e.target.value),className:"px-3 py-2 text-sm border border-gray-200 rounded-lg bg-white",children:[t.jsx("option",{value:"",children:"Todos"}),pe.map(e=>t.jsx("option",{value:e.id,children:e.label},e.id))]})]})]}),t.jsx("div",{className:"overflow-x-auto max-h-[420px] overflow-y-auto",children:t.jsxs("table",{className:"w-full text-left text-sm",children:[t.jsx("thead",{className:"text-gray-500 border-b border-gray-100",children:t.jsxs("tr",{children:[t.jsxs("th",{className:"px-4 py-2 sticky top-0 bg-white z-10 cursor-pointer",onClick:()=>p("name"),children:["Servi√ßo ",d==="name"&&(u==="asc"?"‚ñ≤":"‚ñº")]}),t.jsxs("th",{className:"px-4 py-2 text-right sticky top-0 bg-white z-10 cursor-pointer",onClick:()=>p("recommended"),children:["Valor recomendado ",d==="recommended"&&(u==="asc"?"‚ñ≤":"‚ñº")]}),t.jsxs("th",{className:"px-4 py-2 text-right sticky top-0 bg-white z-10 cursor-pointer",onClick:()=>p("worked"),children:["Valor trabalhado ",d==="worked"&&(u==="asc"?"‚ñ≤":"‚ñº")]}),t.jsxs("th",{className:"px-4 py-2 text-right sticky top-0 bg-white z-10 cursor-pointer",onClick:()=>p("hours"),children:["Horas gastas ",d==="hours"&&(u==="asc"?"‚ñ≤":"‚ñº")]}),t.jsxs("th",{className:"px-4 py-2 text-right sticky top-0 bg-white z-10 cursor-pointer",onClick:()=>p("rentability"),children:["Rentabilidade ",d==="rentability"&&(u==="asc"?"‚ñ≤":"‚ñº")]}),t.jsxs("th",{className:"px-4 py-2 text-right sticky top-0 bg-white z-10 cursor-pointer",onClick:()=>p("commission"),children:["Comiss√£o/Parceiro ",d==="commission"&&(u==="asc"?"‚ñ≤":"‚ñº")]}),t.jsx("th",{className:"px-4 py-2 text-right sticky top-0 bg-white z-10",children:"A√ß√µes"})]})}),t.jsxs("tbody",{className:"divide-y divide-gray-100",children:[H.map(e=>{const s=se(e.rentability,e.durationHours);return t.jsxs("tr",{className:"hover:bg-gray-50",children:[t.jsxs("td",{className:"px-4 py-2 text-gray-700",children:[t.jsx("span",{className:"mr-2",children:ae(s.type)}),e.name]}),t.jsx("td",{className:"px-4 py-2 text-right text-brand-700 font-medium",children:i(e.recommended||0)}),t.jsx("td",{className:"px-4 py-2 text-right text-gray-700",children:e.worked?i(e.worked):"-"}),t.jsx("td",{className:"px-4 py-2 text-right text-gray-700",children:e.durationHours.toFixed(2)}),t.jsx("td",{className:"px-4 py-2 text-right text-gray-700",children:i(e.rentability||0)}),t.jsx("td",{className:"px-4 py-2 text-right text-gray-700",children:i(e.commissionValue||0)}),t.jsx("td",{className:"px-4 py-2 text-right",children:t.jsxs("button",{type:"button",onClick:()=>c({id:e.id,procedimento:e.name,categoria:e.categoria,tempo_minutos:e.tempo_minutos??"",custo_insumo:e.custo_insumo??"",valor_cobrado:e.valor_cobrado??""}),className:"inline-flex items-center gap-1 px-2 py-1 text-xs border border-gray-200 rounded-md text-gray-600 hover:bg-gray-50",children:[t.jsx(_e,{size:12})," Editar"]})})]},e.id)}),H.length===0&&t.jsx("tr",{children:t.jsx("td",{colSpan:7,className:"px-4 py-8 text-center text-gray-400",children:"Nenhum procedimento encontrado."})})]})]})})]})]}),n&&t.jsx("div",{className:"fixed inset-0 z-50 bg-black/40 flex items-center justify-center p-4",onClick:de.onBackdropClick,children:t.jsxs("div",{className:"bg-white rounded-2xl shadow-xl w-full max-w-xl p-6 space-y-4",onClick:e=>e.stopPropagation(),children:[t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsx("h3",{className:"text-lg font-semibold text-gray-800",children:"Editar procedimento"}),t.jsx("button",{type:"button",onClick:()=>c(null),className:"w-9 h-9 rounded-full bg-gray-100 flex items-center justify-center text-gray-500",children:"‚úï"})]}),t.jsxs("div",{className:"space-y-3",children:[t.jsxs("div",{children:[t.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Procedimento"}),t.jsx("input",{value:n.procedimento,onChange:e=>c(s=>({...s,procedimento:e.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg"})]}),t.jsxs("div",{children:[t.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Categoria"}),t.jsx("input",{value:n.categoria||"",onChange:e=>c(s=>({...s,categoria:e.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg"})]}),t.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-3",children:[t.jsxs("div",{children:[t.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Tempo (min)"}),t.jsx("input",{value:n.tempo_minutos,onChange:e=>c(s=>({...s,tempo_minutos:e.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg"})]}),t.jsxs("div",{children:[t.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Custo insumo"}),t.jsx("input",{value:n.custo_insumo,onChange:e=>c(s=>({...s,custo_insumo:e.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg"})]}),t.jsxs("div",{children:[t.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Valor cobrado"}),t.jsx("input",{value:n.valor_cobrado,onChange:e=>c(s=>({...s,valor_cobrado:e.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg"})]})]})]}),t.jsxs("div",{className:"flex justify-end gap-2",children:[t.jsx("button",{type:"button",onClick:()=>c(null),className:"px-4 py-2 bg-gray-100 text-gray-700 rounded-lg",children:"Cancelar"}),t.jsx("button",{type:"button",onClick:be,disabled:Q,className:"px-4 py-2 bg-brand-600 text-white rounded-lg hover:bg-brand-700 disabled:opacity-60",children:Q?"Salvando...":"Salvar"})]})]})})]})};export{Me as default};
