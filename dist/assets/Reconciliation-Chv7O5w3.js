import{c as C,u as $,r as i,s as d,j as e}from"./index-V1BrPv90.js";import{b as q,f as I,p as U}from"./utils-ByGvREky.js";import{L as E}from"./loader-2-Bvn7HOnG.js";import{U as Q}from"./upload-Dux9Vz-Z.js";import{A as G}from"./alert-circle-DbEbrs4T.js";const H=C("CheckCircle",[["path",{d:"M22 11.08V12a10 10 0 1 1-5.93-9.14",key:"g774vq"}],["path",{d:"m9 11 3 3L22 4",key:"1pflzl"}]]),J=C("Link",[["path",{d:"M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71",key:"1cjeqo"}],["path",{d:"M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71",key:"19qd67"}]]),K=C("PlusCircle",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M8 12h8",key:"1wcyev"}],["path",{d:"M12 8v8",key:"napkw2"}]]),te=()=>{const{clinicId:_,isAdmin:T,selectedClinicId:D}=$(),j=(T?D:_)||_||null,[u,m]=i.useState(!1),[b,F]=i.useState([]),[r,w]=i.useState(""),[k,R]=i.useState([]),[S,A]=i.useState(null),[z,v]=i.useState(!1),[s,B]=i.useState(null),[M,L]=i.useState([]),[o,f]=i.useState({category_id:"",description:"",entity_name:""});i.useEffect(()=>{(async()=>{let t=d.from("bank_accounts").select("*");j&&(t=t.eq("clinic_id",j));const{data:x}=await t,{data:l}=await d.from("categories").select("*");x&&F(x),l&&L(l)})()},[j]),i.useEffect(()=>{r&&(b.some(a=>a.id===r)||w(""))},[b,r]),i.useEffect(()=>{r&&N()},[r]);const N=async()=>{m(!0);try{const{data:a,error:t}=await d.from("bank_transactions").select("*").eq("bank_account_id",r).order("data",{ascending:!1});if(t)throw t;R(a||[])}catch(a){console.error(a)}finally{m(!1)}},O=async a=>{if(!r){alert("Selecione uma conta bancária antes de importar o arquivo.");return}const t=a.target.files?.[0];if(t){m(!0),A(t.name);const x=new FileReader;x.onload=async l=>{const n=l.target?.result;if(typeof n=="string"){const g=U(n);let h=0,p=0;for(const c of g){const{data:y}=await d.from("bank_transactions").select("id").eq("hash_transacao",c.hash).eq("bank_account_id",r).maybeSingle();y?p++:(await d.from("bank_transactions").insert([{bank_account_id:r,data:c.date,descricao:c.description,valor:c.amount,tipo:c.type,hash_transacao:c.hash,conciliado:!1}]),h++)}alert(`Processamento concluído: ${h} novos, ${p} duplicados ignorados.`),N()}m(!1)},x.readAsText(t)}},P=a=>{B(a),f({category_id:"",description:a.descricao,entity_name:""}),v(!0)},V=async a=>{if(a.preventDefault(),!(!s||!o.category_id)){m(!0);try{const t=s.tipo==="CREDIT",x=t?"revenues":"expenses",l=Math.abs(s.valor),n={description:o.description,data_competencia:s.data,category_id:o.category_id,bank_account_id:r,observacoes:"Conciliado via OFX"};t?(n.valor_bruto=l,n.valor_liquido=l,n.data_recebimento=s.data,n.forma_pagamento="Transferência",n.paciente=o.entity_name):(n.valor=l,n.data_pagamento=s.data,n.fornecedor=o.entity_name,n.tipo_despesa="Variavel");const{data:g,error:h}=await d.from(x).insert([n]).select().single();if(h)throw h;const p={conciliado:!0};t?p.revenue_id_opcional=g.id:p.expense_id_opcional=g.id,await d.from("bank_transactions").update(p).eq("id",s.id);const c=b.find(y=>y.id===r);if(c){const X=Number(c.current_balance||0)+s.valor;await d.from("bank_accounts").update({current_balance:X}).eq("id",r)}v(!1),N()}catch(t){alert("Erro: "+t.message)}finally{m(!1)}}};return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"mb-8",children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-800",children:"Conciliação Bancária"}),e.jsx("p",{className:"text-gray-500",children:"Importe extratos OFX e concilie lançamentos"})]}),e.jsxs("div",{className:"bg-white p-6 rounded-xl shadow-sm border border-gray-100 mb-6",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Selecione a Conta para Conciliar"}),e.jsxs("select",{className:"w-full md:w-1/3 px-3 py-2 border border-gray-300 rounded-lg focus:ring-brand-500 outline-none",value:r,onChange:a=>w(a.target.value),children:[e.jsx("option",{value:"",children:"Selecione..."}),b.map(a=>e.jsxs("option",{value:a.id,children:[a.nome_conta||a.name||"Conta"," (",a.banco||a.bank||"Banco",")"]},a.id))]})]}),r&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"bg-white p-8 rounded-xl shadow-sm border border-gray-100 text-center border-dashed border-2 border-brand-100",children:e.jsxs("div",{className:"flex flex-col items-center justify-center space-y-4",children:[e.jsx("div",{className:"w-16 h-16 bg-brand-50 rounded-full flex items-center justify-center text-brand-600",children:u?e.jsx(E,{className:"animate-spin",size:32}):e.jsx(Q,{size:32})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-medium text-gray-800",children:"Importar arquivo OFX"}),e.jsx("p",{className:"text-gray-500 text-sm mt-1",children:"Os lançamentos serão salvos e verificados contra duplicidade."})]}),e.jsx("input",{type:"file",accept:".ofx",id:"ofx-upload",className:"hidden",onChange:O,disabled:u}),e.jsx("label",{htmlFor:"ofx-upload",className:`px-6 py-2 bg-brand-600 text-white rounded-lg hover:bg-brand-700 cursor-pointer transition-colors ${u?"opacity-50 pointer-events-none":""}`,children:"Selecionar Arquivo"}),S&&e.jsxs("p",{className:"text-xs text-gray-500",children:["Selecionado: ",S]})]})}),e.jsxs("div",{className:"bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden mt-6",children:[e.jsxs("div",{className:"p-4 border-b border-gray-100 bg-gray-50 flex justify-between items-center",children:[e.jsx("h3",{className:"font-semibold text-gray-700",children:"Lançamentos Bancários"}),e.jsx("span",{className:"text-xs text-gray-400",children:"Ordenado por data (mais recente)"})]}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full text-left text-sm",children:[e.jsx("thead",{className:"bg-white text-gray-500 font-medium border-b border-gray-100",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-6 py-3",children:"Data"}),e.jsx("th",{className:"px-6 py-3",children:"Descrição Banco"}),e.jsx("th",{className:"px-6 py-3",children:"Valor"}),e.jsx("th",{className:"px-6 py-3",children:"Status"}),e.jsx("th",{className:"px-6 py-3 text-right",children:"Ação"})]})}),e.jsxs("tbody",{className:"divide-y divide-gray-100",children:[k.map(a=>{const t=a.tipo==="CREDIT";return e.jsxs("tr",{className:"hover:bg-gray-50",children:[e.jsx("td",{className:"px-6 py-4 text-gray-600",children:q(a.data)}),e.jsx("td",{className:"px-6 py-4 font-medium text-gray-800",children:a.descricao}),e.jsx("td",{className:`px-6 py-4 font-bold ${t?"text-green-600":"text-red-600"}`,children:I(a.valor)}),e.jsx("td",{className:"px-6 py-4",children:a.conciliado?e.jsxs("span",{className:"inline-flex items-center gap-1 px-2 py-1 bg-green-100 text-green-700 rounded-full text-xs font-medium",children:[e.jsx(H,{size:12})," Conciliado"]}):e.jsxs("span",{className:"inline-flex items-center gap-1 px-2 py-1 bg-yellow-100 text-yellow-700 rounded-full text-xs font-medium",children:[e.jsx(G,{size:12})," Pendente"]})}),e.jsx("td",{className:"px-6 py-4 text-right",children:!a.conciliado&&e.jsxs("div",{className:"flex items-center justify-end gap-2",children:[e.jsxs("button",{className:"flex items-center gap-1 px-3 py-1 text-xs border border-brand-200 text-brand-700 bg-brand-50 rounded hover:bg-brand-100 transition-colors opacity-50 cursor-not-allowed",title:"Em breve: Vincular a lançamento já existente",children:[e.jsx(J,{size:12})," Vincular"]}),e.jsxs("button",{onClick:()=>P(a),className:"flex items-center gap-1 px-3 py-1 text-xs bg-brand-600 text-white rounded hover:bg-brand-700 transition-colors",title:"Criar receita/despesa a partir deste item",children:[e.jsx(K,{size:12})," Criar"]})]})})]},a.id)}),k.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:5,className:"text-center py-8 text-gray-400",children:"Nenhum lançamento importado nesta conta."})})]})]})})]})]}),z&&s&&e.jsx("div",{className:"fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4",children:e.jsxs("div",{className:"bg-white rounded-xl shadow-xl max-w-lg w-full p-6",children:[e.jsxs("h2",{className:"text-xl font-bold text-gray-800 mb-1",children:["Nova ",s.tipo==="CREDIT"?"Receita":"Despesa"," (Conciliação)"]}),e.jsxs("div",{className:"mb-4 text-sm text-gray-500 flex gap-2",children:[e.jsx("span",{children:q(s.data)}),e.jsx("span",{children:"•"}),e.jsx("span",{className:s.tipo==="CREDIT"?"text-green-600 font-bold":"text-red-600 font-bold",children:I(s.valor)})]}),e.jsxs("form",{onSubmit:V,className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Descrição"}),e.jsx("input",{required:!0,value:o.description,onChange:a=>f({...o,description:a.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg outline-none focus:ring-brand-500"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Categoria"}),e.jsxs("select",{required:!0,value:o.category_id,onChange:a=>f({...o,category_id:a.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg outline-none bg-white",children:[e.jsx("option",{value:"",children:"Selecione..."}),M.filter(a=>a.tipo===(s.tipo==="CREDIT"?"receita":"despesa")).map(a=>e.jsx("option",{value:a.id,children:a.name},a.id))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:s.tipo==="CREDIT"?"Paciente / Pagador":"Fornecedor"}),e.jsx("input",{value:o.entity_name,onChange:a=>f({...o,entity_name:a.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg outline-none focus:ring-brand-500"})]}),e.jsxs("div",{className:"flex justify-end gap-3 pt-4 border-t border-gray-100 mt-2",children:[e.jsx("button",{type:"button",onClick:()=>v(!1),className:"px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50",children:"Cancelar"}),e.jsxs("button",{type:"submit",disabled:u,className:"px-4 py-2 bg-brand-600 text-white rounded-lg hover:bg-brand-700 flex items-center gap-2",children:[u&&e.jsx(E,{size:16,className:"animate-spin"}),"Confirmar e Conciliar"]})]})]})]})})]})};export{te as default};
