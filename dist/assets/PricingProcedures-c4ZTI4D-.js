import{u as te,r as d,j as e,e as re,s as y}from"./index-HcuLVkXM.js";import{u as oe}from"./useModalControls-BiWM_r1l.js";import{D as se}from"./download-CcofxccE.js";import{U as ae}from"./upload-DlYh6qZH.js";import{P as U}from"./plus-DDz1DOCh.js";import{P as ne}from"./pencil-MoagDD9-.js";import{T as ce}from"./trash-2-FGsD9cgR.js";import{L as ie}from"./loader-2-CJ7EHZdi.js";const le=s=>{const n=(s.match(/,/g)||[]).length;return(s.match(/;/g)||[]).length>n?";":","},de=(s,n)=>{const x=[];let r="",c=!1;for(let l=0;l<s.length;l++){const m=s[l];if(m==='"'){c=!c;continue}m===n&&!c?(x.push(r),r=""):r+=m}return x.push(r),x.map(l=>l.trim())},me=async s=>{const n=await s.arrayBuffer(),r=new TextDecoder("utf-8",{fatal:!1}).decode(n).replace(/^\uFEFF/,"");return r.includes("�")?new TextDecoder("windows-1252",{fatal:!1}).decode(n).replace(/^\uFEFF/,""):r},je=()=>{const{effectiveClinicId:s}=te(),[n,x]=d.useState([]),[r,c]=d.useState({categoria:"",procedimento:"",valor_cobrado:"",custo_insumo:"",tempo_minutos:""}),[l,m]=d.useState(null),[F,I]=d.useState(!1),[T,V]=d.useState(!1),[L,j]=d.useState(!1),[f,v]=d.useState([]),[k,B]=d.useState(""),q=()=>{j(!1),m(null)},R=oe({isOpen:L,onClose:q}),N=async()=>{let t=y.from("procedures").select("*").order("created_at",{ascending:!1});s&&(t=t.eq("clinic_id",s));const{data:a,error:i}=await t;!i&&a&&x(a)};d.useEffect(()=>{N()},[s]);const $=d.useMemo(()=>{if(!k.trim())return n;const t=k.toLowerCase();return n.filter(a=>(a.procedimento||"").toLowerCase().includes(t))},[n,k]);return e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-800",children:"Procedimentos"}),e.jsx("p",{className:"text-gray-500",children:"Precificação • Procedimentos"})]}),e.jsxs("div",{className:"bg-white rounded-xl shadow-sm border border-gray-100 p-6 space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsxs("h2",{className:"text-lg font-semibold text-gray-800 flex items-center gap-2",children:[e.jsx(re,{size:16})," Procedimentos realizados"]}),e.jsx("p",{className:"text-sm text-gray-500",children:"Cadastre procedimentos individualmente ou importe via CSV."})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs("a",{href:`data:text/csv;charset=utf-8,${encodeURIComponent(`#,Categoria,Procedimento,Custo insumo,Tempo (min),Valor cobrado
1,Consulta,Consulta Geral,50,30,200`)}`,download:"modelo_procedimentos.csv",className:"px-3 py-2 text-sm bg-white border border-gray-200 rounded-lg flex items-center gap-2",children:[e.jsx(se,{size:14})," Modelo CSV"]}),e.jsxs("label",{className:`px-3 py-2 text-sm bg-brand-600 text-white rounded-lg flex items-center gap-2 cursor-pointer hover:bg-brand-700 ${T?"opacity-60 pointer-events-none":""}`,children:[e.jsx(ae,{size:14})," ",T?"Importando...":"Importar CSV",e.jsx("input",{type:"file",accept:".csv,text/csv",className:"hidden",onChange:async t=>{if(!t.target.files?.length)return;if(!s){alert("Nenhuma clínica ativa para importar procedimentos.");return}const a=t.target.files[0];V(!0);try{const u=(await me(a)).split(/\r?\n/).filter(o=>o.trim().length>0);if(!u.length)throw new Error("Arquivo vazio");const b=u[0],z=le(b),A=o=>de(o,z),M=A(b).map(o=>o.toLowerCase()),p=M.some(o=>o.includes("procedimento")||o.includes("categoria")),G=p?u.slice(1):u,C=o=>{const w=M.findIndex(g=>o.some(_=>g.includes(_)));return w>=0?w:-1},O=p?C(["categoria"]):-1,Q=p?C(["procedimento"]):-1,H=p?C(["custo"]):-1,J=p?C(["tempo"]):-1,K=p?C(["valor"]):-1,D=G.map(o=>{const w=A(o),g=!p&&w.length>=6?1:0,_=h=>{if(h==null||h==="")return null;const E=h.replace(/\./g,"").replace(",","."),S=Number(E);return Number.isFinite(S)?S:null},P=(h,E)=>{const S=h>=0?h:E;return w[S]??""},W=P(O,g+0),X=P(Q,g+1),Y=P(H,g+2),Z=P(J,g+3),ee=P(K,g+4);return{categoria:W||null,procedimento:X||"",custo_insumo:_(Y),tempo_minutos:_(Z),valor_cobrado:_(ee),clinic_id:s}}).filter(o=>o.procedimento);if(D.length){const{error:o}=await y.from("procedures").insert(D);if(o)throw o;N()}else alert("Nenhuma linha válida encontrada no CSV.")}catch(i){alert("Erro ao importar CSV: "+i.message)}finally{V(!1),t.target.value=""}}})]})]})]}),e.jsxs("div",{className:"flex flex-wrap gap-2 justify-between items-center",children:[e.jsx("input",{type:"text",value:k,onChange:t=>B(t.target.value),placeholder:"Buscar procedimento...",className:"px-3 py-2 border border-gray-300 rounded-lg text-sm outline-none focus:ring-2 focus:ring-brand-500 flex-1 min-w-[220px]"}),e.jsx("button",{onClick:async()=>{if(!f.length||!confirm("Apagar procedimentos selecionados?"))return;const{error:t}=await y.from("procedures").delete().in("id",f);t||(v([]),N())},className:"px-4 py-2 bg-red-50 text-red-700 rounded-lg border border-red-200 text-sm mr-2 disabled:opacity-50",disabled:!f.length,children:"Apagar selecionados"}),e.jsxs("button",{onClick:()=>{m(null),c({categoria:"",procedimento:"",valor_cobrado:"",custo_insumo:"",tempo_minutos:""}),j(!0)},className:"px-4 py-2 bg-brand-600 text-white rounded-lg hover:bg-brand-700 flex items-center gap-2",children:[e.jsx(U,{size:16})," Novo procedimento"]})]}),e.jsx("div",{className:"border border-gray-100 rounded-lg overflow-hidden",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{className:"bg-gray-50 text-gray-600 border-b",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-2",children:e.jsx("input",{type:"checkbox",checked:f.length>0&&f.length===n.length,onChange:t=>{t.target.checked?v(n.map(a=>a.id)):v([])}})}),e.jsx("th",{className:"px-4 py-2 text-left",children:"#"}),e.jsx("th",{className:"px-4 py-2 text-left",children:"Categoria"}),e.jsx("th",{className:"px-4 py-2 text-left",children:"Procedimento"}),e.jsx("th",{className:"px-4 py-2 text-left",children:"Custo insumo"}),e.jsx("th",{className:"px-4 py-2 text-left",children:"Tempo (min)"}),e.jsx("th",{className:"px-4 py-2 text-left",children:"Valor cobrado"}),e.jsx("th",{className:"px-4 py-2 text-right",children:"Ações"})]})}),e.jsxs("tbody",{className:"divide-y divide-gray-100",children:[$.map((t,a)=>{const i=f.includes(t.id);return e.jsxs("tr",{className:"hover:bg-gray-50",children:[e.jsx("td",{className:"px-4 py-2 text-gray-700",children:e.jsx("input",{type:"checkbox",checked:i,onChange:u=>{u.target.checked?v(b=>[...b,t.id]):v(b=>b.filter(z=>z!==t.id))}})}),e.jsx("td",{className:"px-4 py-2 text-gray-700",children:a+1}),e.jsx("td",{className:"px-4 py-2 text-gray-700",children:t.categoria||"-"}),e.jsx("td",{className:"px-4 py-2 font-semibold text-gray-800",children:t.procedimento}),e.jsx("td",{className:"px-4 py-2 text-gray-700",children:t.custo_insumo??"-"}),e.jsx("td",{className:"px-4 py-2 text-gray-700",children:t.tempo_minutos??"-"}),e.jsx("td",{className:"px-4 py-2 text-gray-700",children:t.valor_cobrado??"-"}),e.jsx("td",{className:"px-4 py-2 text-right",children:e.jsxs("div",{className:"flex items-center justify-end gap-2",children:[e.jsx("button",{type:"button",title:"Editar",onClick:()=>{m(t.id),c({categoria:t.categoria||"",procedimento:t.procedimento||"",valor_cobrado:t.valor_cobrado||"",custo_insumo:t.custo_insumo||"",tempo_minutos:t.tempo_minutos||""}),j(!0)},className:"w-8 h-8 rounded-full border border-brand-100 text-brand-600 inline-flex items-center justify-center hover:border-brand-200",children:e.jsx(ne,{size:14})}),e.jsx("button",{type:"button",title:"Apagar",onClick:async()=>{if(!confirm("Excluir procedimento?"))return;const{error:u}=await y.from("procedures").delete().eq("id",t.id);u||N()},className:"w-8 h-8 rounded-full border border-rose-100 text-rose-600 inline-flex items-center justify-center hover:border-rose-200",children:e.jsx(ce,{size:14})})]})})]},t.id)}),n.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:8,className:"px-4 py-6 text-center text-sm text-gray-400",children:"Nenhum procedimento cadastrado."})})]})]})}),L&&e.jsx("div",{className:"fixed inset-0 bg-black/40 flex items-center justify-center z-50",onClick:R.onBackdropClick,children:e.jsxs("div",{className:"bg-white rounded-xl shadow-xl p-6 w-full max-w-2xl space-y-4",onClick:t=>t.stopPropagation(),children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h4",{className:"text-lg font-semibold text-gray-800",children:l?"Editar procedimento":"Novo procedimento"}),e.jsx("button",{onClick:q,className:"text-gray-500 hover:text-gray-700",children:"✕"})]}),e.jsxs("form",{onSubmit:async t=>{if(t.preventDefault(),!!r.procedimento.trim()){if(!s){alert("Nenhuma clínica ativa para salvar procedimento.");return}I(!0);try{const a={categoria:r.categoria||null,procedimento:r.procedimento,valor_cobrado:r.valor_cobrado?Number(r.valor_cobrado):null,custo_insumo:r.custo_insumo?Number(r.custo_insumo):null,tempo_minutos:r.tempo_minutos?Number(r.tempo_minutos):null,clinic_id:s};if(l){const{error:i}=await y.from("procedures").update(a).eq("id",l);if(i)throw i}else{const{error:i}=await y.from("procedures").insert([a]);if(i)throw i}c({categoria:"",procedimento:"",valor_cobrado:"",custo_insumo:"",tempo_minutos:""}),m(null),j(!1),N()}catch(a){alert("Erro ao salvar procedimento: "+a.message)}finally{I(!1)}}},className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Categoria"}),e.jsx("input",{value:r.categoria,onChange:t=>c({...r,categoria:t.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-brand-500 outline-none",placeholder:"Ex: Consulta"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Procedimento"}),e.jsx("input",{required:!0,value:r.procedimento,onChange:t=>c({...r,procedimento:t.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-brand-500 outline-none",placeholder:"Nome do procedimento"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Valor cobrado"}),e.jsx("input",{type:"number",value:r.valor_cobrado,onChange:t=>c({...r,valor_cobrado:t.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-brand-500 outline-none"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Custo insumo"}),e.jsx("input",{type:"number",value:r.custo_insumo,onChange:t=>c({...r,custo_insumo:t.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-brand-500 outline-none"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Tempo (min)"}),e.jsx("input",{type:"number",value:r.tempo_minutos,onChange:t=>c({...r,tempo_minutos:t.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-brand-500 outline-none"})]}),e.jsxs("div",{className:"flex items-end gap-2",children:[e.jsx("button",{type:"button",onClick:()=>{j(!1),m(null)},className:"px-4 py-2 bg-gray-100 text-gray-700 rounded-lg",children:"Cancelar"}),e.jsxs("button",{type:"submit",disabled:F,className:"px-4 py-2 bg-brand-600 text-white rounded-lg hover:bg-brand-700 disabled:opacity-50 flex items-center gap-2",children:[F?e.jsx(ie,{size:16,className:"animate-spin"}):e.jsx(U,{size:16}),l?"Atualizar":"Salvar"]})]})]})]})})]})]})};export{je as default};
