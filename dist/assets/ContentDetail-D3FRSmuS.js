import{i as st,a as rt,u as nt,r,j as e,L as he,s as k}from"./index-HcuLVkXM.js";import{u as at}from"./useModalControls-BiWM_r1l.js";const ot=o=>o?/\.(mp4|m3u8|webm|ogg)(\?|#|$)/i.test(o):!1,it=(o,n)=>{if(!o)return null;if(!n||n<=0)return o;const m=Math.max(0,Math.floor(n));try{const y=new URL(o);return y.searchParams.set("t",String(m)),y.toString()}catch{const y=o.includes("?")?"&":"?";return`${o}${y}t=${m}`}},pe=o=>{if(!o)return null;if(typeof o=="string")try{const m=JSON.parse(o);return pe(m)}catch{return null}if(typeof o!="object")return null;const n=o;return typeof n.currentTime=="number"?n.currentTime:typeof n.seconds=="number"?n.seconds:typeof n.time=="number"?n.time:n.data?pe(n.data):null},ge=o=>{if(!o)return null;if(typeof o=="string")try{const m=JSON.parse(o);return ge(m)}catch{return null}if(typeof o!="object")return null;const n=o;return typeof n.duration=="number"?n.duration:typeof n.totalDuration=="number"?n.totalDuration:n.data?ge(n.data):null},ye=o=>{if(!o)return null;if(typeof o=="string")try{const m=JSON.parse(o);return ye(m)}catch{return o}if(typeof o!="object")return null;const n=o;return typeof n.eventName=="string"?n.eventName:typeof n.event_type=="string"?n.event_type:typeof n.status=="string"?n.status:typeof n.event=="string"?n.event:typeof n.type=="string"?n.type:typeof n.name=="string"?n.name:typeof n.action=="string"?n.action:n.data?ye(n.data):null},lt=o=>{if(!o)return!1;try{return new URL(o).hostname.includes("pandavideo")}catch{return o.includes("pandavideo")}},ut=()=>{const{type:o,contentId:n}=st(),[m,y]=rt(),{clinicId:be,clinicPackageIds:Q}=nt(),U=r.useMemo(()=>m.get("lesson"),[m]),[De,b]=r.useState(!0),[we,q]=r.useState(null),[w,ve]=r.useState(null),[c,X]=r.useState([]),[i,je]=r.useState(null),[R,Oe]=r.useState("description"),[Y,M]=r.useState(""),[Fe,v]=r.useState(""),[Z,j]=r.useState(!1),[D,ee]=r.useState([]),[z,Ne]=r.useState(!1),[te,se]=r.useState(null),[O,re]=r.useState([]),[Ve,ne]=r.useState({}),[J,Se]=r.useState(!1),[ae,oe]=r.useState(null),[ie,_e]=r.useState(!1),[Ue,le]=r.useState({}),[g,K]=r.useState(0),[Ce,ce]=r.useState({}),A=r.useRef(0),N=r.useRef(null),Le=r.useRef(null),de=r.useRef(null),ue=o==="courses"?"Cursos":"Treinamentos",ze=o==="courses"?"Curso":"Treinamento",me=o==="courses"?"/contents/courses":"/contents/trainings";r.useEffect(()=>{(async()=>{if(!n||!o){q("Conteúdo inválido."),b(!1);return}if(o!=="courses"&&o!=="trainings"){q("Tipo de conteúdo inválido."),b(!1);return}b(!0),q(null);try{if(be&&Q.length){const{data:u,error:Re}=await k.from("content_package_items").select("id").in("package_id",Q).eq("content_id",n).maybeSingle();if(Re)throw Re;if(!u){q("Conteúdo não liberado para sua clínica."),b(!1);return}}const s=o==="courses"?"course":"training",{data:a,error:l}=await k.from("content_items").select("id, title, description, thumbnail_url").eq("id",n).eq("type",s).maybeSingle();if(l)throw l;ve(a||null);const{data:d,error:p}=await k.from("content_modules").select("id, title, order_index, thumbnail_url").eq("content_id",n).order("order_index",{ascending:!0});if(p)throw p;const E=d||[];if(!E.length){X([]),b(!1);return}const T=E.map(u=>u.id),{data:Ze,error:qe}=await k.from("content_lessons").select("id, module_id, title, description, panda_video_id, panda_video_url, order_index").in("module_id",T).order("order_index",{ascending:!0});if(qe)throw qe;const et=Ze||[],H={};et.forEach(u=>{u.module_id&&(H[u.module_id]||(H[u.module_id]=[]),H[u.module_id].push(u))});const tt=E.map(u=>({...u,lessons:H[u.id]||[]}));X(tt),b(!1)}catch(s){const a=s.message||"Erro inesperado ao carregar conteúdo.";q(a),ve(null),X([]),b(!1)}})()},[n,o,be,Q]);const S=r.useMemo(()=>i?`lesson-notes:${i}`:null,[i]),P=r.useMemo(()=>i?`lesson-video-progress:${i}`:null,[i]),$=r.useMemo(()=>n?`content-progress:${n}`:null,[n]),W=r.useCallback(t=>{if(!(!$||typeof window>"u"))try{window.localStorage.setItem($,JSON.stringify({lessonId:t||i||null,updatedAt:Date.now()}))}catch{}},[$,i]),Ee=r.useCallback(t=>{i&&ce(s=>{const a={...s};return t>0?a[i]=t:delete a[i],a})},[i]),_=r.useCallback(t=>{if(!P||typeof window>"u")return;const s=Math.max(0,Math.floor(t));if(s!==A.current){A.current=s;try{window.localStorage.setItem(P,String(s)),s>0&&W(),Ee(s)}catch{}}},[P,W,Ee]),x=r.useCallback(()=>{N.current&&_(N.current.currentTime||0)},[_]),C=r.useCallback((t,s=!1)=>{x(),W(t),je(t),y({lesson:t},{replace:s})},[x,y,W]);r.useEffect(()=>{if(!S){M(""),v(""),j(!1);return}if(!(typeof window>"u"))try{const s=window.localStorage.getItem(S)||"";M(s),v(s),j(s.length===0)}catch{M(""),v(""),j(!0)}},[S]),r.useEffect(()=>{if(!P){K(0),A.current=0;return}if(!(typeof window>"u"))try{const t=window.localStorage.getItem(P),s=t?Number(t):0,a=Number.isFinite(s)?s:0;K(a),A.current=0}catch{K(0),A.current=0}},[P]),r.useEffect(()=>{if(N.current&&!(g<=0))try{N.current.currentTime=g}catch{}},[g]),r.useEffect(()=>{if(typeof window>"u")return;const t=()=>{document.hidden&&x()};return window.addEventListener("beforeunload",x),document.addEventListener("visibilitychange",t),()=>{window.removeEventListener("beforeunload",x),document.removeEventListener("visibilitychange",t)}},[x]),r.useEffect(()=>{(async()=>{if(!i){ee([]),se(null);return}Ne(!0),se(null);try{const{data:s,error:a}=await k.from("content_lesson_files").select("id, file_name, file_url, created_at").eq("lesson_id",i).order("created_at",{ascending:!1});if(a)throw a;ee(s||[])}catch(s){se(s.message),ee([])}Ne(!1)})()},[i]),r.useEffect(()=>{(async()=>{if(!n){re([]),oe(null);return}Se(!0),oe(null);try{let s=k.from("content_comments").select("id, content, status, created_at, student_user_id").eq("content_id",n).order("created_at",{ascending:!1});i&&(s=s.eq("lesson_id",i));const{data:a,error:l}=await s;if(l)throw l;re(a||[])}catch(s){oe(s.message),re([])}Se(!1)})()},[n,i]),r.useEffect(()=>{if(!c.length){le({});return}le(t=>{const s={};return c.forEach(a=>{s[a.id]=t[a.id]??!0}),s})},[c]),r.useEffect(()=>{(async()=>{const s=Array.from(new Set(O.map(a=>a.student_user_id).filter(a=>!!a)));if(!s.length){ne({});return}try{const{data:a,error:l}=await k.from("profiles").select("id, full_name").in("id",s);if(l)throw l;const d={};(a||[]).forEach(p=>{d[p.id]=p.full_name||"Usuário"}),ne(d)}catch{ne({})}})()},[O]);const h=r.useMemo(()=>{if(!i)return null;for(const t of c){const s=t.lessons.find(a=>a.id===i);if(s)return s}return null},[c,i]),f=r.useMemo(()=>[...c].sort((s,a)=>(s.order_index??0)-(a.order_index??0)).flatMap(s=>[...s.lessons].sort((a,l)=>(a.order_index??0)-(l.order_index??0))),[c]),Je=r.useCallback(()=>{if(!(typeof window>"u")){if(f.forEach(t=>{try{window.localStorage.removeItem(`lesson-video-progress:${t.id}`)}catch{}}),$)try{window.localStorage.removeItem($)}catch{}ce({}),K(0),A.current=0}},[f,$]),B=r.useCallback(()=>{if(typeof window>"u")return;const t={};f.forEach(s=>{try{const a=window.localStorage.getItem(`lesson-video-progress:${s.id}`),l=a?Number(a):0;Number.isFinite(l)&&l>0&&(t[s.id]=l)}catch{}}),ce(t)},[f]);r.useEffect(()=>{B()},[B]),r.useEffect(()=>{if(typeof window>"u")return;const t=s=>{s.key?.startsWith("lesson-video-progress:")&&B()};return window.addEventListener("storage",t),()=>window.removeEventListener("storage",t)},[B]);const F=r.useMemo(()=>i?f.findIndex(t=>t.id===i):-1,[f,i]),ke=r.useMemo(()=>i&&c.find(t=>t.lessons.some(s=>s.id===i))||null,[c,i]),fe=F>0?f[F-1]:null,I=F>=0&&F<f.length-1?f[F+1]:null,V=f.length,Me=f.filter(t=>Ce[t.id]>0).length,Ae=V?Math.min(100,Math.round(Me/V*100)):0,G=r.useCallback(()=>{!I||!i||de.current!==i&&(de.current=i,C(I.id))},[I,C,i]);r.useEffect(()=>{de.current=null},[i]),r.useEffect(()=>{if(typeof window>"u")return;const t=s=>{const a=Le.current?.contentWindow||null;if(!(a&&s.source===a)&&!lt(s.origin))return;const d=pe(s.data);typeof d=="number"&&Number.isFinite(d)&&_(d);const p=ye(s.data),E=ge(s.data);if(p){const T=p.toLowerCase();(T.includes("ended")||T.includes("finish")||T.includes("complete")||T==="end")&&G();return}typeof d=="number"&&typeof E=="number"&&E>0&&d>=E-.5&&G()};return window.addEventListener("message",t),()=>window.removeEventListener("message",t)},[_,G]);const Pe=r.useMemo(()=>c,[c]),Ke=r.useCallback(()=>{x(),_e(t=>!t)},[x]),$e=r.useCallback(()=>{x(),_e(!1)},[x]),We=at({isOpen:ie,onClose:$e});r.useEffect(()=>{const t=c.flatMap(a=>a.lessons);if(U&&t.some(l=>l.id===U)){je(U);return}const s=t[0];s&&C(s.id,!0)},[c,U,C]);const Be=t=>{M(t)},Ge=()=>{if(!(!S||typeof window>"u"))try{window.localStorage.setItem(S,Y),v(Y),j(!1)}catch{v("")}},He=()=>{if(!(!S||typeof window>"u"))try{window.localStorage.removeItem(S),M(""),v(""),j(!1)}catch{M(""),v(""),j(!0)}},Qe=D.length===1?"1 arquivo":`${D.length} arquivos`,L=r.useMemo(()=>h?h.panda_video_url||(h.panda_video_id?`https://player.pandavideo.com.br/embed/?v=${h.panda_video_id}`:null):null,[h]),xe=r.useMemo(()=>ot(L),[L]),Ie=r.useCallback(t=>{if(!t)return null;try{const s=new URL(t);return s.searchParams.set("autoplay","1"),s.toString()}catch{const s=t.includes("?")?"&":"?";return`${t}${s}autoplay=1`}},[]),Xe=r.useMemo(()=>xe?null:Ie(it(L,g)),[L,xe,g,Ie]),Te=e.jsxs("div",{className:"overflow-hidden rounded-2xl border border-gray-100 bg-white shadow-sm",children:[L?e.jsx("div",{className:"w-full aspect-video bg-black",children:xe?e.jsx("video",{ref:N,src:L,controls:!0,autoPlay:!0,playsInline:!0,className:"w-full h-full",onLoadedMetadata:()=>{g>0&&N.current&&(N.current.currentTime=g)},onTimeUpdate:t=>_(t.currentTarget.currentTime),onPause:t=>_(t.currentTarget.currentTime),onEnded:()=>{_(0),G()}}):e.jsx("iframe",{ref:Le,src:Xe||L,title:h?.title||"Aula",className:"w-full h-full",allow:"autoplay; fullscreen; picture-in-picture",allowFullScreen:!0},`${h?.id||"lesson"}-${Math.floor(g)}`)}):e.jsx("div",{className:"flex items-center justify-center h-56 text-sm text-gray-500",children:"Link do vídeo não informado."}),e.jsxs("div",{className:"p-4 flex flex-wrap items-center justify-between gap-4",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-[11px] uppercase tracking-[0.3em] text-gray-400",children:"Aula atual"}),e.jsx("h2",{className:"text-lg font-semibold text-gray-900",children:h?.title||"Selecione uma aula"}),ke&&e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:ke.title||"Módulo"})]}),e.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[e.jsx("button",{type:"button",onClick:()=>fe&&C(fe.id),disabled:!fe,className:"px-3 py-2 text-xs rounded-lg border border-gray-200 text-gray-600 hover:bg-gray-50 disabled:opacity-50",children:"Aula anterior"}),e.jsx("button",{type:"button",onClick:()=>I&&C(I.id),disabled:!I,className:"px-3 py-2 text-xs rounded-lg border border-gray-200 text-gray-600 hover:bg-gray-50 disabled:opacity-50",children:"Próxima aula"})]})]})]}),Ye=e.jsxs("div",{className:"bg-white border border-gray-100 rounded-2xl p-4 space-y-4 shadow-sm",children:[e.jsx("div",{className:"flex flex-wrap gap-2 border-b border-gray-100 pb-2",children:[{key:"description",label:"Descrição"},{key:"notes",label:"Anotações"},{key:"comments",label:"Comentários"},{key:"files",label:`Arquivos • ${Qe}`}].map(t=>e.jsx("button",{type:"button",onClick:()=>Oe(t.key),className:`px-3 py-2 text-sm rounded-lg border ${R===t.key?"bg-brand-600 text-white border-brand-600":"bg-white text-gray-700 border-gray-200"}`,children:t.label},t.key))}),e.jsxs("div",{className:"pt-2",children:[R==="description"&&e.jsx("div",{className:"space-y-2 text-sm text-gray-600",children:h?.description?e.jsx("p",{children:h.description}):w?.description?e.jsx("p",{children:w?.description}):e.jsx("p",{children:"Sem descrição disponível."})}),R==="notes"&&e.jsxs("div",{className:"space-y-2",children:[e.jsx("textarea",{value:Y,onChange:t=>Be(t.target.value),placeholder:"Escreva suas anotações aqui...",rows:5,readOnly:!Z,className:`w-full px-3 py-2 border rounded-lg text-sm ${Z?"border-gray-300":"border-gray-200 bg-gray-50"}`}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsx("button",{type:"button",onClick:Ge,disabled:!Z,className:"px-3 py-2 text-xs rounded-lg bg-brand-600 text-white disabled:opacity-50",children:"Gravar"}),e.jsx("button",{type:"button",onClick:()=>j(!0),className:"px-3 py-2 text-xs rounded-lg border border-gray-200 text-gray-600 hover:bg-gray-50",children:"Editar"}),e.jsx("button",{type:"button",onClick:He,className:"px-3 py-2 text-xs rounded-lg border border-red-200 text-red-600 hover:bg-red-50",children:"Apagar"})]}),e.jsx("p",{className:"text-xs text-gray-400",children:Fe?"Anotação salva neste navegador.":"Nenhuma anotação salva."})]}),R==="comments"&&e.jsxs("div",{className:"space-y-3 text-sm text-gray-600",children:[J&&e.jsx("p",{children:"Carregando comentários..."}),!J&&ae&&e.jsx("p",{children:"Comentários indisponíveis no momento."}),!J&&!ae&&O.length===0&&e.jsx("p",{children:"Nenhum comentário."}),!J&&!ae&&O.length>0&&e.jsx("div",{className:"space-y-3",children:O.map(t=>e.jsxs("div",{className:"border border-gray-100 rounded-lg p-3",children:[e.jsxs("p",{className:"text-xs text-gray-400",children:[Ve[t.student_user_id||""]||"Usuário"," •"," ",t.created_at?.slice(0,10)||"Sem data"]}),e.jsx("p",{className:"text-sm text-gray-700 mt-1",children:t.content||"Sem conteúdo."})]},t.id))})]}),R==="files"&&e.jsxs("div",{className:"space-y-2 text-sm text-gray-600",children:[z&&e.jsx("p",{children:"Carregando arquivos..."}),!z&&te&&e.jsx("p",{children:"Arquivos indisponíveis no momento."}),!z&&!te&&D.length===0&&e.jsx("p",{children:"Nenhum arquivo disponível."}),!z&&!te&&D.length>0&&e.jsx("div",{className:"space-y-2",children:D.map(t=>e.jsxs("a",{href:t.file_url||"#",target:"_blank",rel:"noreferrer",className:"flex items-center justify-between border border-gray-100 rounded-lg p-3 hover:bg-gray-50",children:[e.jsx("span",{children:t.file_name||"Arquivo"}),e.jsx("span",{className:"text-xs text-gray-400",children:"Abrir"})]},t.id))})]})]})]});return De?e.jsx("div",{className:"h-48 flex items-center justify-center text-gray-500",children:"Carregando conteúdo..."}):we?e.jsxs("div",{className:"space-y-3",children:[e.jsx("h1",{className:"text-xl font-semibold text-gray-800",children:"Erro ao carregar conteúdo"}),e.jsx("p",{className:"text-sm text-gray-500",children:we}),e.jsxs(he,{className:"text-brand-600 hover:underline",to:me,children:["Voltar para ",ue]})]}):w?e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex flex-wrap items-center justify-between gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs(he,{className:"inline-flex items-center gap-2 text-sm text-brand-600 hover:underline",to:me,children:["← Voltar para ",ue]}),e.jsx("h1",{className:"text-2xl font-bold text-gray-800",children:w.title||"Sem título"}),w.description&&e.jsx("p",{className:"text-gray-500",children:w.description})]}),e.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[e.jsx("button",{type:"button",onClick:Je,className:"px-3 py-2 text-sm rounded-lg border border-red-200 text-red-600 hover:bg-red-50",children:"Apagar progresso"}),e.jsx("button",{type:"button",onClick:Ke,className:"px-3 py-2 text-sm rounded-lg border border-gray-200 bg-white text-gray-700 hover:bg-gray-50",children:ie?"Acender as luzes":"Apagar as luzes"})]})]}),ie&&e.jsx("div",{className:"fixed inset-0 bg-black/80 z-50 overflow-y-auto",onClick:We.onBackdropClick,children:e.jsx("div",{className:"min-h-full flex items-center justify-center p-6",children:e.jsxs("div",{className:"w-full max-w-6xl",onClick:t=>t.stopPropagation(),children:[e.jsx("div",{className:"flex justify-end pb-3",children:e.jsx("button",{type:"button",onClick:$e,className:"px-3 py-2 text-sm rounded-lg border border-gray-200 bg-white text-gray-700 hover:bg-gray-50",children:"Acender as luzes"})}),Te]})})}),e.jsxs("div",{className:"grid grid-cols-1 xl:grid-cols-[minmax(0,1fr)_360px] gap-6",children:[e.jsxs("div",{className:"space-y-4",children:[Te,Ye]}),e.jsxs("aside",{className:"rounded-2xl bg-[#0883c6] text-white p-5 space-y-5 shadow-lg",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx("p",{className:"text-xs uppercase tracking-[0.3em] text-white/70",children:ze}),e.jsx("h2",{className:"text-xl font-semibold text-white",children:w.title||"Sem título"}),e.jsxs("p",{className:"text-xs text-white/70",children:[c.length," módulo",c.length===1?"":"s"," • ",V," aula",V===1?"":"s"]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between text-xs text-white/70",children:[e.jsx("span",{children:"Progresso do curso"}),e.jsxs("span",{className:"text-sm font-semibold text-white",children:[Ae,"%"]})]}),e.jsx("div",{className:"h-2 rounded-full bg-white/10",children:e.jsx("div",{className:"h-2 rounded-full bg-brand-500 transition-all",style:{width:`${Ae}%`}})}),e.jsxs("p",{className:"text-xs text-white/70",children:[Me," de ",V," aulas assistidas"]})]}),e.jsx("div",{className:"space-y-3 max-h-[60vh] overflow-y-auto pr-1",children:Pe.length===0?e.jsx("p",{className:"text-xs text-white/70",children:"Nenhuma aula publicada."}):Pe.map((t,s)=>e.jsxs("details",{open:Ue[t.id],onToggle:a=>{const l=a.currentTarget?.open??!1;le(d=>({...d,[t.id]:l}))},className:"rounded-2xl border border-white/10 bg-white/5 p-3",children:[e.jsxs("summary",{className:"flex items-center justify-between cursor-pointer",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-semibold text-white",children:t.title||`Módulo ${s+1}`}),e.jsxs("p",{className:"text-xs text-white/70",children:[t.lessons.length," aula",t.lessons.length===1?"":"s"]})]}),e.jsx("span",{className:"text-xs text-white/70",children:"Ver aulas"})]}),e.jsxs("div",{className:"mt-3 space-y-2",children:[t.lessons.length===0&&e.jsx("p",{className:"text-xs text-white/70",children:"Sem aulas neste módulo."}),t.lessons.map((a,l)=>{const d=i===a.id,p=Ce[a.id]>0;return e.jsx("button",{type:"button",onClick:()=>C(a.id),className:`w-full text-left rounded-xl border px-3 py-2 transition ${d?"border-brand-500 bg-brand-500/10":"border-white/10 hover:bg-white/10"}`,children:e.jsxs("div",{className:"flex flex-col gap-3 sm:flex-row sm:items-center",children:[e.jsx("div",{className:"h-16 w-full sm:w-24 flex-shrink-0 overflow-hidden rounded-lg bg-slate-800",children:t.thumbnail_url?e.jsx("img",{src:t.thumbnail_url,alt:t.title||"Módulo",className:"h-full w-full object-cover"}):e.jsx("div",{className:"h-full w-full bg-gradient-to-br from-slate-700 via-slate-800 to-slate-700"})}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("span",{className:"text-xs text-white/60",children:[l+1,"."]}),e.jsx("p",{className:"text-sm font-semibold text-white",children:a.title||"Aula"}),e.jsx("span",{className:`ml-auto h-2 w-2 rounded-full ${p?"bg-emerald-400":"bg-white/20"}`})]}),a.description&&e.jsx("p",{className:"mt-1 text-xs text-white/80 line-clamp-2",children:a.description})]})]})},a.id)})]})]},t.id))})]})]})]}):e.jsxs("div",{className:"space-y-3",children:[e.jsx("h1",{className:"text-xl font-semibold text-gray-800",children:"Conteúdo não encontrado"}),e.jsxs(he,{className:"text-brand-600 hover:underline",to:me,children:["Voltar para ",ue]})]})};export{ut as default};
