import{u as z,r as n,j as e}from"./index-HcuLVkXM.js";import{x as K,y as R,S as T,z as B,a as H,b as X,A as F,B as G}from"./service-C61pE4fL.js";import{D as J}from"./DataTable-BxUe0ZZe.js";import{I as Q}from"./ItemPicker-DiZaaD8I.js";import{P as U}from"./plus-DDz1DOCh.js";import{X as v}from"./x-Dm__mln4.js";const te=()=>{const{effectiveClinicId:_,user:x}=z(),d=_,[u,N]=n.useState([]),[y,C]=n.useState([]),[p,q]=n.useState([]),[w,f]=n.useState(!0),[S,i]=n.useState(!1),[I,h]=n.useState(!1),[m,k]=n.useState(null),[g,D]=n.useState(()=>new Date().toISOString().split("T")[0]),[j,b]=n.useState(""),[l,c]=n.useState([{item_id:"",counted_qty:0,expected_qty:0,diff_qty:0}]),O=n.useMemo(()=>new Map(p.map(t=>[t.item_id,t.qty_on_hand||0])),[p]),o=async()=>{if(d){f(!0);try{const[t,a,s]=await Promise.all([B(d),H(d),X(d)]);N(t),C(a),q(s)}finally{f(!1)}}};n.useEffect(()=>{o()},[d]);const L=(t,a)=>{const s=O.get(a)||0,r=[...l];r[t]={...r[t],item_id:a,expected_qty:s,diff_qty:(r[t].counted_qty||0)-s},c(r)},E=(t,a)=>{const s=[...l],r=s[t].expected_qty||0;s[t]={...s[t],counted_qty:a,diff_qty:a-r},c(s)},A=()=>c([...l,{item_id:"",counted_qty:0,expected_qty:0,diff_qty:0}]),M=async()=>{if(!d||!x)return;const t=await F({clinic_id:d,count_date:g,status:"draft",notes:j,created_by:x.id}),a=l.filter(s=>s.item_id).map(s=>({clinic_id:d,count_id:t.id,item_id:s.item_id,expected_qty:s.expected_qty,counted_qty:s.counted_qty,diff_qty:s.diff_qty}));a.length&&await G(a),i(!1),c([{item_id:"",counted_qty:0,expected_qty:0,diff_qty:0}]),b(""),await o()},P=n.useMemo(()=>[{header:"Data",accessorKey:"count_date"},{header:"Status",accessorKey:"status"},{header:"Linhas",accessorKey:"inventory_count_lines",cell:({row:t})=>t.original.inventory_count_lines?.length||0},{header:"Ações",cell:({row:t})=>e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{className:"rounded-md border border-gray-200 px-2 py-1 text-xs",onClick:()=>{k(t.original),h(!0)},children:"Detalhar"}),t.original.status==="draft"?e.jsx("button",{className:"rounded-md border border-amber-200 px-2 py-1 text-xs text-amber-700",onClick:async()=>{await K(t.original.id),await o()},children:"Enviar"}):null,t.original.status==="submitted"?e.jsx("button",{className:"rounded-md border border-emerald-200 px-2 py-1 text-xs text-emerald-700",onClick:async()=>{await R(t.original.id),await o()},children:"Aprovar"}):null]})}],[u]);return d?e.jsxs("div",{className:"space-y-6",children:[e.jsx(T,{title:"Contagem Cíclica",subtitle:"Registre divergências e aprove para gerar ajustes automáticos.",actions:e.jsxs("button",{className:"inline-flex items-center gap-2 rounded-md bg-emerald-600 px-4 py-2 text-sm text-white",onClick:()=>i(!0),children:[e.jsx(U,{className:"h-4 w-4"})," Nova contagem"]})}),w?e.jsx("div",{className:"text-sm text-gray-500",children:"Carregando contagens..."}):e.jsx(J,{data:u,columns:P}),S?e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/40 p-4",children:e.jsxs("div",{className:"w-full max-w-4xl rounded-2xl bg-white p-6 shadow-xl",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:"Nova contagem"}),e.jsx("p",{className:"text-sm text-gray-500",children:"Informe os itens contados e as divergências."})]}),e.jsx("button",{className:"rounded-full p-2 hover:bg-gray-100",onClick:()=>i(!1),children:e.jsx(v,{className:"h-4 w-4"})})]}),e.jsxs("div",{className:"mt-6 grid gap-4 md:grid-cols-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-gray-600",children:"Data"}),e.jsx("input",{type:"date",className:"mt-1 w-full rounded-md border border-gray-200 px-3 py-2 text-sm",value:g,onChange:t=>D(t.target.value)})]}),e.jsxs("div",{className:"md:col-span-2",children:[e.jsx("label",{className:"text-xs font-medium text-gray-600",children:"Observações"}),e.jsx("input",{className:"mt-1 w-full rounded-md border border-gray-200 px-3 py-2 text-sm",value:j,onChange:t=>b(t.target.value)})]})]}),e.jsxs("div",{className:"mt-4 space-y-3",children:[l.map((t,a)=>e.jsxs("div",{className:"grid gap-3 rounded-lg border border-gray-200 p-3 md:grid-cols-5",children:[e.jsxs("div",{className:"md:col-span-2",children:[e.jsx("label",{className:"text-xs text-gray-600",children:"Item"}),e.jsx(Q,{items:y,value:t.item_id,onChange:s=>L(a,s)})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs text-gray-600",children:"Esperado"}),e.jsx("input",{className:"mt-1 w-full rounded-md border border-gray-200 px-3 py-2 text-sm",value:t.expected_qty,readOnly:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs text-gray-600",children:"Contado"}),e.jsx("input",{type:"number",step:"0.01",className:"mt-1 w-full rounded-md border border-gray-200 px-3 py-2 text-sm",value:t.counted_qty,onChange:s=>E(a,Number(s.target.value||0))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs text-gray-600",children:"Diferença"}),e.jsx("input",{className:"mt-1 w-full rounded-md border border-gray-200 px-3 py-2 text-sm",value:t.diff_qty,readOnly:!0})]})]},a)),e.jsx("button",{className:"rounded-md border border-gray-200 px-3 py-2 text-xs",onClick:A,children:"Adicionar item"})]}),e.jsxs("div",{className:"mt-6 flex justify-end gap-2",children:[e.jsx("button",{className:"rounded-md border border-gray-200 px-4 py-2 text-sm",onClick:()=>i(!1),children:"Cancelar"}),e.jsx("button",{className:"rounded-md bg-emerald-600 px-4 py-2 text-sm text-white",onClick:M,children:"Salvar contagem"})]})]})}):null,I&&m?e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/40 p-4",children:e.jsxs("div",{className:"w-full max-w-3xl rounded-2xl bg-white p-6 shadow-xl",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:"Detalhes da contagem"}),e.jsxs("p",{className:"text-sm text-gray-500",children:["Status: ",m.status]})]}),e.jsx("button",{className:"rounded-full p-2 hover:bg-gray-100",onClick:()=>h(!1),children:e.jsx(v,{className:"h-4 w-4"})})]}),e.jsx("div",{className:"mt-4 space-y-2",children:(m.inventory_count_lines||[]).map(t=>e.jsxs("div",{className:"flex items-center justify-between rounded-md border border-gray-200 px-3 py-2 text-sm",children:[e.jsx("span",{children:y.find(a=>a.id===t.item_id)?.name||"Item"}),e.jsxs("span",{children:["Esperado: ",t.expected_qty??0]}),e.jsxs("span",{children:["Contado: ",t.counted_qty??0]}),e.jsxs("span",{children:["Dif: ",t.diff_qty??0]})]},t.id))})]})}):null]}):null};export{te as default};
