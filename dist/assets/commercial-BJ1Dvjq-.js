import{s as u}from"./index-HcuLVkXM.js";async function f(i){const{clinicId:n,from:o,to:t}=i;let e=u.from("revenues").select("*").order("data_competencia",{ascending:!0});n&&(e=e.eq("clinic_id",n)),o&&(e=e.gte("data_competencia",o)),t&&(e=e.lte("data_competencia",t));const{data:c}=await e,{data:a}=await u.from("revenue_procedures").select("*"),r=n?(a||[]).filter(m=>m.clinic_id===n):a||[],{data:d}=await u.from("customers").select("*"),s=n?(d||[]).filter(m=>m.clinic_id===n):d||[];return{revenues:c||[],revenueProcedures:r,customers:s}}async function p(i){const{clinicId:n,from:o,to:t}=i;if(!n)return{revenues:[],customers:[]};let e=u.from("revenues").select("paciente, valor, valor_liquido, data_competencia").order("data_competencia",{ascending:!0});e=e.eq("clinic_id",n),o&&(e=e.gte("data_competencia",o)),t&&(e=e.lte("data_competencia",t));const{data:c}=await e;let a=u.from("customers").select("id, name, cep, lat, lng").order("name",{ascending:!0});a=a.eq("clinic_id",n),a=a.not("cep","is",null).neq("cep","");const{data:r}=await a;return{revenues:c||[],customers:r||[]}}async function _(i,n){i.length&&await u.from("customers").update({lat:n.lat,lng:n.lng}).in("id",i)}function g(i){const n={};return i.revenues.forEach(o=>{const t=(o.paciente||"Sem nome").trim()||"Sem nome";n[t]||(n[t]={faturamento:0,atendimentos:0,procedimentos:new Set,categorias:new Set,procedimentosCount:0,datas:new Set});const e=n[t],c=Number(o.valor_liquido??o.valor??0);e.faturamento+=isFinite(c)?c:0,e.atendimentos+=1,o.data_competencia&&e.datas.add(o.data_competencia),i.revenueProcedures.filter(r=>r.revenue_id===o.id).forEach(r=>{r.procedimento&&e.procedimentos.add(r.procedimento),r.categoria&&e.categorias.add(r.categoria),e.procedimentosCount+=r.quantidade||0})}),Object.entries(n).map(([o,t])=>{const e=t.atendimentos?t.faturamento/t.atendimentos:0,c=t.datas.size;return{name:o,faturamento:t.faturamento,atendimentos:t.atendimentos,ticket:e,recorrencia:c,procedimentosCount:t.procedimentosCount,procedimentos:Array.from(t.procedimentos),categorias:Array.from(t.categorias)}})}function v(i,n,o){const t={};i.revenues.forEach(s=>{if(!s.data_competencia||n&&s.data_competencia<n||o&&s.data_competencia>o)return;const m=(s.paciente||"Sem nome").trim()||"Sem nome";t[m]||(t[m]=new Set),t[m].add(s.data_competencia)});const e=Object.entries(t).map(([s,m])=>({name:s,atendimentos:m.size,dates:Array.from(m).sort(),status:m.size>1?"Recorrente":"NÃ£o recorrente"})),c=e.length,a=e.filter(s=>s.atendimentos>1).length,r=c-a,d=c?a/c*100:0;return{rows:e,total:c,recorrentes:a,naoRecorrentes:r,percentual:d}}export{v as a,g as b,p as c,f,_ as u};
