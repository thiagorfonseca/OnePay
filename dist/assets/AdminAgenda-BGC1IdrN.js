import{c as we,j as t,u as Se,r as i,s as Ne,C as Ce}from"./index-HcuLVkXM.js";import{u as ke,T as Ee,F as Re,i as ze,a as Ae,b as De,E as Ie,l as Me,c as H,d as Oe,s as Pe,e as Te,f as Le}from"./service-DqpVUrBa.js";import{u as ee}from"./useModalControls-BiWM_r1l.js";import{M as Fe}from"./map-pin-D37Fua2K.js";import{L as Ge}from"./link-DvuaMiAh.js";import{S as Ve}from"./sparkles-TbjI2Gb8.js";import{P as Be}from"./plus-DDz1DOCh.js";import"./x-Dm__mln4.js";const $e=we("CalendarClock",[["path",{d:"M21 7.5V6a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h3.5",key:"1osxxc"}],["path",{d:"M16 2v4",key:"4m81vk"}],["path",{d:"M8 2v4",key:"1cmpym"}],["path",{d:"M3 10h5",key:"r794hk"}],["path",{d:"M17.5 17.5 16 16.25V14",key:"re2vv1"}],["path",{d:"M22 16a6 6 0 1 1-12 0 6 6 0 0 1 12 0Z",key:"ame013"}]]),He=({open:l,mode:g,form:o,clinics:k,selectedClinics:d,suggestions:E,saving:R,suggesting:_,onChange:c,onToggleClinic:M,onSave:O,onSuggest:P,onClose:f})=>{const T=ee({isOpen:l,onClose:f});return l?t.jsx("div",{className:"fixed inset-0 bg-black/40 z-50 flex items-start justify-center overflow-y-auto py-8",onClick:T.onBackdropClick,children:t.jsxs("div",{className:"bg-white w-full max-w-3xl rounded-2xl p-6 shadow-xl space-y-5",onClick:n=>n.stopPropagation(),children:[t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsxs("div",{children:[t.jsx("h3",{className:"text-lg font-semibold text-gray-800",children:g==="create"?"Criar agendamento":"Editar agendamento"}),t.jsx("p",{className:"text-sm text-gray-500",children:"Defina os detalhes do encontro e as clínicas participantes."})]}),t.jsx("button",{type:"button",onClick:f,className:"w-9 h-9 rounded-full bg-gray-100 text-gray-500 flex items-center justify-center",children:"✕"})]}),t.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[t.jsxs("div",{className:"md:col-span-2",children:[t.jsx("label",{className:"text-sm font-medium text-gray-700",children:"Título *"}),t.jsx("input",{value:o.title,onChange:n=>c({title:n.target.value}),className:"mt-1 w-full px-3 py-2 border border-gray-200 rounded-lg",placeholder:"Ex: Reunião mensal de alinhamento"})]}),t.jsxs("div",{children:[t.jsx("label",{className:"text-sm font-medium text-gray-700",children:"Início *"}),t.jsx("input",{type:"datetime-local",value:o.start,onChange:n=>c({start:n.target.value}),className:"mt-1 w-full px-3 py-2 border border-gray-200 rounded-lg"})]}),t.jsxs("div",{children:[t.jsx("label",{className:"text-sm font-medium text-gray-700",children:"Fim *"}),t.jsx("input",{type:"datetime-local",value:o.end,onChange:n=>c({end:n.target.value}),className:"mt-1 w-full px-3 py-2 border border-gray-200 rounded-lg"})]}),t.jsxs("div",{children:[t.jsx("label",{className:"text-sm font-medium text-gray-700",children:"Fuso horário"}),t.jsx("input",{value:o.timezone,onChange:n=>c({timezone:n.target.value}),className:"mt-1 w-full px-3 py-2 border border-gray-200 rounded-lg"})]}),t.jsxs("div",{children:[t.jsxs("label",{className:"text-sm font-medium text-gray-700 flex items-center gap-2",children:[t.jsx(Fe,{size:14})," Local"]}),t.jsx("input",{value:o.location,onChange:n=>c({location:n.target.value}),className:"mt-1 w-full px-3 py-2 border border-gray-200 rounded-lg",placeholder:"Sala, endereço ou remoto"})]}),t.jsxs("div",{className:"md:col-span-2",children:[t.jsxs("label",{className:"text-sm font-medium text-gray-700 flex items-center gap-2",children:[t.jsx(Ge,{size:14})," Link do evento"]}),t.jsx("input",{value:o.meeting_url,onChange:n=>c({meeting_url:n.target.value}),className:"mt-1 w-full px-3 py-2 border border-gray-200 rounded-lg",placeholder:"https://meet.google.com/..."})]}),t.jsxs("div",{className:"md:col-span-2",children:[t.jsx("label",{className:"text-sm font-medium text-gray-700",children:"Descrição"}),t.jsx("textarea",{value:o.description,onChange:n=>c({description:n.target.value}),className:"mt-1 w-full px-3 py-2 border border-gray-200 rounded-lg min-h-[90px]",placeholder:"Agenda, pauta, objetivos..."})]})]}),t.jsxs("div",{className:"rounded-xl border border-gray-100 p-4 space-y-3",children:[t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsxs("div",{children:[t.jsx("p",{className:"text-sm font-semibold text-gray-800",children:"Clínicas participantes"}),t.jsx("p",{className:"text-xs text-gray-500",children:"Selecione uma ou mais clínicas para o evento."})]}),t.jsxs("span",{className:"text-xs text-gray-400",children:[d.length," selecionadas"]})]}),t.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-2 max-h-40 overflow-auto",children:[k.map(n=>t.jsxs("label",{className:"flex items-center gap-2 text-sm text-gray-600",children:[t.jsx("input",{type:"checkbox",checked:d.includes(n.id),onChange:()=>M(n.id)}),t.jsx("span",{children:n.name})]},n.id)),k.length===0&&t.jsx("p",{className:"text-xs text-gray-400",children:"Nenhuma clínica disponível."})]})]}),t.jsxs("div",{className:"rounded-xl border border-dashed border-blue-200 bg-blue-50/40 p-4 space-y-3",children:[t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsxs("div",{className:"flex items-center gap-2 text-sm font-semibold text-blue-700",children:[t.jsx($e,{size:16})," Sugestões inteligentes"]}),t.jsxs("button",{type:"button",onClick:P,className:"inline-flex items-center gap-2 px-3 py-2 text-xs rounded-lg border border-blue-200 text-blue-700 bg-white hover:bg-blue-50",disabled:_,children:[t.jsx(Ve,{size:14})," ",_?"Buscando...":"Sugerir horários"]})]}),t.jsxs("div",{className:"flex flex-wrap gap-2",children:[E.length===0&&t.jsx("p",{className:"text-xs text-gray-500",children:"Clique em “Sugerir horários” para ver opções livres."}),E.map(n=>t.jsx("button",{type:"button",onClick:()=>c({start:n.start.slice(0,16),end:n.end.slice(0,16)}),className:"px-3 py-1 rounded-full text-xs bg-white border border-blue-200 text-blue-700 hover:bg-blue-50",children:new Date(n.start).toLocaleString("pt-BR",{dateStyle:"short",timeStyle:"short"})},n.start))]})]}),t.jsxs("div",{className:"flex items-center justify-end gap-3",children:[t.jsx("button",{type:"button",onClick:f,className:"px-4 py-2 rounded-lg border border-gray-200 text-gray-600",children:"Cancelar"}),t.jsx("button",{type:"button",onClick:O,disabled:R,className:"px-5 py-2 rounded-lg bg-brand-600 text-white font-medium disabled:opacity-50",children:R?"Salvando...":"Salvar"})]})]})}):null},Y={title:"",description:"",start:"",end:"",timezone:"America/Sao_Paulo",location:"",meeting_url:""},y=l=>{const g=l instanceof Date?l:new Date(l),o=g.getTimezoneOffset()*6e4;return new Date(g.getTime()-o).toISOString().slice(0,16)},C=l=>l?new Date(l).toLocaleString("pt-BR",{dateStyle:"short",timeStyle:"short"}):"—",Ye=()=>{const{user:l,isSystemAdmin:g}=Se(),o=i.useRef(null),{toasts:k,push:d,dismiss:E}=ke(),[R,_]=i.useState(!0),[c,M]=i.useState([]),[O,P]=i.useState([]),[f,T]=i.useState("timeGridWeek"),[n,te]=i.useState(null),[se,j]=i.useState(!1),[L,F]=i.useState("create"),[u,z]=i.useState(Y),[v,w]=i.useState([]),[ae,q]=i.useState(!1),[ne,G]=i.useState([]),[re,J]=i.useState(!1),[ie,A]=i.useState(!1),[m,W]=i.useState(null),[de,Z]=i.useState([]),[S,le]=i.useState([]),[K,N]=i.useState(!1),[V,Q]=i.useState(!1),U=i.useRef(0),[B,D]=i.useState(null),h=Ne,oe=ee({isOpen:K,onClose:()=>N(!1)});i.useEffect(()=>{if(!g)return;(async()=>{const{data:s}=await h.from("clinics").select("id, name").order("name",{ascending:!0});P((s||[]).map(a=>({id:a.id,name:a.name})))})()},[g]);const b=async(e,s)=>{if(l?.id){_(!0);try{const a=await Me({consultantId:l.id,rangeStart:e,rangeEnd:s});M(a)}catch(a){d({title:"Erro ao carregar agenda",description:a?.message,variant:"error"})}finally{_(!1)}}};i.useEffect(()=>{n&&b(n.start,n.end)},[n?.start?.toISOString(),n?.end?.toISOString()]);const I=i.useCallback(async()=>{if(!g)return;Q(!0);const{data:e,error:s}=await h.from("schedule_change_requests").select("id, event_id, reason, suggested_start_at, suggested_end_at, status, created_at, clinic_id, schedule_events (id, title, start_at, end_at, location, meeting_url, description, timezone), clinics (id, name)").eq("status","open").order("created_at",{ascending:!1});if(!s){const a=e||[];le(a),a.length>0&&a.length!==U.current&&N(!0),U.current=a.length}Q(!1)},[g]);i.useEffect(()=>{if(!g)return;let e=!0;const s=async()=>{e&&await I()};s();const a=window.setInterval(s,6e4);return()=>{e=!1,window.clearInterval(a)}},[g,I]);const ce=i.useMemo(()=>c.map(e=>({id:e.id,title:e.title,start:e.start_at,end:e.end_at,backgroundColor:e.status==="cancelled"?"#e5e7eb":e.status==="reschedule_requested"?"#fef3c7":e.status==="confirmed"?"#d1fae5":"#dbeafe",borderColor:e.status==="cancelled"?"#e5e7eb":"#93c5fd",textColor:"#111827"})),[c]),X=(e,s)=>{F("create"),z({...Y,start:e?y(e):"",end:s?y(s):""}),w([]),G([]),D(null),j(!0)},ue=e=>{F("edit"),z({title:e.title,description:e.description||"",start:y(e.start_at),end:y(e.end_at),timezone:e.timezone||"America/Sao_Paulo",location:e.location||"",meeting_url:e.meeting_url||""}),w(e.attendees.map(s=>s.clinic_id)),G([]),D(null),j(!0)},me=async()=>{if(l?.id){if(!u.title.trim()||!u.start||!u.end){d({title:"Preencha título, início e fim.",variant:"error"});return}if(v.length===0){d({title:"Selecione ao menos uma clínica.",variant:"error"});return}q(!0);try{const e={consultant_id:l.id,title:u.title.trim(),description:u.description.trim()||null,start_at:new Date(u.start).toISOString(),end_at:new Date(u.end).toISOString(),timezone:u.timezone||"America/Sao_Paulo",location:u.location.trim()||null,meeting_url:u.meeting_url.trim()||null,status:L==="create"?"pending_confirmation":m?.status||"pending_confirmation",recurrence_rule:null};if(L==="create")await Te({event:e,clinicIds:v}),d({title:"Agendamento criado.",variant:"success"});else if(m){const s=e.start_at!==m.start_at||e.end_at!==m.end_at,a=m.status==="reschedule_requested"&&s?"rescheduled":m.status;if(await H({eventId:m.id,updates:{title:e.title,description:e.description,start_at:e.start_at,end_at:e.end_at,timezone:e.timezone,location:e.location,meeting_url:e.meeting_url,status:a},clinicIds:v,forceStatus:a}),B&&v.length){await h.from("schedule_change_requests").update({status:"accepted",handled_by:l.id,handled_at:new Date().toISOString()}).eq("id",B.id);const r=v.map(x=>({target:"clinic",clinic_id:x,type:"event_rescheduled",payload:{event_id:m.id,clinic_id:x,start_at:e.start_at,end_at:e.end_at,reason:B.reason}}));await h.from("notifications").insert(r),D(null),await I()}d({title:"Agendamento atualizado.",variant:"success"})}j(!1),n&&await b(n.start,n.end)}catch(e){const s=e?.code==="23P01"||typeof e?.message=="string"&&e.message.includes("schedule_events_no_overlap");d({title:s?"Conflito de horário.":"Erro ao salvar agendamento.",description:s?"Já existe outro agendamento neste horário.":e?.message,variant:"error"})}finally{q(!1)}}},ge=async()=>{if(!l?.id)return;if(!u.start||!u.end){d({title:"Defina início e fim para sugerir horários.",variant:"info"});return}const e=new Date(u.start),s=new Date(u.end),a=Math.max(15,Math.round((s.getTime()-e.getTime())/6e4));J(!0);try{const r=await Pe({consultantId:l.id,durationMinutes:a,dateRangeStart:e,dateRangeEnd:new Date(e.getTime()+12096e5),workingHours:{days:[1,2,3,4,5],start:"09:00",end:"18:00"},bufferMinutes:15});G(r)}catch(r){d({title:"Não foi possível sugerir horários.",description:r?.message,variant:"error"})}finally{J(!1)}},xe=async e=>{const s=c.find(a=>a.id===e.event.id);if(s){W(s),A(!0);try{const a=await Oe(s.id);Z(a)}catch{Z([])}}},he=async()=>{if(m&&confirm("Cancelar este agendamento?"))try{await Le(m.id,m.attendees.map(e=>e.clinic_id)),d({title:"Agendamento cancelado.",variant:"success"}),A(!1),n&&await b(n.start,n.end)}catch(e){d({title:"Erro ao cancelar agendamento.",description:e?.message,variant:"error"})}},pe=e=>{te({start:e.start,end:e.end})},fe=e=>{X(e.start,e.end)},ye=async e=>{const s=c.find(a=>a.id===e.event.id);if(!s||!e.event.start||!e.event.end){e.revert();return}try{const a=e.event.start.toISOString(),r=e.event.end.toISOString(),x=a!==s.start_at||r!==s.end_at,p=s.status==="reschedule_requested"&&x?"rescheduled":s.status;await H({eventId:s.id,updates:{start_at:a,end_at:r},forceStatus:p}),d({title:"Horário atualizado.",variant:"success"}),n&&await b(n.start,n.end)}catch(a){e.revert();const r=a?.code==="23P01"||typeof a?.message=="string"&&a.message.includes("schedule_events_no_overlap");d({title:r?"Conflito de horário.":"Não foi possível mover o agendamento.",description:r?"Já existe outro agendamento neste horário.":a?.message,variant:"error"})}},ve=async e=>{const s=c.find(a=>a.id===e.event.id);if(!s||!e.event.start||!e.event.end){e.revert();return}try{const a=e.event.start.toISOString(),r=e.event.end.toISOString(),x=a!==s.start_at||r!==s.end_at,p=s.status==="reschedule_requested"&&x?"rescheduled":s.status;await H({eventId:s.id,updates:{start_at:a,end_at:r},forceStatus:p}),d({title:"Duração atualizada.",variant:"success"}),n&&await b(n.start,n.end)}catch(a){e.revert();const r=a?.code==="23P01"||typeof a?.message=="string"&&a.message.includes("schedule_events_no_overlap");d({title:r?"Conflito de horário.":"Não foi possível redimensionar.",description:r?"Já existe outro agendamento neste horário.":a?.message,variant:"error"})}},$=e=>{T(e),o.current?.getApi()?.changeView(e)},be=async e=>{const s=c.find(p=>p.id===e.event_id),a=e.schedule_events?{...e.schedule_events,attendees:[]}:null,r=s||a;if(!r){d({title:"Evento não encontrado para reagendar.",variant:"error"});return}const x=s?.attendees?.map(p=>p.clinic_id)||[];if(x.length)w(x);else{const{data:p}=await h.from("schedule_event_attendees").select("clinic_id").eq("event_id",r.id);w((p||[]).map(je=>je.clinic_id))}W(r),F("edit"),z({title:r.title,description:r.description||"",start:e.suggested_start_at?y(e.suggested_start_at):y(r.start_at),end:e.suggested_end_at?y(e.suggested_end_at):y(r.end_at),timezone:r.timezone||"America/Sao_Paulo",location:r.location||"",meeting_url:r.meeting_url||""}),D(e),N(!1),j(!0)},_e=async e=>{if(l?.id)try{await h.from("schedule_change_requests").update({status:"rejected",handled_by:l.id,handled_at:new Date().toISOString()}).eq("id",e.id);const{data:s}=await h.from("schedule_change_requests").select("id").eq("event_id",e.event_id).eq("status","open").limit(1);if(!s?.length){const{data:a}=await h.from("schedule_event_attendees").select("confirm_status").eq("event_id",e.event_id),r=(a||[]).some(x=>x.confirm_status!=="confirmed");await h.from("schedule_events").update({status:r?"pending_confirmation":"confirmed"}).eq("id",e.event_id).neq("status","cancelled")}await h.from("notifications").insert([{target:"clinic",clinic_id:e.clinic_id,type:"reschedule_rejected",payload:{event_id:e.event_id,clinic_id:e.clinic_id,reason:e.reason}}]),d({title:"Solicitação marcada como não reagendada.",variant:"success"}),await I(),n&&await b(n.start,n.end)}catch(s){d({title:"Não foi possível atualizar a solicitação.",description:s?.message,variant:"error"})}};return g?t.jsxs("div",{className:"space-y-6",children:[t.jsx(Ee,{items:k,onDismiss:E}),t.jsxs("div",{className:"flex flex-wrap items-center justify-between gap-3",children:[t.jsxs("div",{children:[t.jsx("h1",{className:"text-2xl font-bold text-gray-800",children:"Agendamento Inteligente"}),t.jsx("p",{className:"text-sm text-gray-500",children:"Admin • Agenda do consultor"})]}),t.jsxs("div",{className:"flex flex-wrap gap-2 items-center",children:[S.length>0&&t.jsxs("button",{type:"button",onClick:()=>N(!0),className:"px-3 py-2 text-sm rounded-lg bg-amber-600 text-white flex items-center gap-2 shadow-sm hover:bg-amber-700",children:["Solicitações (",S.length,")"]}),t.jsx("button",{type:"button",onClick:()=>o.current?.getApi().today(),className:"px-3 py-2 text-sm border border-gray-200 rounded-lg",children:"Hoje"}),t.jsx("button",{type:"button",onClick:()=>o.current?.getApi().prev(),className:"px-3 py-2 text-sm border border-gray-200 rounded-lg",children:"◀"}),t.jsx("button",{type:"button",onClick:()=>o.current?.getApi().next(),className:"px-3 py-2 text-sm border border-gray-200 rounded-lg",children:"▶"}),t.jsx("button",{type:"button",onClick:()=>$("timeGridDay"),className:`px-3 py-2 text-sm border rounded-lg ${f==="timeGridDay"?"bg-brand-600 text-white border-brand-600":"bg-white text-gray-700 border-gray-200"}`,children:"Dia"}),t.jsx("button",{type:"button",onClick:()=>$("timeGridWeek"),className:`px-3 py-2 text-sm border rounded-lg ${f==="timeGridWeek"?"bg-brand-600 text-white border-brand-600":"bg-white text-gray-700 border-gray-200"}`,children:"Semana"}),t.jsx("button",{type:"button",onClick:()=>$("dayGridMonth"),className:`px-3 py-2 text-sm border rounded-lg ${f==="dayGridMonth"?"bg-brand-600 text-white border-brand-600":"bg-white text-gray-700 border-gray-200"}`,children:"Mês"}),t.jsxs("button",{type:"button",onClick:()=>X(),className:"px-4 py-2 rounded-lg bg-brand-600 text-white flex items-center gap-2",children:[t.jsx(Be,{size:16})," Criar agendamento"]})]})]}),t.jsxs("div",{className:"bg-white border border-gray-100 rounded-2xl p-4 shadow-sm",children:[t.jsxs("div",{className:"flex items-center gap-2 text-sm text-gray-500 mb-2",children:[t.jsx(Ce,{size:16})," ",R?"Carregando agenda...":"Agenda do consultor"]}),t.jsx(Re,{ref:o,plugins:[ze,Ae,De],initialView:f,height:"auto",selectable:!0,editable:!0,eventResizableFromStart:!0,events:ce,select:fe,eventClick:xe,eventDrop:ye,eventResize:ve,datesSet:pe,headerToolbar:!1,dayMaxEventRows:!0,nowIndicator:!0})]}),t.jsx(He,{open:se,mode:L,form:u,clinics:O,selectedClinics:v,suggestions:ne,saving:ae,suggesting:re,onChange:e=>z(s=>({...s,...e})),onToggleClinic:e=>w(s=>s.includes(e)?s.filter(a=>a!==e):[...s,e]),onSave:me,onSuggest:ge,onClose:()=>j(!1)}),t.jsx(Ie,{open:ie,onClose:()=>A(!1),event:m,attendees:m?.attendees||[],changeRequests:de,onEdit:()=>{m&&(ue(m),A(!1))},onCancel:he}),K&&t.jsx("div",{className:"fixed inset-0 bg-black/40 z-50 flex items-start justify-center overflow-y-auto py-8",onClick:oe.onBackdropClick,children:t.jsxs("div",{className:"bg-white w-full max-w-3xl rounded-2xl p-6 shadow-xl space-y-4",onClick:e=>e.stopPropagation(),children:[t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsxs("div",{children:[t.jsx("h3",{className:"text-lg font-semibold text-gray-800",children:"Solicitações de reagendamento"}),t.jsx("p",{className:"text-sm text-gray-500",children:"Acompanhe os pedidos das clínicas."})]}),t.jsx("button",{type:"button",onClick:()=>N(!1),className:"w-9 h-9 rounded-full bg-gray-100 text-gray-500 flex items-center justify-center",children:"✕"})]}),V&&t.jsx("p",{className:"text-sm text-gray-500",children:"Carregando solicitações..."}),!V&&S.length===0&&t.jsx("p",{className:"text-sm text-gray-500",children:"Nenhuma solicitação aberta."}),!V&&S.length>0&&t.jsx("div",{className:"space-y-3",children:S.map(e=>t.jsxs("div",{className:"border border-gray-100 rounded-xl p-4 text-sm text-gray-600",children:[t.jsxs("div",{className:"flex flex-wrap items-center justify-between gap-2",children:[t.jsxs("div",{className:"font-semibold text-gray-800",children:["Clínica: ",e.clinics?.name||e.clinic_id]}),t.jsx("div",{className:"text-xs text-gray-400",children:C(e.created_at)})]}),t.jsxs("div",{className:"mt-2 grid grid-cols-1 md:grid-cols-2 gap-2 text-xs text-gray-500",children:[t.jsxs("div",{children:["Início sugerido: ",C(e.suggested_start_at)]}),t.jsxs("div",{children:["Fim sugerido: ",C(e.suggested_end_at)]})]}),t.jsx("div",{className:"mt-2 text-sm text-gray-700",children:e.reason}),e.schedule_events&&t.jsxs("div",{className:"mt-2 text-xs text-gray-500",children:["Evento: ",e.schedule_events.title," • ",C(e.schedule_events.start_at)," → ",C(e.schedule_events.end_at)]}),t.jsxs("div",{className:"mt-3 flex flex-wrap gap-2",children:[t.jsx("button",{type:"button",onClick:()=>be(e),className:"px-3 py-2 text-xs rounded-lg bg-brand-600 text-white hover:bg-brand-700",children:"Reagendar"}),t.jsx("button",{type:"button",onClick:()=>_e(e),className:"px-3 py-2 text-xs rounded-lg border border-gray-200 text-gray-600 hover:bg-gray-50",children:"Não reagendado"})]})]},e.id))})]})})]}):t.jsx("div",{className:"text-sm text-gray-500",children:"Acesso restrito aos consultores One Doctor."})};export{Ye as default};
