import{c as k,u as C,r as t,k as I,j as e,s as N,l as D}from"./index-HcuLVkXM.js";import{S as M}from"./sparkles-TbjI2Gb8.js";const O=k("Send",[["path",{d:"m22 2-7 20-4-9-9-4Z",key:"1q3vgg"}],["path",{d:"M22 2 11 13",key:"nzbqef"}]]),q=()=>{const{user:n,effectiveClinicId:r}=C(),[x,m]=t.useState([]),[g,h]=t.useState(""),[y,p]=t.useState(!1),[o,b]=t.useState(!1),[v,l]=t.useState(null),d=t.useRef(null),u=t.useMemo(()=>!!n?.id&&!!r,[n?.id,r]),E=t.useMemo(()=>`${I.replace(/\/+$/,"")}/functions/v1/clinic-assistant`,[]),j=async()=>{if(!n?.id||!r)return;p(!0);const{data:s,error:a}=await N.from("ai_chat_messages").select("id, role, content, created_at").eq("clinic_id",r).eq("user_id",n.id).order("created_at",{ascending:!0}).limit(200);if(a){l(a.message),p(!1);return}m(s||[]),p(!1)};t.useEffect(()=>{j()},[n?.id,r]),t.useEffect(()=>{d.current&&(d.current.scrollTop=d.current.scrollHeight)},[x,o]);const _=async s=>{const a=s.trim();if(a){if(!u){l("Selecione uma clínica válida para usar o assistente.");return}l(null),h(""),m(i=>[...i,{role:"user",content:a,created_at:new Date().toISOString()}]),b(!0);try{const{data:i}=await N.auth.getSession(),S=i.session?.access_token;if(!S)throw new Error("Sessão expirada. Faça login novamente.");const w=await fetch(E,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${S}`,apikey:D},body:JSON.stringify({message:a,clinic_id:r})}),f=await w.text();let c=null;if(f)try{c=JSON.parse(f)}catch{c=null}if(!w.ok)throw new Error(c?.error||c?.message||f||"Erro ao consultar assistente.");m(A=>[...A,{role:"assistant",content:c.answer,created_at:new Date().toISOString()}]),await j()}catch(i){l(i.message||"Erro ao enviar mensagem.")}finally{b(!1)}}};return e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-800",children:"Assistente IA da Clínica"}),e.jsx("p",{className:"text-gray-500",children:"Pergunte sobre recebíveis, despesas e projeções financeiras."})]}),e.jsxs("div",{className:"bg-white border border-gray-100 rounded-xl shadow-sm p-4 space-y-3",children:[!u&&e.jsx("div",{className:"text-sm text-gray-500",children:"Selecione uma clínica ativa para usar o assistente."}),v&&e.jsx("div",{className:"text-sm text-red-600",children:v})]}),e.jsxs("div",{className:"bg-white border border-gray-100 rounded-xl shadow-sm p-4 flex flex-col h-[520px]",children:[e.jsxs("div",{ref:d,className:"flex-1 overflow-y-auto space-y-3 pr-2",children:[y&&e.jsx("div",{className:"text-sm text-gray-400",children:"Carregando histórico..."}),!y&&x.length===0&&e.jsx("div",{className:"text-sm text-gray-400",children:"Comece uma conversa para ver respostas financeiras."}),x.map((s,a)=>e.jsx("div",{className:`flex ${s.role==="user"?"justify-end":"justify-start"}`,children:e.jsx("div",{className:`max-w-[75%] whitespace-pre-line rounded-2xl px-4 py-3 text-sm ${s.role==="user"?"bg-brand-600 text-white":"bg-gray-100 text-gray-700"}`,children:s.content})},s.id||a)),o&&e.jsx("div",{className:"flex justify-start",children:e.jsxs("div",{className:"flex items-center gap-2 bg-gray-100 text-gray-600 rounded-2xl px-4 py-3 text-sm",children:[e.jsx(M,{size:16,className:"animate-pulse"})," Digitando..."]})})]}),e.jsxs("form",{onSubmit:s=>{s.preventDefault(),_(g)},className:"mt-4 flex items-center gap-2",children:[e.jsx("input",{value:g,onChange:s=>h(s.target.value),placeholder:"Digite sua pergunta financeira...",className:"flex-1 px-4 py-3 border border-gray-200 rounded-lg text-sm focus:ring-brand-500 focus:border-brand-500",disabled:!u||o}),e.jsxs("button",{type:"submit",disabled:!u||o,className:"px-4 py-3 bg-brand-600 text-white rounded-lg hover:bg-brand-700 disabled:opacity-50 flex items-center gap-2",children:[e.jsx(O,{size:16})," Enviar"]})]})]})]})};export{q as default};
