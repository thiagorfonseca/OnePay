import{u as B,r as t,j as e,s as d}from"./index-V1BrPv90.js";const z="user-avatars",h=350,G=s=>s.normalize("NFKD").replace(/[\u0300-\u036f]/g,"").replace(/[^a-zA-Z0-9._-]+/g,"-").replace(/-+/g,"-").replace(/^-+|-+$/g,"")||`file-${crypto.randomUUID()}`,Q=s=>new Promise((r,o)=>{const n=new Image,i=URL.createObjectURL(s);n.onload=()=>{URL.revokeObjectURL(i),r({width:n.width,height:n.height})},n.onerror=()=>{URL.revokeObjectURL(i),o(new Error("Imagem inválida."))},n.src=i}),X=async s=>{if(!s.type.startsWith("image/"))return"Envie um arquivo de imagem.";try{const{width:r,height:o}=await Q(s);return r!==o?"A imagem precisa ser quadrada.":r>h||o>h?`A imagem deve ter no máximo ${h} x ${h}px.`:null}catch{return"Não foi possível ler a imagem."}},Z=async(s,r)=>{const o=G(r.name),n=`users/${s}/${crypto.randomUUID()}-${o}`,{error:i}=await d.storage.from(z).upload(n,r,{upsert:!0});if(i)throw i;const{data:m}=d.storage.from(z).getPublicUrl(n);return m.publicUrl},J=()=>{const{user:s,profile:r,clinicUser:o,refresh:n}=B(),[i,m]=t.useState(r?.full_name||""),[w,p]=t.useState(!1),[S,c]=t.useState(null),[b,v]=t.useState(null),[g,y]=t.useState(null),[x,A]=t.useState(null),[f,_]=t.useState(""),[U,E]=t.useState(""),[P,C]=t.useState(!1),[R,u]=t.useState(null),[O,F]=t.useState(null),[I,L]=t.useState(""),[M,k]=t.useState(!1),[D,N]=t.useState(null);t.useEffect(()=>{m(r?.full_name||"")},[r?.full_name]),t.useEffect(()=>()=>{g?.startsWith("blob:")&&URL.revokeObjectURL(g)},[g]),t.useEffect(()=>{(async()=>{if(!s?.id)return;const{data:l}=await d.from("user_notes").select("id, content").eq("user_id",s.id).order("updated_at",{ascending:!1}).limit(1).maybeSingle();l&&(F(l.id),L(l.content||""))})()},[s?.id]);const T=async a=>{const l=await X(a);if(l){A(l),v(null),y(null);return}A(null),v(a),y(URL.createObjectURL(a))},q=async a=>{if(a.preventDefault(),!s)return;if(!i.trim()){c("Informe seu nome.");return}if(x&&b){c(x);return}p(!0),c(null);let l=r?.avatar_url??o?.avatar_url??null;if(b)try{l=await Z(s.id,b)}catch(W){c(`Erro ao enviar imagem: ${W.message}`),p(!1);return}const{error:$}=await d.from("profiles").upsert({id:s.id,full_name:i.trim(),clinic_id:r?.clinic_id??null,role:r?.role??null,avatar_url:l});$?c("Erro ao salvar perfil: "+$.message):(c("Perfil atualizado com sucesso."),v(null),y(null),await n()),p(!1)},K=async a=>{if(a.preventDefault(),u(null),f.length<6){u("A senha precisa ter pelo menos 6 caracteres.");return}if(f!==U){u("As senhas não conferem.");return}C(!0);const{error:l}=await d.auth.updateUser({password:f});l?u("Erro ao atualizar senha: "+l.message):(u("Senha atualizada com sucesso."),_(""),E("")),C(!1)},V=async()=>{if(!s?.id)return;k(!0),N(null);const{error:a}=await d.from("user_notes").upsert({id:O||void 0,user_id:s.id,content:I},{onConflict:"user_id"});N(a?"Erro ao salvar anotação: "+a.message:"Anotação salva."),k(!1)},j=g||r?.avatar_url||o?.avatar_url||"";return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-800",children:"Meu perfil"}),e.jsx("p",{className:"text-gray-500",children:"Gerencie seus dados pessoais, senha e anotações."})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-4",children:[e.jsxs("form",{onSubmit:q,className:"bg-white border border-gray-100 rounded-xl p-6 space-y-4",children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-800",children:"Dados pessoais"}),e.jsxs("div",{className:"flex flex-wrap items-center gap-4",children:[e.jsx("div",{className:"h-20 w-20 rounded-xl border border-gray-200 bg-gray-50 flex items-center justify-center overflow-hidden text-[10px] text-gray-400",children:j?e.jsx("img",{src:j,alt:"Imagem do perfil",className:"h-full w-full object-cover"}):e.jsx("span",{children:"Sem imagem"})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700",children:"Imagem do perfil"}),e.jsxs("label",{className:"inline-flex px-3 py-2 text-sm bg-white border border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50",children:[j?"Trocar imagem":"Adicionar imagem",e.jsx("input",{type:"file",accept:"image/*",className:"hidden",onChange:async a=>{const l=a.target.files?.[0];l&&await T(l),a.currentTarget.value=""}})]}),e.jsx("p",{className:"text-xs text-gray-500",children:"Quadrada até 350 x 350."}),x&&e.jsx("p",{className:"text-xs text-red-600",children:x})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700",children:"Nome"}),e.jsx("input",{value:i,onChange:a=>m(a.target.value),className:"mt-1 w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-brand-500 outline-none"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700",children:"Email"}),e.jsx("input",{value:s?.email||"",readOnly:!0,className:"mt-1 w-full px-3 py-2 border border-gray-200 rounded-lg bg-gray-50 text-gray-500"})]}),S&&e.jsx("p",{className:"text-sm text-gray-500",children:S}),e.jsx("button",{type:"submit",disabled:w,className:"px-4 py-2 bg-brand-600 text-white rounded-lg hover:bg-brand-700 disabled:opacity-50",children:w?"Salvando...":"Salvar alterações"})]}),e.jsxs("form",{onSubmit:K,className:"bg-white border border-gray-100 rounded-xl p-6 space-y-4",children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-800",children:"Alterar senha"}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700",children:"Nova senha"}),e.jsx("input",{type:"password",value:f,onChange:a=>_(a.target.value),className:"mt-1 w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-brand-500 outline-none"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700",children:"Confirmar senha"}),e.jsx("input",{type:"password",value:U,onChange:a=>E(a.target.value),className:"mt-1 w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-brand-500 outline-none"})]}),R&&e.jsx("p",{className:"text-sm text-gray-500",children:R}),e.jsx("button",{type:"submit",disabled:P,className:"px-4 py-2 bg-brand-600 text-white rounded-lg hover:bg-brand-700 disabled:opacity-50",children:P?"Atualizando...":"Atualizar senha"})]})]}),e.jsxs("div",{className:"bg-white border border-gray-100 rounded-xl p-6 space-y-3",children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-800",children:"Minhas anotações"}),e.jsx("textarea",{value:I,onChange:a=>L(a.target.value),rows:6,className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-brand-500 outline-none",placeholder:"Escreva suas anotações aqui..."}),D&&e.jsx("p",{className:"text-sm text-gray-500",children:D}),e.jsx("button",{type:"button",onClick:V,disabled:M,className:"px-4 py-2 bg-brand-600 text-white rounded-lg hover:bg-brand-700 disabled:opacity-50",children:M?"Salvando...":"Salvar anotações"})]})]})};export{J as default};
